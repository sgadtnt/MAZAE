<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>غرفة الدردشة العامة مع عداد المتصلين</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- عداد المتصلين -->
  <div id="presenceCount" class="max-w-xl mx-auto p-2 text-center text-sm text-gray-600">
    عدد المتصلين: 0
  </div>

  <!-- نافذة منبثقة لإدخال الاسم -->
  <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-80 text-center shadow-xl">
      <h2 class="text-xl font-bold mb-4">أدخل اسمك للدخول</h2>
      <input id="usernameInput" type="text" placeholder="اسم المستخدم" class="border w-full p-2 rounded mb-4" />
      <button onclick="enterChat()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">دخول</button>
    </div>
  </div>

  <!-- محتوى الدردشة -->
  <div class="max-w-xl mx-auto p-4">
    <div class="flex justify-between items-center mb-2">
      <h1 class="text-2xl font-bold">💬 غرفة الدردشة العامة</h1>
      <button onclick="goBack()" class="text-sm text-blue-600 underline">رجوع</button>
    </div>

    <div id="chatBox" class="bg-white border h-96 p-3 overflow-y-scroll rounded-xl space-y-2"></div>

    <div class="mt-4 flex gap-2">
      <input id="messageInput" type="text" placeholder="اكتب رسالتك..." class="flex-1 p-2 border rounded" />
      <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2 rounded">إرسال</button>
    </div>
  </div>

  <!-- Firebase + Presence + Chat -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded,
      onValue, set, onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAG4EKrB3iLEV2hsB8b08ShpSO6PXDnGjg",
      authDomain: "zio3-8ffdd.firebaseapp.com",
      databaseURL: "https://zio3-8ffdd-default-rtdb.firebaseio.com",
      projectId: "zio3-8ffdd",
      storageBucket: "zio3-8ffdd.firebasestorage.app",
      messagingSenderId: "560939348415",
      appId: "1:560939348415:web:c854e9e214e498ad2d310a",
      measurementId: "G-CVN2B2D0RD"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let username = "";
    const chatBox = document.getElementById("chatBox");
    const presenceCountEl = document.getElementById("presenceCount");

    // إنشاء معرف عشوائي للمستخدم
    const userId = Math.random().toString(36).substring(2, 10);
    const presenceRef = ref(db, `presence/${userId}`);

    // دالة لإرجاع تاريخ اليوم YYYY-MM-DD
    function getTodayDate() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    // دخول الدردشة
    function enterChat() {
      const nameInput = document.getElementById("usernameInput").value.trim();
      if (!nameInput) return alert("الرجاء إدخال اسمك");
      username = nameInput;
      document.getElementById("nameModal").style.display = "none";
      listenToMessages();
      setupPresence();
    }

    // إرسال رسالة
    function sendMessage() {
      const msg = document.getElementById("messageInput").value.trim();
      if (!msg) return;
      const today = getTodayDate();
      const messagesRef = ref(db, `messages/${today}`);
      push(messagesRef, {
        name: username,
        text: msg,
        time: new Date().toLocaleTimeString()
      });
      document.getElementById("messageInput").value = "";
    }

    // الاستماع للرسائل اليومية
    function listenToMessages() {
      chatBox.innerHTML = "";
      const today = getTodayDate();
      const messagesRef = ref(db, `messages/${today}`);
      onChildAdded(messagesRef, (snap) => {
        const msg = snap.val();
        const el = document.createElement("div");
        el.innerHTML = `
          <div class="bg-gray-200 p-2 rounded">
            <strong>${msg.name}</strong>: ${msg.text}
            <span class="text-xs text-gray-500 float-left">${msg.time}</span>
          </div>`;
        chatBox.appendChild(el);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    // إعداد حضور المستخدم والعداد
    function setupPresence() {
      // أضف المستخدم للحضور
      set(presenceRef, true);
      // احذف تلقائيًا عند الخروج أو إعادة التحميل
      onDisconnect(presenceRef).remove();
      window.addEventListener("beforeunload", () => {
        remove(presenceRef);
      });

      // عداد المتصلين يتحدث تلقائيًا
      const allPresenceRef = ref(db, "presence");
      onValue(allPresenceRef, (snap) => {
        const count = snap.exists() ? Object.keys(snap.val()).length : 0;
        presenceCountEl.textContent = `عدد المتصلين: ${count}`;
      });
    }

    // زر الرجوع
    function goBack() {
      window.history.back();
    }

    // تعريض الدوال عالمياً
    window.enterChat   = enterChat;
    window.sendMessage = sendMessage;
    window.goBack      = goBack;
  </script>
</body>
</html>
