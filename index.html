<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>غرفة الدردشة العامة - سجاد (مدير)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Tajawal', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a2a6c, #2c3e50);
      min-height: 100vh;
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .admin-badge {
      background: linear-gradient(135deg, #4A00E0, #8E2DE2);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 0.7rem;
      display: inline-block;
      margin-right: 5px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .admin-panel {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .chat-bubble {
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .user-bubble {
      animation: slideInRight 0.3s ease-in-out;
    }
    
    .typing-indicator span {
      animation: bounce 1.5s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .emoji-btn {
      transition: all 0.2s ease;
    }
    
    .emoji-btn:hover {
      transform: scale(1.1);
    }
    
    .user-card {
      animation: slideInLeft 0.3s ease-in-out;
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .emoji-panel {
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .image-preview {
      max-width: 300px;
      border-radius: 10px;
      margin-top: 5px;
      cursor: pointer;
      transition: transform 0.3s;
    }
    
    .image-preview:hover {
      transform: scale(1.03);
    }
    
    .admin-controls {
      display: none;
    }
    
    .admin .admin-controls {
      display: block;
    }
    
    .guest-badge {
      background: linear-gradient(135deg, #00b09b, #96c93d);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 0.7rem;
      display: inline-block;
      margin-right: 5px;
    }
    
    .file-upload-btn {
      position: relative;
      overflow: hidden;
      display: inline-block;
      cursor: pointer;
    }
    
    .file-upload-btn input[type="file"] {
      position: absolute;
      top: 0;
      right: 0;
      min-width: 100%;
      min-height: 100%;
      font-size: 100px;
      text-align: right;
      filter: alpha(opacity=0);
      opacity: 0;
      outline: none;
      cursor: pointer;
      display: block;
    }
    
    .media-sent {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 10px;
      padding: 8px;
      margin-top: 5px;
    }
    
    .header-gradient {
      background: linear-gradient(135deg, #1a2a6c, #2c3e50);
    }
    
    .quick-login-btn {
      background: linear-gradient(135deg, #00b09b, #96c93d);
      transition: all 0.3s ease;
    }
    
    .quick-login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .user-presence {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 5px;
      background: rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .user-presence:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(-5px);
    }
    
    .presence-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 10px;
    }
    
    .presence-online {
      background: #00C853;
      box-shadow: 0 0 8px rgba(0, 200, 83, 0.5);
    }
    
    .presence-idle {
      background: #FFD600;
      box-shadow: 0 0 8px rgba(255, 214, 0, 0.5);
    }
    
    .presence-offline {
      background: #B0BEC5;
    }
    
    .message-time {
      font-size: 0.75rem;
      color: #78909C;
    }
    
    .chat-container {
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .message-input {
      transition: all 0.3s ease;
    }
    
    .message-input:focus {
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
    }
    
    .send-btn {
      transition: all 0.3s ease;
    }
    
    .send-btn:hover {
      transform: rotate(-5deg) scale(1.1);
    }
    
    .quick-message-btn {
      transition: all 0.2s ease;
      background: rgba(236, 239, 241, 0.7);
    }
    
    .quick-message-btn:hover {
      background: rgba(207, 216, 220, 0.9);
      transform: translateY(-2px);
    }
  </style>
</head>
<body class="py-8">
  <div class="max-w-6xl mx-auto px-4">
    <!-- شريط الرأس -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 rounded-xl header-gradient">
      <div class="flex items-center mb-4 md:mb-0">
        <div class="bg-white p-2 rounded-full mr-3">
          <i class="fas fa-comments text-indigo-700 text-xl"></i>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center">
            غرفة الدردشة العامة
            <span id="adminBadge" class="admin-badge hidden">مدير النظام</span>
            <span id="guestBadge" class="guest-badge hidden">ضيف</span>
          </h1>
          <div class="flex items-center mt-1">
            <div id="presenceCount" class="text-gray-200 flex items-center">
              <i class="fas fa-users mr-1"></i>
              <span>المتصلون: <span id="usersCount">0</span></span>
            </div>
            <div class="mx-3 text-gray-400">|</div>
            <div id="currentDateTime" class="text-gray-200"></div>
          </div>
        </div>
      </div>
      <button onclick="goBack()" class="bg-white hover:bg-gray-200 text-indigo-800 px-4 py-2 rounded-lg flex items-center font-bold shadow-lg transition-all hover:scale-105">
        <i class="fas fa-arrow-left mr-2"></i> رجوع
      </button>
    </div>
    
    <div class="flex flex-col lg:flex-row gap-6">
      <!-- لوحة المستخدمين المتصلين -->
      <div class="w-full lg:w-1/4 bg-white bg-opacity-90 rounded-2xl shadow-lg p-4">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-user-clock mr-2 text-indigo-600"></i> المتصلون الآن
          </h2>
          <button onclick="refreshPresence()" class="text-sm bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-1 rounded flex items-center transition-all">
            <i class="fas fa-sync-alt mr-1"></i> تحديث
          </button>
        </div>
        <div id="onlineUsers" class="space-y-2 max-h-96 overflow-y-auto">
          <!-- سيتم ملئها بالجافاسكريبت -->
          <div class="text-center text-gray-500 py-4">
            <i class="fas fa-user-slash text-2xl mb-2"></i>
            <p>لا يوجد مستخدمين متصلين</p>
          </div>
        </div>
        
        <!-- لوحة التحكم الإدارية (تظهر فقط للمدير) -->
        <div id="adminPanel" class="admin-panel mt-6 rounded-xl p-4 hidden">
          <h3 class="text-lg font-bold text-white mb-3">
            <i class="fas fa-tools mr-2"></i> لوحة التحكم الإدارية
          </h3>
          <div class="space-y-3">
            <button onclick="deleteAllMessages()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg flex items-center justify-center transition-all">
              <i class="fas fa-trash mr-2"></i> حذف جميع الرسائل
            </button>
            <button onclick="sendSystemMessage()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg flex items-center justify-center transition-all">
              <i class="fas fa-bullhorn mr-2"></i> إرسال إعلان عام
            </button>
          </div>
        </div>
      </div>
      
      <!-- منطقة الدردشة الرئيسية -->
      <div class="w-full lg:w-3/4">
        <div class="chat-container bg-white bg-opacity-90 rounded-2xl shadow-lg overflow-hidden">
          <!-- منطقة الرسائل -->
          <div id="chatBox" class="h-96 overflow-y-auto p-4 bg-gray-50">
            <div class="text-center text-gray-500 py-8">
              <i class="fas fa-comment-dots text-4xl mb-2 text-indigo-400"></i>
              <p>مرحباً! ابدأ المحادثة بإرسال رسالتك الأولى</p>
              <p class="text-sm mt-2 text-gray-400">انضم للمحادثة وأرسل تحية لتبدأ المحادثة</p>
            </div>
          </div>
          
          <!-- مؤشر الكتابة -->
          <div id="typingIndicator" class="bg-gray-100 px-4 py-2 hidden">
            <div class="flex items-center text-gray-600">
              <div class="typing-indicator mr-2">
                <span>.</span>
                <span>.</span>
                <span>.</span>
              </div>
              <span id="typingUsers"></span> يكتب الآن
            </div>
          </div>
          
          <!-- منطقة إدخال الرسالة -->
          <div class="p-4 border-t border-gray-200">
            <div class="flex gap-2">
              <div class="relative flex-1">
                <div class="flex items-center border border-gray-300 rounded-lg bg-white message-input">
                  <!-- زر إرفاق الوسائط -->
                  <div class="file-upload-btn cursor-pointer px-3 py-2 text-gray-500 hover:text-indigo-600">
                    <i class="fas fa-paperclip text-xl"></i>
                    <input type="file" id="mediaUpload" accept="image/*" class="file-input">
                  </div>
                  
                  <input 
                    id="messageInput" 
                    type="text" 
                    placeholder="اكتب رسالتك..." 
                    class="flex-1 p-2 focus:outline-none"
                    onkeydown="handleKeyDown(event)"
                  />
                  
                  <button onclick="sendMessage()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 send-btn">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
                
                <!-- معاينة الصورة -->
                <div id="imagePreviewContainer" class="mt-2 hidden">
                  <div class="flex items-center justify-between bg-gray-100 p-2 rounded-lg">
                    <span class="text-sm text-gray-600"><i class="fas fa-image mr-1"></i> صورة مرفقة</span>
                    <button onclick="cancelImageUpload()" class="text-red-500 hover:text-red-700">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <img id="imagePreview" class="image-preview" src="" alt="معاينة الصورة">
                </div>
              </div>
            </div>
            
            <div class="mt-3 flex flex-wrap gap-2">
              <button onclick="sendQuickMessage('مرحباً! كيف حالك؟')" class="text-xs quick-message-btn text-gray-700 px-2 py-1 rounded">
                مرحباً! كيف حالك؟
              </button>
              <button onclick="sendQuickMessage('هل يمكنك مساعدتي؟')" class="text-xs quick-message-btn text-gray-700 px-2 py-1 rounded">
                هل يمكنك مساعدتي؟
              </button>
              <button onclick="sendQuickMessage('أرسلت لك صورة 👇')" class="text-xs quick-message-btn text-gray-700 px-2 py-1 rounded">
                أرسلت لك صورة 👇
              </button>
              <button onclick="sendQuickMessage('شكراً على المساعدة')" class="text-xs quick-message-btn text-gray-700 px-2 py-1 rounded">
                شكراً على المساعدة
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- نافذة منبثقة لإدخال الاسم -->
    <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
      <div class="bg-gradient-to-br from-indigo-900 to-purple-800 p-6 md:p-8 rounded-2xl w-full max-w-md text-center shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-400 to-red-500"></div>
        <div class="relative z-10">
          <div class="bg-white text-indigo-800 p-4 rounded-full w-20 h-20 mx-auto mb-6 flex items-center justify-center">
            <i class="fas fa-comments text-3xl"></i>
          </div>
          <h2 class="text-2xl font-bold text-white mb-2">الدخول إلى غرفة الدردشة</h2>
          <p class="text-gray-300 mb-6">اختر اسم المستخدم للبدء في المحادثة</p>
          
          <div class="bg-white rounded-xl p-5 mb-4">
            <div class="mb-4">
              <div class="flex justify-between items-center mb-1">
                <label for="usernameInput" class="block text-gray-700 text-sm text-right">اسم المستخدم</label>
                <button onclick="clearUsername()" class="text-xs text-red-500 hover:text-red-700">
                  <i class="fas fa-trash mr-1"></i> حذف
                </button>
              </div>
              <div class="relative">
                <input 
                  id="usernameInput" 
                  type="text" 
                  placeholder="أدخل اسم المستخدم" 
                  class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                  autofocus
                />
                <button onclick="generateRandomUsername()" class="absolute left-3 top-3 text-gray-500 hover:text-indigo-600">
                  <i class="fas fa-random"></i>
                </button>
              </div>
            </div>
            
            <div id="passwordSection" class="mb-4">
              <div class="flex justify-between items-center mb-1">
                <label for="passwordInput" class="block text-gray-700 text-sm text-right">كلمة المرور</label>
                <button onclick="clearPassword()" class="text-xs text-red-500 hover:text-red-700">
                  <i class="fas fa-trash mr-1"></i> حذف
                </button>
              </div>
              <div class="relative">
                <input 
                  id="passwordInput" 
                  type="password" 
                  placeholder="أدخل كلمة المرور" 
                  class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
                />
                <button onclick="generateRandomPassword()" class="absolute left-3 top-3 text-gray-500 hover:text-indigo-600">
                  <i class="fas fa-random"></i>
                </button>
              </div>
            </div>
            
            <div id="adminMessage" class="text-sm text-gray-600 mb-3 hidden">
              <i class="fas fa-info-circle mr-1"></i> أنت تحاول الدخول بحساب إداري
            </div>
          </div>
          
          <button onclick="checkLogin()" class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-gray-900 px-6 py-3 rounded-lg w-full text-lg font-bold transition-all hover:from-yellow-500 hover:to-yellow-700">
            دخول إلى المحادثة
            <i class="fas fa-sign-in-alt ml-2"></i>
          </button>
          
          <button onclick="quickLogin()" class="quick-login-btn text-white px-6 py-3 rounded-lg w-full mt-4 font-bold">
            <i class="fas fa-bolt mr-2"></i> دخول سريع
          </button>
          
          <div class="mt-4 text-sm text-gray-300">
            <i class="fas fa-shield-alt mr-1"></i> جميع البيانات مشفرة ومحمية
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // محاكاة قاعدة البيانات باستخدام localStorage
    const chatDB = {
      messages: [],
      users: [],
      media: [],
      
      init() {
        if (!localStorage.getItem('chatMessages')) {
          localStorage.setItem('chatMessages', JSON.stringify([]));
        }
        this.messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
        
        if (!localStorage.getItem('chatUsers')) {
          localStorage.setItem('chatUsers', JSON.stringify([]));
        }
        this.users = JSON.parse(localStorage.getItem('chatUsers')) || [];
        
        if (!localStorage.getItem('chatMedia')) {
          localStorage.setItem('chatMedia', JSON.stringify([]));
        }
        this.media = JSON.parse(localStorage.getItem('chatMedia')) || [];
      },
      
      addMessage(message) {
        message.id = Date.now().toString(); // إضافة id فريد لكل رسالة
        this.messages.push(message);
        localStorage.setItem('chatMessages', JSON.stringify(this.messages));
      },
      
      addUser(user) {
        this.users.push(user);
        localStorage.setItem('chatUsers', JSON.stringify(this.users));
      },
      
      removeUser(userId) {
        this.users = this.users.filter(u => u.id !== userId);
        localStorage.setItem('chatUsers', JSON.stringify(this.users));
      },
      
      clearMessages() {
        this.messages = [];
        localStorage.setItem('chatMessages', JSON.stringify([]));
      },
      
      getMessages() {
        return this.messages;
      },
      
      getUsers() {
        return this.users;
      },
      
      addMedia(media) {
        media.id = Date.now().toString();
        this.media.push(media);
        localStorage.setItem('chatMedia', JSON.stringify(this.media));
      },
      
      getMedia() {
        return this.media;
      },
      
      deleteMessage(messageId) {
        this.messages = this.messages.filter(m => m.id !== messageId);
        localStorage.setItem('chatMessages', JSON.stringify(this.messages));
      },
      
      updateUser(userId) {
        const userIndex = this.users.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          this.users[userIndex].lastSeen = Date.now();
          localStorage.setItem('chatUsers', JSON.stringify(this.users));
        }
      }
    };

    // تهيئة قاعدة البيانات
    chatDB.init();

    // متغيرات التطبيق
    let username = "";
    let isAdmin = false;
    let isGuest = false;
    const chatBox = document.getElementById("chatBox");
    const usersCountEl = document.getElementById("usersCount");
    const onlineUsersEl = document.getElementById("onlineUsers");
    const typingIndicatorEl = document.getElementById("typingIndicator");
    const typingUsersEl = document.getElementById("typingUsers");
    const adminPanel = document.getElementById("adminPanel");
    const adminBadge = document.getElementById("adminBadge");
    const guestBadge = document.getElementById("guestBadge");
    const adminMessage = document.getElementById("adminMessage");
    const mediaUpload = document.getElementById("mediaUpload");
    const currentDateTime = document.getElementById("currentDateTime");
    let userId = Date.now().toString();
    let uploadedImage = null;
    let presenceInterval;

    // تنسيق الوقت (ساعة:دقيقة)
    function formatTime(date) {
      const hours = date.getHours();
      const minutes = date.getMinutes().toString().padStart(2, "0");
      return hours + ':' + minutes;
    }

    // تحديث التاريخ والوقت
    function updateDateTime() {
      const now = new Date();
      const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
      const day = days[now.getDay()];
      currentDateTime.textContent = `${day} - ${formatTime(now)}`;
    }

    // التحقق من تسجيل الدخول
    function checkLogin() {
      const nameInput = document.getElementById("usernameInput").value.trim();
      const passwordInput = document.getElementById("passwordInput").value;
      
      if (!nameInput) return alert("الرجاء إدخال اسم المستخدم");
      
      // إذا كان المستخدم هو "سجاد" نطلب كلمة المرور الصحيحة
      if (nameInput === "سجاد") {
        if (passwordInput !== "سجاد") {
          alert("كلمة المرور غير صحيحة");
          return;
        }
        isAdmin = true;
        adminPanel.classList.remove("hidden");
        adminBadge.classList.remove("hidden");
        document.body.classList.add("admin");
      } else {
        // للمستخدمين العاديين
        isGuest = true;
        guestBadge.classList.remove("hidden");
      }
      
      username = nameInput;
      document.getElementById("nameModal").style.display = "none";
      listenToMessages();
      setupPresence();
      
      // إرسال رسالة ترحيبية
      setTimeout(() => {
        chatDB.addMessage({
          name: "النظام",
          text: `انضم ${username} ${isAdmin ? "(مدير النظام)" : "(ضيف)"} إلى المحادثة`,
          time: formatTime(new Date()),
          isSystem: true
        });
        updateChatUI();
      }, 1000);
    }

    // الدخول السريع
    function quickLogin() {
      generateRandomUsername();
      generateRandomPassword();
      setTimeout(checkLogin, 300);
    }

    // إنشاء اسم مستخدم عشوائي
    function generateRandomUsername() {
      const adjectives = ["سريع", "هادئ", "مبتكر", "خلاق", "ذكي", "مرح", "لطيف", "صادق", "شجاع"];
      const nouns = ["أسد", "نسر", "بحر", "جبل", "نجم", "قمر", "شمس", "سحاب", "وردة"];
      const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];
      const randomNum = Math.floor(1000 + Math.random() * 9000);
      const randomUsername = `${randomAdj}_${randomNoun}_${randomNum}`;
      document.getElementById("usernameInput").value = randomUsername;
    }

    // إنشاء كلمة مرور عشوائية
    function generateRandomPassword() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let password = "";
      for (let i = 0; i < 8; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById("passwordInput").value = password;
    }

    // حذف اسم المستخدم
    function clearUsername() {
      document.getElementById("usernameInput").value = "";
    }

    // حذف كلمة المرور
    function clearPassword() {
      document.getElementById("passwordInput").value = "";
    }

    // إرسال رسالة
    function sendMessage() {
      const msgInput = document.getElementById("messageInput");
      const msg = msgInput.value.trim();
      
      // إذا لم يكن هناك رسالة ولا صورة
      if (!msg && !uploadedImage) return;
      
      const messageData = {
        name: username,
        text: msg,
        time: formatTime(new Date()),
        userId: userId,
        isAdmin: isAdmin,
        isGuest: isGuest
      };
      
      // إذا كان هناك صورة مرفقة
      if (uploadedImage) {
        messageData.image = uploadedImage;
        // حفظ الوسائط في قاعدة البيانات
        chatDB.addMedia({
          sender: username,
          type: 'image',
          url: uploadedImage,
          time: formatTime(new Date())
        });
      }
      
      chatDB.addMessage(messageData);
      updateChatUI();
      
      msgInput.value = "";
      cancelImageUpload();
    }

    // معالجة رفع الصورة
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // التحقق من نوع الملف
      if (!file.type.match('image.*')) {
        alert('الرجاء اختيار ملف صورة فقط');
        return;
      }
      
      // التحقق من حجم الملف (5MB كحد أقصى)
      if (file.size > 5 * 1024 * 1024) {
        alert('حجم الصورة يجب أن يكون أقل من 5MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedImage = e.target.result;
        document.getElementById("imagePreview").src = uploadedImage;
        document.getElementById("imagePreviewContainer").classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }

    // إلغاء رفع الصورة
    function cancelImageUpload() {
      uploadedImage = null;
      document.getElementById("mediaUpload").value = "";
      document.getElementById("imagePreviewContainer").classList.add("hidden");
    }

    // إرسال رسالة سريعة
    function sendQuickMessage(msg) {
      document.getElementById("messageInput").value = msg;
      sendMessage();
    }

    // التعامل مع ضغط المفاتيح
    function handleKeyDown(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // تحديث واجهة الدردشة
    function updateChatUI() {
      chatBox.innerHTML = "";
      const messages = chatDB.getMessages();
      
      if (messages.length === 0) {
        chatBox.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-comment-dots text-4xl mb-2 text-indigo-400"></i>
            <p>مرحباً! ابدأ المحادثة بإرسال رسالتك الأولى</p>
            <p class="text-sm mt-2 text-gray-400">انضم للمحادثة وأرسل تحية لتبدأ المحادثة</p>
          </div>
        `;
        return;
      }
      
      messages.forEach(msg => {
        const isCurrentUser = msg.userId === userId;
        const isSystem = msg.isSystem;
        
        const el = document.createElement("div");
        el.className = "mb-3 chat-bubble";
        
        if (isSystem) {
          el.innerHTML = `
            <div class="text-center text-gray-500 text-sm my-2">
              ${msg.text}
              <span class="message-time">${msg.time}</span>
            </div>
          `;
        } else {
          const adminBadge = msg.isAdmin ? '<span class="admin-badge">مدير</span>' : '';
          const guestBadge = msg.isGuest ? '<span class="guest-badge">ضيف</span>' : '';
          
          el.innerHTML = `
            <div class="${isCurrentUser ? 'user-bubble' : ''}">
              <div class="flex ${isCurrentUser ? 'justify-end' : ''}">
                <div class="flex items-end ${isCurrentUser ? 'flex-row-reverse' : ''} mb-1">
                  <span class="font-bold text-sm ${isCurrentUser ? 'text-indigo-700' : 'text-gray-700'}">
                    ${adminBadge}${guestBadge}${msg.name}
                  </span>
                  <span class="message-time mx-2">${msg.time}</span>
                </div>
              </div>
              <div class="${isCurrentUser ? 'bg-indigo-100 border-indigo-200 text-right' : 'bg-gray-100 border-gray-200'} border rounded-2xl p-3 max-w-xs md:max-w-md inline-block">
                ${msg.text || ''}
                ${msg.image ? `
                  <div class="media-sent mt-2">
                    <img src="${msg.image}" class="image-preview cursor-pointer" onclick="openMediaModal('${msg.image}')">
                  </div>
                ` : ''}
                <div class="admin-controls mt-2">
                  <button onclick="deleteMessage('${msg.id}')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">
                    <i class="fas fa-trash"></i> حذف
                  </button>
                </div>
              </div>
            </div>
          `;
        }
        
        chatBox.appendChild(el);
      });
      
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // إعداد حضور المستخدم والعداد
    function setupPresence() {
      // أضف المستخدم للحضور
      chatDB.addUser({
        id: userId,
        name: username,
        joined: formatTime(new Date()),
        isAdmin: isAdmin,
        isGuest: isGuest,
        lastSeen: Date.now()
      });
      
      updatePresenceUI();
      
      // تحديث حضور المستخدم كل 5 ثوان
      presenceInterval = setInterval(() => {
        chatDB.updateUser(userId);
        updatePresenceUI();
      }, 5000);
      
      window.addEventListener("beforeunload", () => {
        clearInterval(presenceInterval);
        chatDB.removeUser(userId);
        
        // إرسال رسالة مغادرة
        chatDB.addMessage({
          name: "النظام",
          text: `غادر ${username} ${isAdmin ? "(مدير النظام)" : isGuest ? "(ضيف)" : ""} المحادثة`,
          time: formatTime(new Date()),
          isSystem: true
        });
      });
    }
    
    // تحديث واجهة المستخدمين المتصلين
    function updatePresenceUI() {
      const now = Date.now();
      const users = chatDB.getUsers();
      
      // إزالة المستخدمين غير النشطين لأكثر من 15 ثانية
      const activeUsers = users.filter(user => now - user.lastSeen < 15000);
      activeUsers.forEach(user => chatDB.updateUser(user.id));
      
      const inactiveUsers = users.filter(user => now - user.lastSeen >= 15000);
      inactiveUsers.forEach(user => {
        chatDB.removeUser(user.id);
        chatDB.addMessage({
          name: "النظام",
          text: `انقطع اتصال ${user.name} بسبب عدم النشاط`,
          time: formatTime(new Date()),
          isSystem: true
        });
      });
      
      const updatedUsers = chatDB.getUsers();
      const count = updatedUsers.length;
      usersCountEl.textContent = count;
      
      // تحديث قائمة المستخدمين المتصلين
      onlineUsersEl.innerHTML = '';
      
      if (updatedUsers.length === 0) {
        onlineUsersEl.innerHTML = '<div class="text-center text-gray-500 py-4">لا يوجد مستخدمين متصلين</div>';
        return;
      }
      
      updatedUsers.forEach(user => {
        const isCurrent = user.id === userId;
        const lastSeenDiff = now - user.lastSeen;
        const isActive = lastSeenDiff < 5000; // نشط إذا كان آخر تحديث منذ أقل من 5 ثوان
        const isIdle = lastSeenDiff >= 5000 && lastSeenDiff < 10000; // خامل إذا بين 5-10 ثوان
        
        const userEl = document.createElement('div');
        userEl.className = `user-presence ${isCurrent ? 'bg-blue-50' : ''}`;
        
        const adminBadge = user.isAdmin ? '<span class="admin-badge">مدير</span>' : '';
        const guestBadge = user.isGuest ? '<span class="guest-badge">ضيف</span>' : '';
        
        userEl.innerHTML = `
          <div class="presence-indicator ${isActive ? 'presence-online' : isIdle ? 'presence-idle' : 'presence-offline'}"></div>
          <div class="flex-1">
            <div class="font-medium">${adminBadge}${guestBadge}${user.name}</div>
            <div class="text-xs text-gray-500">متصل منذ ${user.joined}</div>
          </div>
          ${isCurrent ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">أنت</span>' : ''}
        `;
        onlineUsersEl.appendChild(userEl);
      });
    }

    // تحديث قائمة المتصلين
    function refreshPresence() {
      updatePresenceUI();
      showNotification('تم تحديث قائمة المتصلين بنجاح');
    }

    // وظائف المدير
    function deleteMessage(messageId) {
      if (!isAdmin) return;
      if (!confirm("هل تريد حذف هذه الرسالة؟")) return;
      
      chatDB.deleteMessage(messageId);
      updateChatUI();
      showNotification('تم حذف الرسالة بنجاح');
    }
    
    function deleteAllMessages() {
      if (!isAdmin) return;
      if (!confirm("هل تريد حذف جميع الرسائل؟ لا يمكن التراجع عن هذا الإجراء.")) return;
      
      chatDB.clearMessages();
      updateChatUI();
      showNotification('تم حذف جميع الرسائل بنجاح');
    }
    
    function sendSystemMessage() {
      if (!isAdmin) return;
      const message = prompt("أدخل نص الإعلان العام:");
      if (!message) return;
      
      chatDB.addMessage({
        name: "الإدارة",
        text: `📢 إعلان: ${message}`,
        time: formatTime(new Date()),
        isSystem: true,
        isAdmin: true
      });
      updateChatUI();
      showNotification('تم إرسال الإعلان بنجاح');
    }

    // الاستماع للرسائل
    function listenToMessages() {
      updateChatUI();
      // تحديث الرسائل كل 2 ثانية
      setInterval(updateChatUI, 2000);
    }

    // زر الرجوع
    function goBack() {
      // إرسال رسالة مغادرة
      chatDB.addMessage({
        name: "النظام",
        text: `غادر ${username} ${isAdmin ? "(مدير النظام)" : isGuest ? "(ضيف)" : ""} المحادثة`,
        time: formatTime(new Date()),
        isSystem: true
      });
      
      // حذف حضور المستخدم
      chatDB.removeUser(userId);
      clearInterval(presenceInterval);
      
      // إعادة تعيين الحالة
      username = "";
      isAdmin = false;
      isGuest = false;
      adminPanel.classList.add("hidden");
      adminBadge.classList.add("hidden");
      guestBadge.classList.add("hidden");
      document.body.classList.remove("admin");
      
      // إظهار نافذة الدخول
      document.getElementById("nameModal").style.display = "flex";
    }

    // فتح نافذة الوسائط
    function openMediaModal(mediaUrl = null) {
      const mediaModal = document.getElementById('mediaModal');
      const mediaList = document.getElementById('mediaList');
      
      mediaList.innerHTML = '';
      
      // عرض الوسائط المحفوظة
      const mediaItems = chatDB.getMedia();
      if (mediaItems.length === 0) {
        mediaList.innerHTML = '<p class="text-gray-500 col-span-4 text-center py-8">لا توجد وسائط مرسلة بعد</p>';
      } else {
        mediaItems.forEach(media => {
          const mediaEl = document.createElement('div');
          mediaEl.className = 'bg-gray-100 rounded-lg overflow-hidden cursor-pointer';
          mediaEl.innerHTML = `
            <img src="${media.url}" class="w-full h-32 object-cover" onclick="showFullImage('${media.url}')">
            <div class="p-2">
              <div class="text-sm font-medium">${media.sender}</div>
              <div class="text-xs text-gray-500">${media.time}</div>
            </div>
          `;
          mediaList.appendChild(mediaEl);
        });
      }
      
      mediaModal.classList.remove('hidden');
      
      // إذا تم تمرير رابط وسائط، عرضها بالحجم الكامل
      if (mediaUrl) {
        showFullImage(mediaUrl);
      }
    }
    
    // عرض الصورة بالحجم الكامل
    function showFullImage(imageUrl) {
      const mediaModal = document.getElementById('mediaModal');
      mediaModal.innerHTML = `
        <div class="bg-black bg-opacity-90 fixed inset-0 flex items-center justify-center">
          <button onclick="closeMediaModal()" class="absolute top-4 right-4 text-white text-2xl">
            <i class="fas fa-times"></i>
          </button>
          <img src="${imageUrl}" class="max-h-screen max-w-screen p-4">
        </div>
      `;
    }
    
    // إغلاق نافذة الوسائط
    function closeMediaModal() {
      document.getElementById('mediaModal').classList.add('hidden');
    }
    
    // عرض إشعار
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-check-circle mr-2"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      // إظهار نافذة الدخول عند التحميل
      document.getElementById('nameModal').style.display = 'flex';
      
      // تحديث التاريخ والوقت
      updateDateTime();
      setInterval(updateDateTime, 60000); // تحديث كل دقيقة
      
      // عند كتابة اسم المستخدم
      document.getElementById('usernameInput').addEventListener('input', function() {
        if (this.value === 'سجاد') {
          adminMessage.classList.remove('hidden');
        } else {
          adminMessage.classList.add('hidden');
        }
      });
      
      // معالجة رفع الصورة
      document.getElementById('mediaUpload').addEventListener('change', handleImageUpload);
      
      // إنشاء اسم وكلمة مرور عشوائية أولية
      generateRandomUsername();
      generateRandomPassword();
    });
  </script>
</body>
</html>
