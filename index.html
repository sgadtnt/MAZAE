<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دردشة آمنة - ChatSecure</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #5e35b1;
            --primary-dark: #4527a0;
            --secondary: #26a69a;
            --light: #f5f5f5;
            --dark: #212121;
            --gray: #757575;
            --success: #43a047;
            --warning: #ff9800;
            --error: #e53935;
            --admin: #d32f2f;
            --background: linear-gradient(135deg, #3a1c71, #d76d77, #ffaf7b);
        }
        
        /* إضافة متغيرات للسمات المختلفة */
        body.theme-default {
            --primary: #5e35b1;
            --primary-dark: #4527a0;
            --secondary: #26a69a;
            --background: linear-gradient(135deg, #3a1c71, #d76d77, #ffaf7b);
        }
        
        body.theme-light {
            --primary: #42a5f5;
            --primary-dark: #1976d2;
            --secondary: #66bb6a;
            --background: linear-gradient(135deg, #e3f2fd, #bbdefb, #90caf9);
        }
        
        body.theme-dark {
            --primary: #7e57c2;
            --primary-dark: #5e35b1;
            --secondary: #26c6da;
            --light: #37474f;
            --dark: #e0e0e0;
            --background: linear-gradient(135deg, #2c3e50, #4a148c, #6a1b9a);
        }
        
        body.theme-blue {
            --primary: #2196f3;
            --primary-dark: #0d47a1;
            --secondary: #4db6ac;
            --background: linear-gradient(135deg, #0d47a1, #29b6f6, #81d4fa);
        }
        
        body.theme-green {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --secondary: #0097a7;
            --background: linear-gradient(135deg, #1b5e20, #4caf50, #81c784);
        }
        
        body {
            background: var(--background);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.5s ease;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            position: relative;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .logo i {
            color: var(--secondary);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.3s;
            border: 2px solid white;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
        }
        
        .admin-badge {
            background: var(--admin);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            display: none;
        }
        
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .auth-section {
            padding: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            overflow-y: auto;
        }
        
        .chat-section {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        
        .chat-header {
            background: var(--light);
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .online-users {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--gray);
        }
        
        .online-dot {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(to bottom, #f0f4f8, #e2e8f0);
            position: relative;
            min-height: 0;
            /* إصلاح مشكلة التمرير */
            flex-shrink: 1;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .message:hover {
            transform: translateY(-2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.sent {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.received {
            align-self: flex-start;
            background: white;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
        }
        
        .message-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        .message-actions {
            position: absolute;
            top: 5px;
            left: 5px;
            display: none;
            gap: 5px;
        }
        
        .message:hover .message-actions {
            display: flex;
        }
        
        .action-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .action-btn:hover {
            background: rgba(0,0,0,0.3);
        }
        
        .message-input-area {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #e9ecef;
            gap: 10px;
            position: relative;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e9ecef;
            border-radius: 30px;
            font-size: 1rem;
            outline: none;
            transition: border 0.3s, box-shadow 0.3s;
            background: #f8f9fa;
        }
        
        .message-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(94, 53, 177, 0.2);
        }
        
        .send-button {
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .send-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .send-button:active {
            transform: translateY(1px);
        }
        
        .auth-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 450px;
            position: relative;
            overflow: hidden;
            margin-top: 20px;
            z-index: 10;
        }
        
        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }
        
        .auth-title {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: var(--primary);
            text-align: center;
            position: relative;
        }
        
        .auth-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: var(--secondary);
            border-radius: 3px;
        }
        
        .input-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .input-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #ced4da;
            border-radius: 10px;
            font-size: 1rem;
            transition: border 0.3s;
            background: #f8f9fa;
        }
        
        .input-group input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .auth-button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .auth-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .auth-button:active {
            transform: translateY(1px);
        }
        
        .button-secondary {
            background: white;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .button-secondary:hover {
            background: #f8f9fa;
        }
        
        .auth-footer {
            margin-top: 25px;
            text-align: center;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .auth-footer a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        .error-message {
            color: var(--error);
            background: #ffebee;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }
        
        .welcome-message {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .welcome-message h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .welcome-message p {
            font-size: 1.1rem;
            color: var(--gray);
            max-width: 600px;
            line-height: 1.6;
        }
        
        .brand-logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .typing-indicator {
            display: none;
            padding: 10px 15px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            align-self: flex-start;
            margin-bottom: 10px;
            font-style: italic;
            color: var(--gray);
            animation: pulse-light 1.5s infinite;
        }
        
        @keyframes pulse-light {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        .user-menu {
            position: absolute;
            top: 70px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 15px;
            z-index: 100;
            display: none;
            width: 250px;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-menu h3 {
            margin-bottom: 10px;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .user-menu-item {
            padding: 10px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s;
            border-radius: 5px;
            padding: 10px;
        }
        
        .user-menu-item:hover {
            background: #f5f5f5;
        }
        
        .admin-section {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .admin-section h4 {
            margin-bottom: 10px;
            color: var(--admin);
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
        }
        
        .admin-btn {
            flex: 1;
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: var(--admin);
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 0.9rem;
        }
        
        .admin-btn:hover {
            background: #b71c1c;
        }
        
        .admin-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 20px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        
        .admin-panel.active {
            transform: translateX(0);
        }
        
        .admin-panel h2 {
            color: var(--admin);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-admin {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .admin-section-title {
            margin: 15px 0 10px;
            color: var(--admin);
            font-size: 1.1rem;
            position: relative;
            padding-bottom: 5px;
        }
        
        .admin-section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 2px;
            background: var(--admin);
        }
        
        .admin-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
        }
        
        .admin-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-item:last-child {
            border-bottom: none;
        }
        
        .admin-actions {
            display: flex;
            gap: 5px;
        }
        
        .admin-action-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.3s;
        }
        
        .admin-action-btn:hover {
            background: #e9e9e9;
        }
        
        .admin-action-btn.delete {
            color: var(--error);
            border-color: #ffcdd2;
        }
        
        .admin-action-btn.block {
            color: var(--warning);
            border-color: #ffe0b2;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .modal-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .modal-btn.secondary {
            background: #f5f5f5;
            color: var(--dark);
        }
        
        .modal-btn.secondary:hover {
            background: #e9e9e9;
        }
        
        .consent-checkbox {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .consent-checkbox input {
            width: 18px;
            height: 18px;
        }
        
        .privacy-highlight {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.9rem;
        }
        
        .privacy-highlight i {
            color: var(--primary);
            margin-left: 5px;
        }
        
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray);
            text-align: center;
            padding: 20px;
        }
        
        .empty-chat i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #e0e0e0;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #f5f5f5;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        /* أزرار التمرير */
        .scroll-controls {
            position: absolute;
            bottom: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }
        
        .scroll-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .scroll-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        /* نافذة اختيار السمات */
        .theme-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            display: none;
        }
        
        .theme-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .theme-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .theme-item {
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
            text-align: center;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .theme-item:hover {
            transform: translateY(-5px);
        }
        
        .theme-item.active::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.3);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .theme-default-item {
            background: linear-gradient(135deg, #3a1c71, #d76d77, #ffaf7b);
        }
        
        .theme-light-item {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb, #90caf9);
            color: #333;
        }
        
        .theme-dark-item {
            background: linear-gradient(135deg, #2c3e50, #4a148c, #6a1b9a);
        }
        
        .theme-blue-item {
            background: linear-gradient(135deg, #0d47a1, #29b6f6, #81d4fa);
        }
        
        .theme-green-item {
            background: linear-gradient(135deg, #1b5e20, #4caf50, #81c784);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                height: 95vh;
                border-radius: 15px;
            }
            
            .auth-card {
                padding: 25px 15px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .admin-panel {
                width: 85%;
            }
            
            .welcome-message h1 {
                font-size: 1.8rem;
            }
            
            .theme-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="theme-default">
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <span>دردشة آمنة</span>
            </div>
            <div class="user-info">
                <div class="admin-badge" id="admin-badge">
                    <i class="fas fa-crown"></i> مدير
                </div>
                <div class="user-avatar" id="user-avatar" onclick="toggleUserMenu()">U</div>
            </div>
            
            <div class="user-menu" id="user-menu">
                <h3 id="menu-username">المستخدم</h3>
                <div class="user-menu-item" onclick="openProfileModal()">
                    <i class="fas fa-user-edit"></i>
                    <span>تعديل الملف الشخصي</span>
                </div>
                <div class="user-menu-item" onclick="openThemeModal()">
                    <i class="fas fa-palette"></i>
                    <span>تغيير الألوان</span>
                </div>
                <div class="user-menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>تسجيل الخروج</span>
                </div>
                
                <div class="admin-section" id="admin-section">
                    <h4>أدوات المدير</h4>
                    <div class="admin-controls">
                        <button class="admin-btn" onclick="openAdminPanel()">
                            <i class="fas fa-users-cog"></i> لوحة التحكم
                        </button>
                        <button class="admin-btn" onclick="openUserManagement()">
                            <i class="fas fa-user-lock"></i> إدارة المستخدمين
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <main>
            <div class="auth-section" id="auth-section">
                <div class="welcome-message">
                    <div class="brand-logo">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h1>مرحبًا في دردشة آمنة</h1>
                    <p>خصوصية تامة وتواصل آمن مع تشفير متكامل لحماية بياناتك</p>
                </div>
                
                <div class="auth-card">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('login')">تسجيل الدخول</button>
                        <button class="tab" onclick="switchTab('signup')">إنشاء حساب</button>
                    </div>
                    
                    <div class="auth-form active" id="login-form">
                        <div class="privacy-highlight">
                            <i class="fas fa-lock"></i>
                            <span>نحن نحترم خصوصيتك. لا يتم تسجيل أي بيانات تلقائيًا قبل موافقتك</span>
                        </div>
                        
                        <div class="input-group">
                            <label for="email">البريد الإلكتروني</label>
                            <input type="email" id="email" placeholder="example@mail.com">
                        </div>
                        
                        <div class="input-group">
                            <label for="password">كلمة المرور</label>
                            <input type="password" id="password" placeholder="********">
                        </div>
                        
                        <div class="consent-checkbox">
                            <input type="checkbox" id="data-consent">
                            <label for="data-consent">أوافق على تخزين بيانات المحادثة</label>
                        </div>
                        
                        <div class="error-message" id="error-message"></div>
                        
                        <button class="auth-button" onclick="login()">تسجيل الدخول</button>
                        
                        <div class="auth-footer">
                            <p>باستخدامك لهذا الموقع، فإنك توافق على <a href="#">سياسة الخصوصية</a> الخاصة بنا</p>
                        </div>
                    </div>
                    
                    <div class="auth-form" id="signup-form">
                        <div class="privacy-highlight">
                            <i class="fas fa-user-shield"></i>
                            <span>بياناتك الشخصية مشفرة وآمنة معنا</span>
                        </div>
                        
                        <div class="input-group">
                            <label for="signup-email">البريد الإلكتروني</label>
                            <input type="email" id="signup-email" placeholder="example@mail.com">
                        </div>
                        
                        <div class="input-group">
                            <label for="signup-password">كلمة المرور (6 أحرف على الأقل)</label>
                            <input type="password" id="signup-password" placeholder="********">
                        </div>
                        
                        <div class="input-group">
                            <label for="confirm-password">تأكيد كلمة المرور</label>
                            <input type="password" id="confirm-password" placeholder="********">
                        </div>
                        
                        <div class="consent-checkbox">
                            <input type="checkbox" id="signup-consent">
                            <label for="signup-consent">أوافق على شروط الخدمة وسياسة الخصوصية</label>
                        </div>
                        
                        <div class="error-message" id="signup-error-message"></div>
                        
                        <button class="auth-button" onclick="signup()">إنشاء حساب جديد</button>
                        
                        <div class="auth-footer">
                            <p>لديك حساب بالفعل؟ <a href="#" onclick="switchTab('login')">سجل الدخول هنا</a></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-section" id="chat-section">
                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-title">الدردشة العامة</div>
                        <div class="online-users">
                            <div class="online-dot"></div>
                            <span id="online-count">1</span> متصل الآن
                        </div>
                    </div>
                    
                    <div class="chat-box" id="chat-box">
                        <div class="empty-chat">
                            <i class="fas fa-comment-dots"></i>
                            <h3>لا توجد رسائل بعد</h3>
                            <p>ابدأ المحادثة بإرسال أول رسالة لك</p>
                        </div>
                        <div class="typing-indicator" id="typing-indicator">
                            <span id="typing-text">يكتب الآن...</span>
                        </div>
                    </div>
                    
                    <div class="message-input-area">
                        <input type="text" class="message-input" id="message-input" 
                               placeholder="اكتب رسالتك هنا..." onkeypress="handleKeyPress(event)">
                        <button class="send-button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- أزرار التمرير -->
                <div class="scroll-controls">
                    <div class="scroll-btn" onclick="scrollChat('up')">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="scroll-btn" onclick="scrollChat('down')">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="scroll-btn" onclick="scrollChat('top')">
                        <i class="fas fa-angle-double-up"></i>
                    </div>
                    <div class="scroll-btn" onclick="scrollChat('bottom')">
                        <i class="fas fa-angle-double-down"></i>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- لوحة تحكم المدير -->
    <div class="admin-panel" id="admin-panel">
        <h2>
            لوحة التحكم
            <button class="close-admin" onclick="closeAdminPanel()">
                <i class="fas fa-times"></i>
            </button>
        </h2>
        
        <div class="admin-section-title">المستخدمون المتصلون</div>
        <div class="admin-list" id="online-users-list">
            <div class="admin-item">جارٍ التحميل...</div>
        </div>
        
        <div class="admin-section-title">آخر الرسائل</div>
        <div class="admin-list" id="recent-messages">
            <div class="admin-item">لا توجد رسائل حديثة</div>
        </div>
        
        <div class="admin-section-title">الإحصائيات</div>
        <div class="stats">
            <div class="admin-item">المستخدمون المسجلون: <span id="total-users">0</span></div>
            <div class="admin-item">الرسائل اليوم: <span id="today-messages">0</span></div>
            <div class="admin-item">المستخدمون النشطون: <span id="active-users">0</span></div>
        </div>
    </div>
    
    <!-- نافذة تعديل الملف الشخصي -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <h3 class="modal-title">تعديل الملف الشخصي</h3>
            <input type="text" class="modal-input" id="username-input" placeholder="اسم المستخدم الجديد">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('profile-modal')">إلغاء</button>
                <button class="modal-btn primary" onclick="updateProfile()">حفظ التغييرات</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة إدارة المستخدمين -->
    <div class="modal" id="users-modal">
        <div class="modal-content">
            <h3 class="modal-title">إدارة المستخدمين</h3>
            <div class="admin-list" id="users-list" style="height: 300px;">
                <div class="admin-item">جارٍ تحميل المستخدمين...</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('users-modal')">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة اختيار الألوان -->
    <div class="theme-modal" id="theme-modal">
        <div class="theme-content">
            <h3 class="theme-title">اختر سمة التطبيق</h3>
            <div class="theme-grid">
                <div class="theme-item theme-default-item" onclick="setTheme('default')">
                    الافتراضية
                </div>
                <div class="theme-item theme-light-item" onclick="setTheme('light')">
                    فاتحة
                </div>
                <div class="theme-item theme-dark-item" onclick="setTheme('dark')">
                    داكنة
                </div>
                <div class="theme-item theme-blue-item" onclick="setTheme('blue')">
                    زرقاء
                </div>
                <div class="theme-item theme-green-item" onclick="setTheme('green')">
                    خضراء
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal('theme-modal')">إغلاق</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBbwKLg6_hAADjH4itOD9qDwAQEoJMBOds",
            authDomain: "gram-e6f72.firebaseapp.com",
            databaseURL: "https://gram-e6f72-default-rtdb.firebaseio.com",
            projectId: "gram-e6f72",
            storageBucket: "gram-e6f72.firebasestorage.app",
            messagingSenderId: "426955075285",
            appId: "1:426955075285:web:ee07a5b56cd9b38da2fc5c",
            measurementId: "G-3F6BV361SJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // State variables
        let currentUser = null;
        let isAdmin = false;
        let username = "";
        let messages = [];
        
        // DOM elements
        const authSection = document.getElementById('auth-section');
        const chatSection = document.getElementById('chat-section');
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const errorMessage = document.getElementById('error-message');
        const signupErrorMessage = document.getElementById('signup-error-message');
        const userAvatar = document.getElementById('user-avatar');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingText = document.getElementById('typing-text');
        const onlineCount = document.getElementById('online-count');
        const adminBadge = document.getElementById('admin-badge');
        const userMenu = document.getElementById('user-menu');
        const adminSection = document.getElementById('admin-section');
        const adminPanel = document.getElementById('admin-panel');
        const profileModal = document.getElementById('profile-modal');
        const usersModal = document.getElementById('users-modal');
        const usernameInput = document.getElementById('username-input');
        const menuUsername = document.getElementById('menu-username');
        const themeModal = document.getElementById('theme-modal');
        
        // Initialize the app
        function init() {
            // تحميل السمة المحفوظة
            loadTheme();
            
            // Check if user is logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    username = user.email.split('@')[0];
                    menuUsername.textContent = username;
                    userAvatar.textContent = username.charAt(0).toUpperCase();
                    
                    // Check if admin
                    isAdmin = user.email === "admin@example.com";
                    adminBadge.style.display = isAdmin ? "block" : "none";
                    adminSection.style.display = isAdmin ? "block" : "none";
                    
                    // Show chat section
                    showChatSection();
                    
                    // Setup database listeners
                    setupDatabaseListeners();
                } else {
                    // No user is signed in
                    showAuthSection();
                }
            });
        }
        
        // Setup database listeners
        function setupDatabaseListeners() {
            // Listen for new messages
            const messagesRef = database.ref('messages');
            messagesRef.limitToLast(20).on('child_added', snapshot => {
                const message = snapshot.val();
                addMessageToChat(message, message.userId === currentUser.uid);
            });
            
            // Listen for typing indicators
            const typingRef = database.ref('typing');
            typingRef.on('value', snapshot => {
                const typingData = snapshot.val() || {};
                const typingUsers = Object.values(typingData).filter(user => 
                    user.isTyping && user.userId !== currentUser.uid
                );
                
                if (typingUsers.length > 0) {
                    typingText.textContent = `${typingUsers[0].username} يكتب الآن...`;
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            });
            
            // Listen for online users
            const onlineRef = database.ref('online');
            onlineRef.on('value', snapshot => {
                const onlineUsers = snapshot.val() || {};
                const onlineCountVal = Object.keys(onlineUsers).length;
                onlineCount.textContent = onlineCountVal;
            });
        }
        
        // Show authentication section
        function showAuthSection() {
            authSection.style.display = 'flex';
            chatSection.style.display = 'none';
            errorMessage.style.display = 'none';
            signupErrorMessage.style.display = 'none';
            userMenu.style.display = 'none';
        }
        
        // Show chat section
        function showChatSection() {
            authSection.style.display = 'none';
            chatSection.style.display = 'flex';
            
            // Set user as online
            setOnlineStatus(true);
            
            // Clear chat
            chatBox.innerHTML = '';
            
            // Add typing indicator
            chatBox.appendChild(typingIndicator);
            
            // Load messages
            loadMessages();
        }
        
        // Set user online status
        function setOnlineStatus(isOnline) {
            if (!currentUser) return;
            
            const onlineRef = database.ref('online/' + currentUser.uid);
            
            if (isOnline) {
                onlineRef.set({
                    userId: currentUser.uid,
                    username: username,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Set user offline when they disconnect
                onlineRef.onDisconnect().remove();
            } else {
                onlineRef.remove();
            }
        }
        
        // Sign up new user
        function signup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const consent = document.getElementById('signup-consent').checked;
            
            if (!validateSignupInput(email, password, confirmPassword)) return;
            
            if (!consent) {
                showSignupError('يجب الموافقة على شروط الخدمة وسياسة الخصوصية');
                return;
            }
            
            showLoading('signup');
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    hideLoading('signup');
                    showSignupSuccess('تم إنشاء الحساب بنجاح!');
                    
                    // Set default username
                    username = email.split('@')[0];
                    menuUsername.textContent = username;
                })
                .catch((error) => {
                    hideLoading('signup');
                    showSignupError(`خطأ: ${error.message}`);
                });
        }
        
        // Log in existing user
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const consent = document.getElementById('data-consent').checked;
            
            if (!validateLoginInput(email, password)) return;
            
            if (!consent) {
                showError('يجب الموافقة على تخزين بيانات المحادثة');
                return;
            }
            
            showLoading('login');
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    hideLoading('login');
                })
                .catch((error) => {
                    hideLoading('login');
                    showError(`خطأ: ${error.message}`);
                });
        }
        
        // Send message
        function sendMessage() {
            const text = messageInput.value.trim();
            
            if (!text) return;
            
            if (!currentUser) return;
            
            // Create message object
            const message = {
                text: text,
                userId: currentUser.uid,
                username: username,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Save to database
            database.ref('messages').push(message);
            
            // Clear input
            messageInput.value = "";
            
            // Reset typing status
            setTypingStatus(false);
            
            // Scroll to bottom after sending message
            setTimeout(() => {
                scrollChat('bottom');
            }, 100);
        }
        
        // Load messages
        function loadMessages() {
            // Clear existing messages
            chatBox.innerHTML = '';
            
            // Add empty state if no messages
            const emptyChat = document.createElement('div');
            emptyChat.className = 'empty-chat';
            emptyChat.innerHTML = `
                <i class="fas fa-comment-dots"></i>
                <h3>لا توجد رسائل بعد</h3>
                <p>ابدأ المحادثة بإرسال أول رسالة لك</p>
            `;
            chatBox.appendChild(emptyChat);
            
            // Add typing indicator
            chatBox.appendChild(typingIndicator);
            
            // Scroll to bottom
            scrollChat('bottom');
        }
        
        // Add message to chat UI
        function addMessageToChat(msg, isCurrentUser) {
            // Remove empty state if exists
            const emptyChat = document.querySelector('.empty-chat');
            if (emptyChat) emptyChat.remove();
            
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isCurrentUser ? 'sent' : 'received');
            
            // Format timestamp
            const date = new Date(msg.timestamp);
            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="message-text">${msg.text}</div>
                <div class="message-info">
                    <span>${isCurrentUser ? 'أنت' : msg.username}</span>
                    <span>${timeString}</span>
                </div>
            `;
            
            chatBox.appendChild(messageElement);
            
            // Scroll to bottom
            scrollChat('bottom');
        }
        
        // Set typing status
        function setTypingStatus(isTyping) {
            if (!currentUser) return;
            
            const typingRef = database.ref('typing/' + currentUser.uid);
            
            if (isTyping) {
                typingRef.set({
                    userId: currentUser.uid,
                    username: username,
                    isTyping: true
                });
            } else {
                typingRef.remove();
            }
        }
        
        // Validate login input fields
        function validateLoginInput(email, password) {
            if (!email || !password) {
                showError('يرجى ملء جميع الحقول');
                return false;
            }
            
            if (password.length < 6) {
                showError('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                return false;
            }
            
            // Simple email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('البريد الإلكتروني غير صالح');
                return false;
            }
            
            return true;
        }
        
        // Validate signup input fields
        function validateSignupInput(email, password, confirmPassword) {
            if (!email || !password || !confirmPassword) {
                showSignupError('يرجى ملء جميع الحقول');
                return false;
            }
            
            if (password.length < 6) {
                showSignupError('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                return false;
            }
            
            if (password !== confirmPassword) {
                showSignupError('كلمتا المرور غير متطابقتين');
                return false;
            }
            
            // Simple email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showSignupError('البريد الإلكتروني غير صالح');
                return false;
            }
            
            return true;
        }
        
        // Show loading state
        function showLoading(type) {
            const button = type === 'login' ? 
                document.querySelector('#login-form .auth-button') : 
                document.querySelector('#signup-form .auth-button');
                
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...';
        }
        
        // Hide loading state
        function hideLoading(type) {
            const button = type === 'login' ? 
                document.querySelector('#login-form .auth-button') : 
                document.querySelector('#signup-form .auth-button');
                
            button.disabled = false;
            button.textContent = type === 'login' ? 'تسجيل الدخول' : 'إنشاء حساب جديد';
        }
        
        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            errorMessage.style.backgroundColor = '#ffebee';
            errorMessage.style.color = '#e53935';
        }
        
        // Show success message
        function showSuccess(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            errorMessage.style.backgroundColor = '#e6f7ee';
            errorMessage.style.color = '#43a047';
        }
        
        // Show signup error message
        function showSignupError(message) {
            signupErrorMessage.textContent = message;
            signupErrorMessage.style.display = 'block';
            signupErrorMessage.style.backgroundColor = '#ffebee';
            signupErrorMessage.style.color = '#e53935';
        }
        
        // Show signup success message
        function showSignupSuccess(message) {
            signupErrorMessage.textContent = message;
            signupErrorMessage.style.display = 'block';
            signupErrorMessage.style.backgroundColor = '#e6f7ee';
            signupErrorMessage.style.color = '#43a047';
        }
        
        // Handle Enter key press
        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            } else {
                // Update typing status
                setTypingStatus(true);
                clearTimeout(window.typingTimeout);
                window.typingTimeout = setTimeout(() => {
                    setTypingStatus(false);
                }, 2000);
            }
        }
        
        // Toggle user menu
        function toggleUserMenu() {
            if (userMenu.style.display === 'block') {
                userMenu.style.display = 'none';
            } else {
                userMenu.style.display = 'block';
            }
        }
        
        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu') && !e.target.closest('.user-avatar')) {
                userMenu.style.display = 'none';
            }
        });
        
        // Switch between login and signup tabs
        function switchTab(tabName) {
            // Hide all forms
            document.querySelectorAll('.auth-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected form
            document.getElementById(`${tabName}-form`).style.display = 'block';
            
            // Add active class to selected tab
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Clear error messages
            errorMessage.style.display = 'none';
            signupErrorMessage.style.display = 'none';
        }
        
        // Open admin panel
        function openAdminPanel() {
            adminPanel.classList.add('active');
            userMenu.style.display = 'none';
        }
        
        // Close admin panel
        function closeAdminPanel() {
            adminPanel.classList.remove('active');
        }
        
        // Open user management modal
        function openUserManagement() {
            usersModal.style.display = 'flex';
            userMenu.style.display = 'none';
            loadUsersList();
        }
        
        // Load users list
        function loadUsersList() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '<div class="admin-item">جارٍ تحميل المستخدمين...</div>';
            
            // Simulate loading
            setTimeout(() => {
                const users = [
                    { id: 1, name: "أحمد محمد", status: "نشط" },
                    { id: 2, name: "سارة علي", status: "نشط" },
                    { id: 3, name: "محمد خالد", status: "محظور" },
                    { id: 4, name: "فاطمة عبدالله", status: "نشط" },
                    { id: 5, name: "عمر حسن", status: "غير نشط" }
                ];
                
                usersList.innerHTML = '';
                
                users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'admin-item';
                    item.innerHTML = `
                        <div>
                            <div>${user.name}</div>
                            <div style="font-size: 0.8rem; color: ${user.status === 'نشط' ? '#43a047' : user.status === 'محظور' ? '#e53935' : '#757575'}">${user.status}</div>
                        </div>
                        <div class="admin-actions">
                            <button class="admin-action-btn block" onclick="toggleBlockUser(${user.id})">
                                ${user.status === 'محظور' ? 'فك الحظر' : 'حظر'}
                            </button>
                            <button class="admin-action-btn delete" onclick="deleteUser(${user.id})">
                                حذف
                            </button>
                        </div>
                    `;
                    usersList.appendChild(item);
                });
            }, 800);
        }
        
        // Open profile modal
        function openProfileModal() {
            profileModal.style.display = 'flex';
            usernameInput.value = username || "مستخدم";
            userMenu.style.display = 'none';
        }
        
        // Open theme modal
        function openThemeModal() {
            themeModal.style.display = 'flex';
            userMenu.style.display = 'none';
            highlightCurrentTheme();
        }
        
        // Highlight current theme
        function highlightCurrentTheme() {
            const currentTheme = localStorage.getItem('theme') || 'default';
            document.querySelectorAll('.theme-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.theme-${currentTheme}-item`).classList.add('active');
        }
        
        // Set theme
        function setTheme(themeName) {
            document.body.className = `theme-${themeName}`;
            localStorage.setItem('theme', themeName);
            highlightCurrentTheme();
        }
        
        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.className = `theme-${savedTheme}`;
            }
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Update user profile
        function updateProfile() {
            const newUsername = usernameInput.value.trim();
            if (!newUsername) {
                showError('يرجى إدخال اسم مستخدم صالح');
                return;
            }
            
            username = newUsername;
            userAvatar.textContent = newUsername.charAt(0).toUpperCase();
            menuUsername.textContent = newUsername;
            
            closeModal('profile-modal');
            showSuccess('تم تحديث الملف الشخصي بنجاح!');
        }
        
        // Logout user
        function logout() {
            // Set offline
            setOnlineStatus(false);
            
            auth.signOut().then(() => {
                showAuthSection();
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                document.getElementById('data-consent').checked = false;
                showSuccess('تم تسجيل الخروج بنجاح!');
            });
        }
        
        // Toggle block user
        function toggleBlockUser(userId) {
            alert(`تم ${confirm('هل تريد حظر/فك حظر هذا المستخدم؟') ? 'تطبيق' : 'إلغاء'} العملية على المستخدم ${userId}`);
        }
        
        // Delete user
        function deleteUser(userId) {
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                alert(`تم حذف المستخدم ${userId}`);
            }
        }
        
        // Scroll chat box
        function scrollChat(direction) {
            if (!chatBox) return;
            
            switch(direction) {
                case 'up':
                    chatBox.scrollTop -= 100;
                    break;
                case 'down':
                    chatBox.scrollTop += 100;
                    break;
                case 'top':
                    chatBox.scrollTop = 0;
                    break;
                case 'bottom':
                    chatBox.scrollTop = chatBox.scrollHeight;
                    break;
            }
        }
        
        // Initialize the app when page loads
        window.onload = init;
    </script>
</body>
</html>