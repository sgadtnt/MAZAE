<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø¹ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† -->
  <div id="presenceCount" class="max-w-xl mx-auto p-2 text-center text-sm text-gray-600">
    Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: 0
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… -->
  <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl w-80 text-center shadow-xl">
      <h2 class="text-xl font-bold mb-4">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„</h2>
      <input id="usernameInput" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="border w-full p-2 rounded mb-4" />
      <button onclick="enterChat()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
  <div class="max-w-xl mx-auto p-4">
    <div class="flex justify-between items-center mb-2">
      <h1 class="text-2xl font-bold">ğŸ’¬ ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h1>
      <button onclick="goBack()" class="text-sm text-blue-600 underline">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="chatBox" class="bg-white border h-96 p-3 overflow-y-scroll rounded-xl space-y-2"></div>

    <div class="mt-4 flex gap-2">
      <input id="messageInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="flex-1 p-2 border rounded" />
      <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2 rounded">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- Firebase + Presence + Chat -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded,
      onValue, set, onDisconnect, remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAG4EKrB3iLEV2hsB8b08ShpSO6PXDnGjg",
      authDomain: "zio3-8ffdd.firebaseapp.com",
      databaseURL: "https://zio3-8ffdd-default-rtdb.firebaseio.com",
      projectId: "zio3-8ffdd",
      storageBucket: "zio3-8ffdd.firebasestorage.app",
      messagingSenderId: "560939348415",
      appId: "1:560939348415:web:c854e9e214e498ad2d310a",
      measurementId: "G-CVN2B2D0RD"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let username = "";
    const chatBox = document.getElementById("chatBox");
    const presenceCountEl = document.getElementById("presenceCount");

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userId = Math.random().toString(36).substring(2, 10);
    const presenceRef = ref(db, `presence/${userId}`);

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø¬Ø§Ø¹ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… YYYY-MM-DD
    function getTodayDate() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    function enterChat() {
      const nameInput = document.getElementById("usernameInput").value.trim();
      if (!nameInput) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ");
      username = nameInput;
      document.getElementById("nameModal").style.display = "none";
      listenToMessages();
      setupPresence();
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    function sendMessage() {
      const msg = document.getElementById("messageInput").value.trim();
      if (!msg) return;
      const today = getTodayDate();
      const messagesRef = ref(db, `messages/${today}`);
      push(messagesRef, {
        name: username,
        text: msg,
        time: new Date().toLocaleTimeString()
      });
      document.getElementById("messageInput").value = "";
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    function listenToMessages() {
      chatBox.innerHTML = "";
      const today = getTodayDate();
      const messagesRef = ref(db, `messages/${today}`);
      onChildAdded(messagesRef, (snap) => {
        const msg = snap.val();
        const el = document.createElement("div");
        el.innerHTML = `
          <div class="bg-gray-200 p-2 rounded">
            <strong>${msg.name}</strong>: ${msg.text}
            <span class="text-xs text-gray-500 float-left">${msg.time}</span>
          </div>`;
        chatBox.appendChild(el);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯
    function setupPresence() {
      // Ø£Ø¶Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø­Ø¶ÙˆØ±
      set(presenceRef, true);
      // Ø§Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      onDisconnect(presenceRef).remove();
      window.addEventListener("beforeunload", () => {
        remove(presenceRef);
      });

      // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙŠØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      const allPresenceRef = ref(db, "presence");
      onValue(allPresenceRef, (snap) => {
        const count = snap.exists() ? Object.keys(snap.val()).length : 0;
        presenceCountEl.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: ${count}`;
      });
    }

    // Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
    function goBack() {
      window.history.back();
    }

    // ØªØ¹Ø±ÙŠØ¶ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
    window.enterChat   = enterChat;
    window.sendMessage = sendMessage;
    window.goBack      = goBack;
  </script>
</body>
</html>
