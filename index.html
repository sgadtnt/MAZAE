<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام المحادثة العامة</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body, html {
      height: 100%;
      background: #f0f2f5;
    }
    
    .page {
      display: none;
      min-height: 100vh;
      flex-direction: column;
    }
    
    .active-page {
      display: flex;
    }
    
    /* صفحة تسجيل الدخول */
    .auth-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      padding: 20px;
    }
    
    .auth-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 450px;
      padding: 40px 30px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .logo {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(to right, #10b981, #34d399);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      margin: 0 auto 20px;
      position: relative;
      z-index: 2;
    }
    
    .title {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #1e293b;
      position: relative;
      z-index: 2;
    }
    
    .subtitle {
      color: #64748b;
      margin-bottom: 30px;
      position: relative;
      z-index: 2;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: right;
      position: relative;
      z-index: 2;
    }
    
    .input-label {
      display: block;
      text-align: right;
      margin-bottom: 8px;
      color: #1e293b;
      font-weight: 500;
    }
    
    .input-field {
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 16px;
      transition: all 0.3s;
      background: rgba(255,255,255,0.9);
    }
    
    .input-field:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .forgot-password {
      display: block;
      text-align: left;
      margin-top: 5px;
      color: #3b82f6;
      text-decoration: none;
      font-size: 0.9rem;
    }
    
    .forgot-password:hover {
      text-decoration: underline;
    }
    
    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      position: relative;
      z-index: 2;
    }
    
    .btn-primary {
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(59, 130, 246, 0.4);
    }
    
    .btn-tertiary {
      background: linear-gradient(to right, #10b981, #34d399);
      color: white;
      box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
    }
    
    .btn-tertiary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(16, 185, 129, 0.4);
    }
    
    .divider {
      display: flex;
      align-items: center;
      margin: 25px 0;
      position: relative;
      z-index: 2;
    }
    
    .divider-line {
      flex: 1;
      height: 1px;
      background: #e2e8f0;
    }
    
    .divider-text {
      padding: 0 15px;
      color: #64748b;
    }
    
    .footer-text {
      color: #64748b;
      margin-top: 30px;
      font-size: 0.9rem;
      position: relative;
      z-index: 2;
    }
    
    .footer-text a {
      color: #3b82f6;
      text-decoration: none;
      font-weight: 600;
    }
    
    .footer-text a:hover {
      text-decoration: underline;
    }
    
    .terms {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 20px;
      text-align: center;
      position: relative;
      z-index: 2;
    }
    
    .terms a {
      color: #3b82f6;
      text-decoration: none;
    }
    
    .terms a:hover {
      text-decoration: underline;
    }
    
    .error-message {
      color: #ef4444;
      background: #fee2e2;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: right;
      display: none;
      position: relative;
      z-index: 2;
    }
    
    .success-message {
      color: #047857;
      background: #d1fae5;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: right;
      display: none;
      position: relative;
      z-index: 2;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .google-btn {
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 600;
      color: #5f6368;
      transition: all 0.3s;
    }
    
    .google-btn:hover {
      background: #f8fafc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .google-icon {
      width: 20px;
      height: 20px;
      background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJNMTcuNiA5LjJsLS4xLTEuOEg5djMuNGg0LjhDMTMuNiAxMiAxMyAxMyAxMiAxMy42djIuMmgzYTguOCA4LjggMCAwIDAgMi42LTYuNnoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjxwYXRoIGQ9Ik05IDE4YzIuNCAwIDQuNS0uOCA2LTIuMmwtMy0yLjJhNS40IDUuNCAwIDAgMS04LTIuOUgxVjEzYTkgOSAwIDAgMCA4IDV6IiBmaWxsPSIjMzRBODUzIiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJNNCAxMC43YTUuNCA1LjQgMCAwIDEgMC0zLjRWNUgxYTkgOSAwIDAgMCAwIDhsMy0yLjN6IiBmaWxsPSIjRkJCQzA1IiBmaWxsLXJ1bGU9Im5vbnplcm8iLz48cGF0aCBkPSJOSAzLjZjMS4zIDAgMi41LjQgMy40IDEuM0wxNSAyLjNBOSA5IDAgMCAwIDEgNWwzIDIuNGE1LjQgNS40IDAgMCAxIDUtMy43eiIgZmlsbD0iI0VBNDMzNSIgZmlsbC1ydWxlPSJub256ZXJvIi8+PHBhdGggZD0iTTAgMGgxOHYxOEgweiIvPjwvZz48L3N2Zz4=') center no-repeat;
    }
    
    /* صفحة المحادثة العامة */
    .conversation-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f0f2f5;
    }
    
    .chat-header {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 10;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(to right, #10b981, #34d399);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .logout-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 20px;
      padding: 8px 15px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .message {
      max-width: 80%;
      padding: 12px 15px;
      border-radius: 18px;
      position: relative;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .sent {
      align-self: flex-end;
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 5px;
    }
    
    .received {
      align-self: flex-start;
      background: #e5e7eb;
      color: #1f2937;
      border-bottom-left-radius: 5px;
    }
    
    .message-sender {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    .message-time {
      font-size: 0.7rem;
      opacity: 0.7;
      text-align: left;
      margin-top: 5px;
    }
    
    .chat-input-container {
      padding: 15px;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
    }
    
    .message-input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s;
    }
    
    .message-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .send-btn {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 0 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .send-btn:hover {
      background: #1e40af;
    }
    
    .chat-title {
      text-align: center;
      padding: 20px;
      color: #1e40af;
      background: #f0f2f5;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .welcome-message {
      text-align: center;
      padding: 20px;
      color: #4b5563;
      background: #f9fafb;
      border-radius: 10px;
      margin: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .floating-animation {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.3);
      z-index: 0;
      animation: float 15s infinite linear;
    }
    
    @keyframes float {
      0% { transform: translate(0, 0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translate(300px, 300px); opacity: 0; }
    }
    
    .floating-animation:nth-child(1) {
      top: 10%;
      left: 20%;
      width: 15px;
      height: 15px;
      animation-duration: 20s;
      background: rgba(16, 185, 129, 0.3);
    }
    
    .floating-animation:nth-child(2) {
      top: 70%;
      left: 80%;
      width: 25px;
      height: 25px;
      animation-duration: 25s;
      animation-delay: 2s;
      background: rgba(245, 158, 11, 0.3);
    }
    
    .floating-animation:nth-child(3) {
      top: 40%;
      left: 50%;
      width: 20px;
      height: 20px;
      animation-duration: 18s;
      animation-delay: 4s;
      background: rgba(139, 92, 246, 0.3);
    }
    
    /* التكيف مع الأجهزة المحمولة */
    @media (max-width: 768px) {
      .auth-card {
        padding: 30px 20px;
      }
      
      .title {
        font-size: 1.5rem;
      }
      
      .logo {
        width: 80px;
        height: 80px;
        font-size: 2rem;
      }
      
      .message {
        max-width: 90%;
      }
      
      .chat-header {
        padding: 10px 15px;
      }
      
      .user-avatar {
        width: 35px;
        height: 35px;
      }
    }
  </style>
</head>
<body>
  <!-- عناصر الرسوم المتحركة العائمة -->
  <div class="floating-animation"></div>
  <div class="floating-animation"></div>
  <div class="floating-animation"></div>
  
  <!-- صفحة تسجيل الدخول -->
  <div id="loginPage" class="page active-page auth-container">
    <div class="auth-card">
      <div class="logo">
        <i class="fas fa-lock"></i>
      </div>
      <h1 class="title">تسجيل الدخول</h1>
      <p class="subtitle">سجل دخولك للوصول إلى المحادثة العامة</p>
      
      <div id="loginError" class="error-message"></div>
      
      <form id="loginForm">
        <div class="input-group">
          <label class="input-label">البريد الإلكتروني</label>
          <input type="email" id="loginEmail" class="input-field" placeholder="example@mail.com" required>
        </div>
        
        <div class="input-group">
          <label class="input-label">كلمة المرور</label>
          <input type="password" id="loginPassword" class="input-field" placeholder="••••••••" required>
          <a href="#" id="forgotPassword" class="forgot-password">نسيت كلمة المرور؟</a>
        </div>
        
        <button type="submit" class="btn btn-primary" id="loginButton">
          تسجيل الدخول
        </button>
      </form>
      
      <div class="divider">
        <div class="divider-line"></div>
        <div class="divider-text">أو</div>
        <div class="divider-line"></div>
      </div>
      
      <button class="btn google-btn" id="googleLogin">
        <div class="google-icon"></div>
        تسجيل الدخول بحساب جوجل
      </button>
      
      <p class="footer-text">
        ليس لديك حساب؟ <a href="#" id="goToSignup">أنشئ حساب جديد</a>
      </p>
    </div>
  </div>
  
  <!-- صفحة إنشاء حساب -->
  <div id="signupPage" class="page auth-container">
    <div class="auth-card">
      <div class="logo">
        <i class="fas fa-user-plus"></i>
      </div>
      <h1 class="title">إنشاء حساب جديد</h1>
      <p class="subtitle">انضم إلينا وابدأ المحادثة</p>
      
      <div id="signupError" class="error-message"></div>
      
      <form id="signupForm">
        <div class="input-group">
          <label class="input-label">الاسم الكامل</label>
          <input type="text" id="fullName" class="input-field" placeholder="أدخل اسمك الكامل" required>
        </div>
        
        <div class="input-group">
          <label class="input-label">البريد الإلكتروني</label>
          <input type="email" id="signupEmail" class="input-field" placeholder="example@mail.com" required>
        </div>
        
        <div class="input-group">
          <label class="input-label">كلمة المرور</label>
          <input type="password" id="signupPassword" class="input-field" placeholder="••••••••" required>
          <a href="#" id="forgotPasswordSignup" class="forgot-password">نسيت كلمة المرور؟</a>
        </div>
        
        <div class="input-group">
          <label class="input-label">تأكيد كلمة المرور</label>
          <input type="password" id="confirmPassword" class="input-field" placeholder="••••••••" required>
        </div>
        
        <button type="submit" class="btn btn-tertiary" id="signupButton">
          إنشاء حساب
        </button>
      </form>
      
      <div class="terms">
        بإنشائك حساب فإنك توافق على <a href="#">شروط الخدمة</a> و <a href="#">سياسة الخصوصية</a>
      </div>
      
      <div class="divider">
        <div class="divider-line"></div>
        <div class="divider-text">أو</div>
        <div class="divider-line"></div>
      </div>
      
      <button class="btn google-btn" id="googleSignup">
        <div class="google-icon"></div>
        التسجيل بحساب جوجل
      </button>
      
      <p class="footer-text">
        لديك حساب بالفعل؟ <a href="#" id="goToLogin">تسجيل الدخول</a>
      </p>
    </div>
  </div>
  
  <!-- صفحة المحادثة العامة -->
  <div id="conversationPage" class="page conversation-container">
    <div class="chat-header">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">م</div>
        <div>
          <div id="userName">مستخدم</div>
          <div style="font-size: 0.8rem; opacity: 0.8;">متصل الآن</div>
        </div>
      </div>
      <button class="logout-btn" id="logoutButton">
        <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
      </button>
    </div>
    
    <div class="chat-title">
      <h2>المحادثة العامة</h2>
      <p>غرفة المحادثة المشتركة لجميع المستخدمين</p>
    </div>
    
    <div class="welcome-message">
      <h3>مرحبًا بك في غرفة المحادثة العامة!</h3>
      <p>يمكنك الآن البدء في المحادثة مع المستخدمين الآخرين في هذه الغرفة.</p>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <!-- الرسائل ستظهر هنا -->
      <div class="message received">
        <div class="message-sender">المشرف</div>
        <div>مرحبًا بك في غرفة المحادثة العامة! يمكنك البدء في إرسال رسائلك الآن.</div>
        <div class="message-time">١٠:٠٠ ص</div>
      </div>
    </div>
    
    <div class="chat-input-container">
      <input type="text" class="message-input" id="messageInput" placeholder="اكتب رسالتك هنا...">
      <button class="send-btn" id="sendButton">
        <i class="fas fa-paper-plane"></i> إرسال
      </button>
    </div>
  </div>

  <script>
    // التهيئة باستخدام قاعدة بيانات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAG4EKrB3iLEV2hsB8b08ShpSO6PXDnGjg",
      authDomain: "zio3-8ffdd.firebaseapp.com",
      databaseURL: "https://zio3-8ffdd-default-rtdb.firebaseio.com",
      projectId: "zio3-8ffdd",
      storageBucket: "zio3-8ffdd.appspot.com",
      messagingSenderId: "560939348415",
      appId: "1:560939348415:web:c854e9e214e498ad2d310a",
      measurementId: "G-CVN2B2D0RD"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // متغيرات النظام
    let currentUser = null;
    
    // عناصر DOM
    const pages = {
      login: document.getElementById('loginPage'),
      signup: document.getElementById('signupPage'),
      conversation: document.getElementById('conversationPage')
    };
    
    // عناصر الأخطاء والرسائل
    const loginError = document.getElementById('loginError');
    const signupError = document.getElementById('signupError');
    
    // عناصر المحادثة
    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');
    const logoutButton = document.getElementById('logoutButton');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    // إخفاء رسائل الخطأ في البداية
    loginError.style.display = 'none';
    signupError.style.display = 'none';
    
    // وظائف التنقل بين الصفحات
    function showPage(pageName) {
      Object.values(pages).forEach(page => page.classList.remove('active-page'));
      pages[pageName].classList.add('active-page');
      
      // إخفاء رسائل الخطأ عند تغيير الصفحات
      loginError.style.display = 'none';
      signupError.style.display = 'none';
    }
    
    // تهيئة الأحداث
    function initEvents() {
      // التنقل بين الصفحات
      document.getElementById('goToSignup').addEventListener('click', (e) => {
        e.preventDefault();
        showPage('signup');
      });
      
      document.getElementById('goToLogin').addEventListener('click', (e) => {
        e.preventDefault();
        showPage('login');
      });
      
      document.getElementById('forgotPassword').addEventListener('click', (e) => {
        e.preventDefault();
        alert('سيتم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني');
      });
      
      document.getElementById('forgotPasswordSignup').addEventListener('click', (e) => {
        e.preventDefault();
        alert('سيتم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني');
      });
      
      // تسجيل الدخول
      document.getElementById('loginForm').addEventListener('submit', loginUser);
      
      // إنشاء حساب
      document.getElementById('signupForm').addEventListener('submit', signupUser);
      
      // تسجيل الدخول بحساب جوجل
      document.getElementById('googleLogin').addEventListener('click', handleGoogleLogin);
      document.getElementById('googleSignup').addEventListener('click', handleGoogleLogin);
      
      // تسجيل الخروج
      logoutButton.addEventListener('click', logoutUser);
      
      // إرسال الرسائل
      sendButton.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    }
    
    // تسجيل الدخول باستخدام البريد الإلكتروني وكلمة المرور
    function loginUser(e) {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      // إظهار حالة التحميل
      const loginButton = document.getElementById('loginButton');
      loginButton.innerHTML = '<div class="loading-spinner"></div> جاري تسجيل الدخول...';
      loginButton.disabled = true;
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // تم تسجيل الدخول بنجاح
          currentUser = userCredential.user;
          loginError.style.display = 'none';
          
          // تحديث واجهة المحادثة
          updateConversationUI();
          
          // الانتقال إلى صفحة المحادثة
          showPage('conversation');
          
          // إعادة تعيين حالة الزر
          loginButton.innerHTML = 'تسجيل الدخول';
          loginButton.disabled = false;
        })
        .catch((error) => {
          // معالجة الأخطاء
          handleAuthError(error, loginError);
          loginButton.innerHTML = 'تسجيل الدخول';
          loginButton.disabled = false;
        });
    }
    
    // إنشاء حساب جديد
    function signupUser(e) {
      e.preventDefault();
      
      const fullName = document.getElementById('fullName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // التحقق من تطابق كلمتي المرور
      if (password !== confirmPassword) {
        signupError.textContent = 'كلمة المرور وتأكيدها غير متطابقين';
        signupError.style.display = 'block';
        return;
      }
      
      // إظهار حالة التحميل
      const signupButton = document.getElementById('signupButton');
      signupButton.innerHTML = '<div class="loading-spinner"></div> جاري إنشاء الحساب...';
      signupButton.disabled = true;
      
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // تم إنشاء الحساب بنجاح
          currentUser = userCredential.user;
          signupError.style.display = 'none';
          
          // تحديث واجهة المحادثة
          updateConversationUI();
          
          // الانتقال إلى صفحة المحادثة
          showPage('conversation');
          
          // إعادة تعيين حالة الزر
          signupButton.innerHTML = 'إنشاء حساب';
          signupButton.disabled = false;
        })
        .catch((error) => {
          // معالجة الأخطاء
          handleAuthError(error, signupError);
          signupButton.innerHTML = 'إنشاء حساب';
          signupButton.disabled = false;
        });
    }
    
    // تسجيل الدخول بحساب جوجل
    function handleGoogleLogin(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // عرض رسالة تحميل
      const button = e.target.closest('button');
      const originalText = button.innerHTML;
      button.innerHTML = '<div class="loading-spinner"></div> جاري التحضير...';
      button.disabled = true;
      
      // تسجيل الدخول بحساب جوجل
      const provider = new firebase.auth.GoogleAuthProvider();
      
      auth.signInWithPopup(provider)
        .then((result) => {
          // تم تسجيل الدخول بنجاح
          currentUser = result.user;
          
          // تحديث واجهة المحادثة
          updateConversationUI();
          
          // الانتقال إلى صفحة المحادثة
          showPage('conversation');
          
          button.innerHTML = originalText;
          button.disabled = false;
        })
        .catch((error) => {
          // معالجة الأخطاء
          handleAuthError(error, loginError);
          button.innerHTML = originalText;
          button.disabled = false;
        });
    }
    
    // تحديث واجهة المحادثة بناءً على بيانات المستخدم
    function updateConversationUI() {
      if (!currentUser) return;
      
      // عرض اسم المستخدم
      userName.textContent = currentUser.displayName || currentUser.email.split('@')[0];
      
      // عرض الحرف الأول من اسم المستخدم في الصورة الرمزية
      const displayName = currentUser.displayName || currentUser.email;
      userAvatar.textContent = displayName.charAt(0).toUpperCase();
    }
    
    // تسجيل الخروج
    function logoutUser() {
      auth.signOut().then(() => {
        // الانتقال إلى صفحة تسجيل الدخول
        showPage('login');
        
        // مسح حقل البريد الإلكتروني
        document.getElementById('loginEmail').value = '';
      });
    }
    
    // إرسال رسالة
    function sendMessage() {
      const messageText = messageInput.value.trim();
      if (!messageText || !currentUser) return;
      
      // إنشاء عنصر الرسالة
      const messageElement = document.createElement('div');
      messageElement.className = 'message sent';
      
      const displayName = currentUser.displayName || currentUser.email.split('@')[0];
      
      messageElement.innerHTML = `
        <div class="message-sender">أنت</div>
        <div>${messageText}</div>
        <div class="message-time">${getCurrentTime()}</div>
      `;
      
      // إضافة الرسالة إلى المحادثة
      chatMessages.appendChild(messageElement);
      
      // مسح حقل الإدخال
      messageInput.value = '';
      
      // التمرير إلى أحدث رسالة
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      // إضافة رد تلقائي بعد ثانيتين
      setTimeout(() => {
        addAutoReply();
      }, 2000);
    }
    
    // الحصول على الوقت الحالي
    function getCurrentTime() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const period = hours >= 12 ? 'م' : 'ص';
      const formattedHours = hours % 12 || 12;
      return `${formattedHours}:${minutes < 10 ? '0' : ''}${minutes} ${period}`;
    }
    
    // إضافة رد تلقائي
    function addAutoReply() {
      const replies = [
        "أهلاً بك في غرفتنا! كيف يمكنني مساعدتك؟",
        "شكراً على مشاركتك في المحادثة العامة!",
        "هل لديك أي أسئلة أو استفسارات؟",
        "نحن سعداء بانضمامك إلينا في هذه الغرفة",
        "نتمنى لك وقتاً ممتعاً معنا!"
      ];
      
      const randomReply = replies[Math.floor(Math.random() * replies.length)];
      
      const messageElement = document.createElement('div');
      messageElement.className = 'message received';
      messageElement.innerHTML = `
        <div class="message-sender">المساعد</div>
        <div>${randomReply}</div>
        <div class="message-time">${getCurrentTime()}</div>
      `;
      
      chatMessages.appendChild(messageElement);
      
      // التمرير إلى أحدث رسالة
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // معالجة أخطاء المصادقة
    function handleAuthError(error, errorElement) {
      let errorMessage;
      
      switch (error.code) {
        case 'auth/invalid-email':
          errorMessage = 'بريد إلكتروني غير صحيح';
          break;
        case 'auth/user-disabled':
          errorMessage = 'هذا الحساب معطل';
          break;
        case 'auth/user-not-found':
          errorMessage = 'لا يوجد حساب مرتبط بهذا البريد الإلكتروني';
          break;
        case 'auth/wrong-password':
          errorMessage = 'كلمة المرور غير صحيحة';
          break;
        case 'auth/email-already-in-use':
          errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل';
          break;
        case 'auth/weak-password':
          errorMessage = 'كلمة المرور ضعيفة، يجب أن تحتوي على 6 أحرف على الأقل';
          break;
        case 'auth/operation-not-allowed':
          errorMessage = 'هذه العملية غير مسموح بها';
          break;
        case 'auth/too-many-requests':
          errorMessage = 'لقد تجاوزت عدد المحاولات المسموح بها، حاول لاحقاً';
          break;
        case 'auth/popup-blocked':
          errorMessage = 'تم حظر نافذة تسجيل الدخول. يرجى السماح بالنوافذ المنبثقة لهذا الموقع';
          break;
        case 'auth/popup-closed-by-user':
          errorMessage = 'تم إغلاق نافذة تسجيل الدخول قبل إكمال العملية';
          break;
        default:
          errorMessage = 'حدث خطأ غير متوقع، حاول مرة أخرى';
      }
      
      errorElement.textContent = errorMessage;
      errorElement.style.display = 'block';
    }
    
    // بدء التطبيق
    window.addEventListener('DOMContentLoaded', () => {
      // تحقق من حالة تسجيل الدخول
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          // تحديث واجهة المحادثة
          updateConversationUI();
          // الانتقال إلى صفحة المحادثة
          showPage('conversation');
        } else {
          // الانتقال إلى صفحة تسجيل الدخول
          showPage('login');
        }
      });
      
      // تهيئة أحداث النظام
      initEvents();
    });
  </script>
</body>
                                                                                  </html>
