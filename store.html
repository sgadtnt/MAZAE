<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجرنا الإلكتروني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Global Font: Cairo */
        body {
            font-family: 'Cairo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            direction: rtl;
            text-align: right;
            background-color: #f2f2f7; /* iOS light background */
            padding-top: 60px; /* Adjusted for fixed top header */
            padding-bottom: 70px; /* Adjusted for fixed bottom navigation */
            font-size: 1.05rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative; /* Needed for footer positioning */
            font-weight: 700; /* خط عريض لمعظم نصوص المتجر */
        }

        /* Dark Mode for iOS-like UI */
        body.dark-mode {
            background-color: #1c1c1e; /* iOS dark background */
            color: #e5e5ea; /* iOS dark mode text */
        }
        body.dark-mode .container {
            background-color: #1c1c1e;
        }
        /* Frosted Glass / Translucent backgrounds for dark mode */
        body.dark-mode .header,
        body.dark-mode #bottom-nav-bar {
            background-color: rgba(28, 28, 30, 0.7); /* Darker translucent for header */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }
        body.dark-mode .header h1,
        body.dark-mode .header-nav-links a,
        body.dark-mode .cart-icon-container {
            color: #e5e5ea;
        }
        body.dark-mode .product-card,
        body.dark-mode .bg-white,
        body.dark-mode .modal-content,
        body.dark-mode .bg-gray-50,
        body.dark-mode .bg-gray-100 {
            background-color: #2c2c2e; /* Darker background for cards/modals */
            color: #e5e5ea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        body.dark-mode .product-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        body.dark-mode .product-name,
        body.dark-mode .modal-content h3,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4 {
            color: #e5e5ea;
        }
        body.dark-mode .product-price,
        body.dark-mode #modal-product-price,
        body.dark-mode #cart-total,
        body.dark-mode #checkout-total,
        body.dark-mode #modal-order-total {
            color: #007AFF; /* Primary Blue */
        }
        body.dark-mode .product-original-price,
        body.dark-mode .text-gray-500,
        body.dark-mode .text-gray-600,
        body.dark-mode .text-gray-700,
        body.dark-mode .text-gray-800 {
            color: #aeaeb2; /* iOS dark mode gray */
        }
        body.dark-mode .border-b,
        body.dark-mode .border-t,
        body.dark-mode .border-gray-300 {
            border-color: #3a3a3c; /* Darker borders */
        }
        body.dark-mode .category-button-page {
            background-color: #2c2c2e;
            color: #e5e5ea;
        }
        body.dark-mode .category-button-page:hover,
        body.dark-mode .category-button-page.active {
            background-color: #007AFF; /* Primary Blue */
            color: white;
        }
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #3a3a3c;
            border-color: #545458;
            color: #e5e5ea;
        }
        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.5); /* Primary Blue glow */
            border-color: #007AFF;
        }
        body.dark-mode #search-suggestions {
            background-color: #2c2c2e;
            border-color: #3a3a3c;
        }
        body.dark-mode #search-suggestions div:hover {
            background-color: #3a3a3c;
        }
        body.dark-mode .favorite-toggle-btn {
            background-color: rgba(44, 44, 46, 0.7);
            color: #8e8e93;
        }
        body.dark-mode .favorite-toggle-btn.active {
            color: #FF3B30; /* Primary Red */
        }
        body.dark-mode .favorite-toggle-btn:hover {
            background-color: rgba(44, 44, 46, 0.9);
        }
        body.dark-mode .back-to-home-btn {
            color: #007AFF; /* Primary Blue */
        }
        body.dark-mode .back-to-home-btn:hover {
            color: #32d74b; /* iOS dark mode green - keeping for contrast */
        }
        body.dark-mode .bg-gray-200 {
            background-color: #3a3a3c;
            color: #e5e5ea;
        }
        body.dark-mode .bg-gray-200:hover {
            background-color: #545458;
        }
        body.dark-mode .cart-icon-container:hover {
            background-color: rgba(0, 122, 255, 0.2); /* Primary Blue with transparency */
        }
        body.dark-mode .notification.success { background-color: #34c759; } /* iOS Green - keeping for success */
        body.dark-mode .notification.error { background-color: #FF3B30; } /* Primary Red */
        body.dark-mode .notification.warning { background-color: #FFCC00; color: #1c1c1e; } /* Primary Yellow */
        body.dark-mode .notification.info { background-color: #007AFF; } /* Primary Blue */
        body.dark-mode .dynamic-footer {
            background-color: rgba(28, 28, 30, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 -2px 8px rgba(0,0,0,0.4);
            color: #e5e5ea;
        }
        body.dark-mode .dynamic-footer a {
            color: #007AFF;
        }
        body.dark-mode .dynamic-footer a:hover {
            color: #32d74b;
        }
        body.dark-mode .footer-social-links a {
            color: #aeaeb2;
        }
        body.dark-mode .footer-social-links a:hover {
            color: #007AFF;
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            flex-grow: 1;
        }

        /* Unified Header Styles - iOS-like translucent */
        .header {
            background-color: rgba(255, 255, 255, 0.7); /* Translucent white */
            backdrop-filter: blur(20px) saturate(180%); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            color: #1c1c1e; /* Dark text for light mode */
            padding: 8px 15px; /* Slightly reduced top/bottom padding */
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1); /* Subtle shadow */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            width: 100%;
            height: 80px; /* Increased height for top bar */
        }

        .header h1 {
            font-size: 1.5rem; /* Increased size */
            font-weight: 800; /* Even bolder */
            display: flex;
            align-items: center;
            margin: 0;
            margin-top: -5px; /* Move slightly up */
            color: #1c1c1e; /* Dark text */
        }
        .header h1 i {
            font-size: 2.2rem; /* Larger store icon */
            margin-left: 10px; /* Adjusted margin */
            color: #007AFF; /* Primary Blue */
        }
        .header-nav-main {
            display: flex; /* Always display */
            align-items: center;
            gap: 0.75rem;
        }
        .cart-icon-container {
            display: flex;
            flex-direction: column; /* Stack icon and text */
            align-items: center;
            padding: 6px 10px; /* Slightly larger touch targets */
            border-radius: 8px; /* More rounded */
            transition: background-color 0.2s ease, color 0.2s ease;
            color: #007AFF; /* Primary Blue for links */
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .cart-icon-container i {
            margin-left: 0; /* Remove margin-left for stacked layout */
            font-size: 1.3rem; /* Larger icon */
            margin-bottom: 3px; /* Space between icon and text */
        }
        .cart-icon-container:hover {
            background-color: rgba(0, 122, 255, 0.1); /* Light blue highlight */
            color: #007AFF;
        }
        .cart-count {
            top: -1px;
            right: 1px;
            padding: 0px 4px;
            font-size: 0.65rem;
            background-color: #FF3B30; /* Primary Red */
            color: white;
            border-radius: 9999px; /* Fully rounded */
        }

        /* New styles for top bar icons */
        .header-icon-btn {
            display: flex;
            flex-direction: column; /* Stack icon and text */
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: #007AFF;
            text-decoration: none;
            font-size: 0.75rem; /* Smaller font for text below icon */
            font-weight: 500;
            white-space: nowrap;
        }
        .header-icon-btn i {
            margin-left: 0; /* Remove margin-left for stacked layout */
            font-size: 1.3rem; /* Larger icon */
            margin-bottom: 3px; /* Space between icon and text */
        }
        .header-icon-btn:hover {
            background-color: rgba(0, 122, 255, 0.1);
            color: #007AFF;
        }
        body.dark-mode .header-icon-btn {
            color: #e5e5ea;
        }
        body.dark-mode .header-icon-btn:hover {
            background-color: rgba(0, 122, 255, 0.2);
            color: #e5e5ea;
        }

        .product-card {
            background-color: white;
            border-radius: 12px; /* More rounded */
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* Softer shadow */
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .product-image {
            width: 100%;
            padding-top: 100%;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .product-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .product-info {
            padding: 16px; /* Increased padding */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
        }
        .product-name {
            font-weight: 600; /* Semi-bold */
            font-size: 1.1rem;
            color: #1c1c1e; /* Dark text */
            margin-bottom: 8px;
        }
        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #007AFF; /* Primary Blue */
        }
        .product-original-price {
            text-decoration: line-through;
            color: #8e8e93; /* iOS Gray */
            font-size: 0.9rem;
            margin-right: 8px;
        }
        .product-description {
            font-size: 0.95rem;
            color: #636366; /* iOS Gray */
            margin-top: 6px;
            line-height: 1.5;
            flex-grow: 1;
        }
        
        /* Category Cards */
        .category-button-page {
            background-color: white;
            color: #1c1c1e; /* Dark text */
            border-radius: 12px; /* More rounded */
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 130px; /* Slightly taller */
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .category-button-page:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .category-main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 12px;
            z-index: 1;
        }

        .category-overlay-strip {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Darker overlay for contrast */
            color: white;
            padding: 12px 18px; /* More padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            z-index: 2;
        }
        .dark-mode .category-overlay-strip {
            background-color: rgba(44, 44, 46, 0.7);
        }

        .category-name-text {
            font-size: 1.2rem; /* Larger font for category name */
            font-weight: 700;
            color: white;
            flex-grow: 1;
            text-align: right;
            margin-right: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dark-mode .category-name-text {
            color: #e5e5ea;
        }

        .info-button {
            background: rgba(255, 255, 255, 0.3); /* More translucent */
            border-radius: 50%;
            width: 40px; /* Larger button */
            height: 40px; /* Larger button */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        .info-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .dark-mode .info-button {
            background: rgba(255, 255, 255, 0.15);
        }
        .dark-mode .info-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.4); /* Slightly lighter overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: rgba(255, 255, 255, 0.9); /* Translucent background */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 30px; /* More padding */
            border-radius: 16px; /* More rounded */
            box-shadow: 0 8px 24px rgba(0,0,0,0.25); /* Stronger, softer shadow */
            width: 90%;
            max-width: 750px; /* Increased max-width */
            animation: slideIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 18px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideInNotification 0.3s, fadeOutNotification 0.5s 2.5s forwards;
            font-size: 0.95rem;
        }
        @keyframes slideInNotification {
            from { right: -300px; opacity: 0; }
            to { right: 20px; opacity: 1; }
        }
        @keyframes fadeOutNotification {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .notification.success { background-color: #34c759; } /* iOS Green */
        .notification.error { background-color: #FF3B30; } /* Primary Red */
        .notification.warning { background-color: #FFCC00; color: #1c1c1e; } /* Primary Yellow */
        .notification.info { background-color: #007AFF; } /* Primary Blue */

        .favorite-toggle-btn {
            position: absolute;
            top: 12px; /* Adjusted position */
            left: 12px; /* Adjusted position */
            background-color: rgba(255, 255, 255, 0.8); /* More opaque */
            border-radius: 50%;
            width: 36px; /* Larger size */
            height: 36px; /* Larger size */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem; /* Larger icon */
            color: #ccc;
            transition: color 0.2s ease, background-color 0.2s ease;
            z-index: 10;
        }
        .favorite-toggle-btn.active {
            color: #FF3B30; /* Primary Red */
        }
        .favorite-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 1);
            color: #FF3B30;
        }

        .back-to-home-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #007AFF; /* Primary Blue */
            transition: color 0.2s ease;
        }
        .back-to-home-btn:hover {
            color: #0056b3; /* Darker Primary Blue */
        }
        .back-to-home-btn i {
            font-size: 1.6rem; /* Larger icon */
        }

        /* Search suggestions styling */
        #search-suggestions {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        #search-suggestions div {
            padding: 10px 15px; /* More padding */
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95rem;
            color: #1c1c1e;
        }
        #search-suggestions div:last-child {
            border-bottom: none;
        }
        #search-suggestions div:hover {
            background-color: #f5f5f7; /* Light hover */
        }

        /* Search and Sort Controls */
        .search-sort-controls {
            padding: 15px; /* More padding */
            border-radius: 12px; /* More rounded */
            margin-bottom: 20px; /* More margin */
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex; /* Ensure flex for alignment */
            flex-direction: row-reverse; /* RTL: search on right, sort on left */
            align-items: center;
            gap: 1rem; /* Space between search and sort */
        }
        .search-sort-controls input {
            flex-grow: 1; /* Search input takes available space */
            padding: 10px 15px; /* More padding */
            font-size: 1rem;
            border-radius: 10px; /* More rounded */
            border: 1px solid #e0e0e0;
            background-color: #f9f9fb; /* Slightly off-white */
            color: #1c1c1e;
        }
        .search-sort-controls .sort-controls-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Smaller gap between label and select */
            white-space: nowrap; /* Keep label and select on one line */
        }
        .search-sort-controls select {
            width: auto; /* Allow select to shrink */
            min-width: 120px; /* Minimum width for sort dropdown */
            padding: 8px 12px; /* Slightly less padding for smaller size */
            font-size: 0.9rem; /* Smaller font size */
            border-radius: 10px; /* More rounded */
            border: 1px solid #e0e0e0;
            background-color: #f9f9fb; /* Slightly off-white */
            color: #1c1c1e;
        }
        .search-sort-controls input:focus,
        .search-sort-controls select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3); /* Primary Blue glow */
            border-color: #007AFF;
        }

        /* Profile picture styling */
        .profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007AFF; /* Primary Blue */
            margin-bottom: 1rem;
        }

        /* General Button Styles - iOS-like */
        .btn-primary {
            background-color: #007AFF; /* Primary Blue */
            color: white;
            padding: 12px 20px;
            border-radius: 10px; /* Rounded */
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background-color: #0056b3; /* Darker blue on hover */
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
            background-color: #004080; /* Even darker on press */
        }
        .btn-secondary {
            background-color: #e5e5ea; /* iOS light gray */
            color: #1c1c1e; /* Dark text */
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-secondary:hover {
            background-color: #d1d1d6;
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            background-color: #c7c7cc;
        }
        .btn-success {
            background-color: #34c759; /* iOS Green - keeping for success */
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-success:hover {
            background-color: #30a84d; /* Darker green */
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .btn-success:active {
            transform: translateY(0);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
            background-color: #278d40;
        }
        .btn-danger {
            background-color: #FF3B30; /* Primary Red */
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-danger:hover {
            background-color: #e02b20; /* Darker red */
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .btn-danger:active {
            transform: translateY(0);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.15);
            background-color: #c22018;
        }

        /* Apply button styles to specific elements */
        #add-to-cart-btn, #toggle-favorite-modal-btn {
            @apply btn-success;
            width: 100%;
            font-size: 1.05rem;
            padding: 14px 20px;
        }
        #toggle-favorite-modal-btn {
            @apply btn-secondary; /* This one is secondary action */
            color: #1c1c1e;
        }
        body.dark-mode #toggle-favorite-modal-btn {
            @apply bg-gray-200; /* Revert to dark mode gray for secondary button */
            background-color: #3a3a3c;
            color: #e5e5ea;
        }
        body.dark-mode #toggle-favorite-modal-btn:hover {
            background-color: #545458;
        }

        .add-to-cart-btn-card {
            @apply btn-success;
            width: 100%;
            font-size: 0.9rem;
            padding: 10px 15px;
        }
        #proceed-to-checkout-btn {
            @apply btn-primary;
        }
        #checkout-form button[type="submit"] {
            @apply btn-success;
        }
        #profile-form button[type="submit"] {
            @apply btn-primary;
        }
        /* Removed dark-mode-toggle-desktop styles from here, as it's moved */
        #shipping-addresses-list + button { /* Add new address button */
            @apply btn-success;
        }
        #address-form button[type="submit"] {
            @apply btn-primary;
        }
        #confirm-ok-btn {
            @apply btn-danger;
        }
        #order-details-contact-support-btn {
            @apply btn-primary;
        }
        .close-modal {
            @apply btn-secondary;
            padding: 8px 12px;
            font-size: 0.9rem;
            border-radius: 8px;
        }
        .close-modal i {
            margin: 0; /* Remove margin for close icon */
        }
        .close-modal:hover {
            background-color: #d1d1d6;
        }
        body.dark-mode .close-modal {
            background-color: #3a3a3c;
            color: #e5e5ea;
        }
        body.dark-mode .close-modal:hover {
            background-color: #545458;
        }

        /* Bottom Navigation Bar */
        #bottom-nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 60px; /* Fixed height */
            background-color: rgba(255, 255, 255, 0.7); /* Translucent white */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
            display: flex; /* Always display */
            justify-content: space-around;
            align-items: center;
            z-index: 900; /* Below modals, above content */
            padding-bottom: env(safe-area-inset-bottom); /* For iPhone X notch */
        }

        #bottom-nav-bar .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 5px 0;
            color: #8e8e93; /* iOS Gray for inactive text */
            font-size: 0.75rem;
            font-weight: 500; /* Default font weight for nav items */
            text-decoration: none;
            transition: color 0.2s ease, background-color 0.2s ease;
            border-radius: 10px; /* Rounded items */
            margin: 0 4px; /* Small margin between items */
        }

        #bottom-nav-bar .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 3px;
            color: #8e8e93; /* Explicitly set icon color for inactive state */
            transition: color 0.2s ease; /* Add transition for icon color */
        }

        #bottom-nav-bar .nav-item.active {
            background-color: rgba(0, 122, 255, 0.1); /* Default light blue background for active */
            font-weight: 700; /* Bolder for active text */
        }

        /* Specific active colors for each nav item */
        #bottom-nav-bar .nav-item[data-section="home-section"].active {
            color: #007AFF; /* Primary Blue */
        }
        #bottom-nav-bar .nav-item[data-section="home-section"].active i {
            color: #007AFF;
        }

        #bottom-nav-bar .nav-item[data-section="categories-page-section"].active {
            color: #34C759; /* iOS Green */
        }
        #bottom-nav-bar .nav-item[data-section="categories-page-section"].active i {
            color: #34C759;
        }

        #bottom-nav-bar .nav-item[data-section="new-arrivals-section"].active {
            color: #FF3B30; /* Primary Red (Fire) */
        }
        #bottom-nav-bar .nav-item[data-section="new-arrivals-section"].active i {
            color: #FF3B30;
        }

        #bottom-nav-bar .nav-item[data-section="sales-section"].active {
            color: #FF9500; /* Primary Orange */
        }
        #bottom-nav-bar .nav-item[data-section="sales-section"].active i {
            color: #FF9500;
        }

        #bottom-nav-bar .nav-item[data-section="favorites-section"].active {
            color: #FF2D55; /* Pink/Red for Heart */
        }
        #bottom-nav-bar .nav-item[data-section="favorites-section"].active i {
            color: #FF2D55;
        }

        #bottom-nav-bar .nav-item[data-section="my-account-section"].active {
            color: #AF52DE; /* Primary Purple */
        }
        #bottom-nav-bar .nav-item[data-section="my-account-section"].active i {
            color: #AF52DE;
        }


        /* Dark Mode specific active states for bottom nav */
        body.dark-mode #bottom-nav-bar .nav-item.active {
            background-color: rgba(0, 122, 255, 0.3); /* Slightly more opaque in dark mode */
        }
        body.dark-mode #bottom-nav-bar .nav-item[data-section="home-section"].active {
            color: #0A84FF; /* Darker Blue for Dark Mode */
        }
        body.dark-mode #bottom-nav-bar .nav-item[data-section="home-section"].active i {
            color: #0A84FF;
        }

        body.dark-mode #bottom-nav-bar .nav-item[data-section="categories-page-section"].active {
            color: #30D158; /* Darker Green for Dark Mode */
        }
        body.dark-mode #bottom-nav-bar .nav-item[data-section="categories-page-section"].active i {
            color: #30D158;
        }

        body.dark-mode #bottom-nav-bar .nav-item[data-section="new-arrivals-section"].active {
            color: #FF453A; /* Darker Red for Dark Mode */
        }
        body.dark-mode #bottom-nav-bar .nav-item[data-section="new-arrivals-section"].active i {
            color: #FF453A;
        }

        body.dark-mode #bottom-nav-bar .nav-item[data-section="sales-section"].active {
            color: #FF9F0A; /* Darker Orange for Dark Mode */
        }
        body.dark-mode #bottom-nav-bar .nav-item[data-section="sales-section"].active i {
            color: #FF9F0A;
        }

        body.dark-mode #bottom-nav-bar .nav-item[data-section="favorites-section"].active {
            color: #FF375F; /* Darker Pink/Red for Dark Mode */
        }
        body.dark-mode #bottom-nav-bar .nav-item[data-section="favorites-section"].active i {
            color: #FF375F;
        }

        body.dark-mode #bottom-nav-bar .nav-item[data-section="my-account-section"].active {
            color: #BF5AF2; /* Darker Purple for Dark Mode */
        }
        body.dark-mode #bottom-nav-bar .nav-item[data-section="my-account-section"].active i {
            color: #BF5AF2;
        }

        #bottom-nav-bar .nav-item:hover {
            background-color: rgba(0, 122, 255, 0.05);
        }
        body.dark-mode #bottom-nav-bar .nav-item:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }


        /* Dynamic Footer */
        .dynamic-footer {
            background-color: rgba(255, 255, 255, 0.7); /* Translucent white */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 30px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            color: #636366;
            text-align: center;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .dynamic-footer.visible {
            opacity: 1;
            visibility: visible;
        }
        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .footer-content p {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .footer-content a {
            color: #007AFF;
            text-decoration: none;
        }
        .footer-content a:hover {
            text-decoration: underline;
        }
        .footer-social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .footer-social-links a {
            font-size: 1.5rem;
            color: #636366;
            transition: color 0.2s ease;
        }
        .footer-social-links a:hover {
            color: #007AFF;
        }
        .footer-custom-links {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px 20px;
            font-size: 0.85rem;
        }
        .footer-custom-links a {
            color: #007AFF;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                font-size: 0.95rem;
                padding-top: 80px; /* Top bar fixed height */
                padding-bottom: 60px; /* Bottom nav fixed height */
            }
            .header {
                padding: 8px 10px;
                height: 80px; /* Ensure height is consistent on mobile */
            }
            .header h1 {
                font-size: 1.2rem; /* Adjusted for mobile */
            }
            .header h1 i {
                font-size: 1.8rem; /* Adjusted for mobile */
            }
            /* Ensure header nav main is always flex on mobile too */
            .header-nav-main {
                display: flex;
                flex-grow: 1; /* Allow it to take available space */
                justify-content: flex-end; /* Push items to the right */
                gap: 0.5rem; /* Smaller gap on mobile */
            }
            .header-icon-btn, .cart-icon-container {
                padding: 4px 8px; /* Smaller padding for mobile icons */
                font-size: 0.7rem; /* Smaller font size */
            }
            .header-icon-btn i, .cart-icon-container i {
                font-size: 1.2rem; /* Smaller icon size */
                margin-bottom: 2px;
            }

            .search-sort-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 12px;
                margin-bottom: 15px;
            }
            .search-sort-controls input,
            .search-sort-controls select {
                padding: 8px 12px;
                font-size: 0.9rem;
                border-radius: 8px;
            }
            .product-image {
                height: 120px;
            }
            .product-name {
                font-size: 0.9rem;
            }
            .product-price {
                font-size: 1rem;
            }
            .add-to-cart-btn-card {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
            .modal-content {
                padding: 20px;
                border-radius: 12px;
            }
            .modal-content h3 {
                font-size: 1.1rem;
            }
            .modal-content p {
                font-size: 0.9rem;
            }
            #modal-product-price {
                font-size: 1.8rem;
            }
            #add-to-cart-btn, #toggle-favorite-modal-btn {
                font-size: 0.95rem;
                padding: 12px 16px;
                border-radius: 8px;
            }
            .category-button-page {
                height: 110px;
                border-radius: 10px;
            }
            .category-overlay-strip {
                padding: 10px 15px;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
            }
            .category-name-text {
                font-size: 1.05rem;
            }
            .info-button {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            .dynamic-footer {
                border-top-left-radius: 0;
                border-top-right-radius: 0;
            }
        }

        @media (min-width: 769px) {
            /* On larger screens, ensure desktop layout is correct */
            #bottom-nav-bar {
                display: none; /* Hide bottom nav on desktop */
            }
            .header {
                height: 80px; /* Consistent height for desktop */
            }
            .header-nav-main {
                display: flex; /* Show desktop header links */
            }
            body {
                padding-top: 80px; /* Only top header padding */
                padding-bottom: 20px; /* No bottom nav */
            }
            .dynamic-footer {
                position: static; /* Footer is part of normal flow on desktop */
                opacity: 1;
                visibility: visible;
            }
        }
    </style>
</head>
<body>

    <!-- Unified Header (Top Bar) -->
    <header id="main-header" class="header">
        <!-- Store Logo and Name -->
        <h1 id="store-name" class="font-bold flex items-center">
            <i class="fas fa-store ml-3"></i> متجرنا الإلكتروني
        </h1>
        <!-- Main Action Links (Always visible now) -->
        <nav class="header-nav-main">
            <!-- My Orders -->
            <a href="#" class="header-icon-btn" data-section="my-orders-section">
                <i class="fas fa-receipt"></i>
                <span>طلباتي</span>
            </a>
            <!-- Contact Us -->
            <a href="#" class="header-icon-btn" onclick="openContactUsModal(); return false;">
                <i class="fas fa-phone"></i>
                <span>اتصل بنا</span>
            </a>
            <!-- Cart Icon -->
            <div id="cart-icon-container" class="cart-icon-container" onclick="openCartModal()">
                <i class="fas fa-shopping-cart"></i>
                <span>السلة</span>
                <span id="cart-count" class="cart-count relative -top-2 -right-1">0</span>
            </div>
        </nav>
    </header>

    <div class="container">
        <!-- Search and Sort Controls -->
        <div id="search-sort-container" class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col sm:flex-row items-center justify-between gap-4 search-sort-controls hidden">
            <div class="relative w-full sm:flex-grow"> <!-- Changed to flex-grow for search input -->
                <input type="text" id="search-input" placeholder="ابحث عن منتجات..." class="w-full border border-gray-300 rounded-md shadow-sm">
                <div id="search-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden">
                    <!-- Suggestions will be populated here -->
                </div>
            </div>
            <!-- Sort Dropdown with visible label, placed next to search bar in RTL -->
            <div id="sort-by-container" class="w-full sm:w-auto sort-controls-wrapper">
                <label for="sort-by-select" class="block text-sm font-medium text-gray-700 whitespace-nowrap">ترتيب حسب:</label>
                <select id="sort-by-select" class="w-full border border-gray-300 rounded-md shadow-sm bg-white">
                    <option value="default">الترتيب الافتراضي</option>
                    <option value="price-asc">السعر: من الأقل للأعلى</option>
                    <option value="price-desc">السعر: من الأعلى للأقل</option>
                    <option value="quantity-asc">الكمية: من الأقل للأعلى</option>
                    <option value="quantity-desc">الكمية: من الأعلى للأقل</option>
                    <option value="date-desc">التاريخ: الأحدث أولاً</option>
                    <option value="date-asc">التاريخ: الأقدم أولاً</option>
                </select>
            </div>
        </div>

        <!-- Main Banner Section -->
        <section id="main-banner-section" class="store-section hidden mb-8">
            <div id="main-banner-content" class="relative bg-blue-500 rounded-lg overflow-hidden shadow-lg text-white p-6 md:p-10 flex flex-col items-center justify-center text-center">
                <img id="main-banner-image-display" src="https://placehold.co/1200x400/007AFF/FFFFFF?text=Main+Banner" alt="Main Banner" class="absolute inset-0 w-full h-full object-cover opacity-50">
                <div class="relative z-10">
                    <h2 id="main-banner-title-display" class="text-3xl md:text-5xl font-extrabold mb-4">عنوان البانر الرئيسي</h2>
                    <p id="main-banner-description-display" class="text-lg md:text-xl mb-6 max-w-2xl">وصف جذاب للبانر الرئيسي هنا.</p>
                    <a id="main-banner-cta-link-display" href="#" class="inline-block bg-white text-blue-700 font-bold py-3 px-8 rounded-full hover:bg-gray-100 transition duration-300">
                        <span id="main-banner-cta-text-display">تسوق الآن</span> <i class="fas fa-arrow-left mr-2"></i>
                    </a>
                </div>
            </div>
        </section>

        <!-- Featured Categories Section (on homepage) -->
        <section id="homepage-categories-section" class="store-section hidden mb-8">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">أقسام مختارة</h2>
            <div id="homepage-categories-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Selected categories will be loaded here -->
            </div>
        </section>

        <!-- Featured Products Section (on homepage) -->
        <section id="homepage-featured-products-section" class="store-section hidden mb-8">
            <h2 id="homepage-featured-products-title" class="text-3xl font-bold text-gray-800 text-center mb-6">منتجات مميزة</h2>
            <div id="homepage-featured-products-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- Featured products will be loaded here -->
            </div>
        </section>

        <!-- Internal Banners Section -->
        <section id="internal-banners-section" class="store-section hidden mb-8">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">إعلانات خاصة</h2>
            <div id="internal-banners-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Internal banners will be loaded here -->
            </div>
        </section>

        <!-- Customer Reviews Section (Placeholder) -->
        <section id="customer-reviews-section" class="store-section hidden mb-8">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">ماذا يقول عملاؤنا</h2>
            <div class="bg-white p-6 rounded-lg shadow-md text-center text-gray-700">
                <p class="mb-4 text-lg">"تجربة تسوق رائعة! منتجات عالية الجودة وخدمة عملاء ممتازة."</p>
                <p class="font-semibold">- عميل سعيد</p>
                <!-- More reviews could be dynamically loaded here -->
            </div>
        </section>

        <!-- Blog Section (Placeholder) -->
        <section id="blog-section" class="store-section hidden mb-8">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">آخر المقالات والأخبار</h2>
            <div class="bg-white p-6 rounded-lg shadow-md text-gray-700">
                <h3 class="font-bold text-xl mb-2">عنوان المقال الأول</h3>
                <p class="text-sm text-gray-600 mb-3">نشر في: 15 يوليو 2025</p>
                <p class="mb-4">هنا ستجد ملخصاً لأحدث مقالات المدونة أو الأخبار المتعلقة بمتجرنا أو منتجاتنا.</p>
                <a href="#" class="text-blue-700 hover:underline">اقرأ المزيد <i class="fas fa-arrow-left mr-1"></i></a>
            </div>
        </section>

        <!-- Home Section (Main Products Display - now also used for category filtering) -->
        <section id="home-section" class="store-section">
            <div class="flex items-center justify-between mb-6">
                <button id="back-to-categories-btn" class="back-to-home-btn hidden" onclick="showStoreSection('categories-page-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">
                    <span id="home-section-title">منتجاتنا</span>
                    <span id="current-category-name" class="text-blue-700 mr-2 hidden"></span>
                </h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="products-grid-home" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- Products will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">جاري تحميل المنتجات...</div>
            </div>
        </section>

        <!-- Sales Section (العروض) -->
        <section id="sales-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">عروضنا المميزة</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="products-grid-sales" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- Sales products will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">لا توجد عروض حالياً.</div>
            </div>
        </section>

        <!-- New Arrivals Section (الجديد) -->
        <section id="new-arrivals-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">وصل حديثاً</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="products-grid-new-arrivals" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- New arrivals products will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">لا توجد منتجات جديدة حالياً.</div>
            </div>
        </section>

        <!-- Favorites Section -->
        <section id="favorites-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">منتجاتي المفضلة</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="products-grid-favorites" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- Favorite products will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">لم تقم بإضافة أي منتجات إلى المفضلة بعد.</div>
            </div>
        </section>

        <!-- Categories Page Section -->
        <section id="categories-page-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">تصفح الأقسام</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="categories-grid-page" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Categories will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">جاري تحميل الأقسام...</div>
            </div>
        </section>

        <!-- My Account Section -->
        <section id="my-account-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">معلومات حسابي</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="font-bold text-xl text-gray-800 mb-4">معلومات شخصية</h3>
                <div class="flex flex-col items-center mb-4">
                    <img id="profile-picture" class="profile-picture" src="https://placehold.co/100x100/007AFF/FFFFFF?text=User" alt="صورة المستخدم">
                    <p id="profile-display-name" class="font-semibold text-lg text-gray-800"></p>
                    <p id="profile-display-email" class="text-gray-600 text-sm"></p>
                </div>
                <!-- Dark Mode Toggle moved here -->
                <div class="flex justify-center gap-4 mb-4">
                    <button id="dark-mode-toggle-account" class="btn-secondary">
                        <i class="fas fa-moon ml-2"></i> <span>الوضع الليلي</span>
                    </button>
                </div>
                <!-- Google Sign-in/Sign-out buttons -->
                <div class="flex justify-center gap-4 mb-4">
                    <button id="google-sign-in-btn" class="btn-primary">
                        <i class="fab fa-google ml-2"></i> تسجيل الدخول بـ Google
                    </button>
                    <button id="sign-out-btn" class="btn-danger hidden">
                        <i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج
                    </button>
                </div>
                <form id="profile-form" onsubmit="event.preventDefault(); saveUserProfile()" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل</label>
                            <input type="text" id="profile-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="profile-email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                            <input type="email" id="profile-email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div class="md:col-span-2">
                            <label for="profile-phone" class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف</label>
                            <input type="tel" id="profile-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save ml-2"></i> حفظ المعلومات
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="font-bold text-xl text-gray-800 mb-4">عناوين الشحن</h3>
                <div id="shipping-addresses-list" class="space-y-4 mb-4">
                    <!-- Shipping addresses will be loaded here -->
                    <p class="text-center text-gray-500">لا توجد عناوين محفوظة.</p>
                </div>
                <button onclick="openAddressModal()" class="btn-success">
                    <i class="fas fa-plus ml-2"></i> إضافة عنوان جديد
                </button>
            </div>
        </section>

        <!-- My Orders Section -->
        <section id="my-orders-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">طلباتي</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="orders-list" class="space-y-4">
                <!-- Orders will be loaded here by JS -->
                <p class="text-center text-gray-500 py-10">جاري تحميل الطلبات...</p>
            </div>
        </section>

        <!-- Product Details Modal -->
        <div id="product-details-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 id="modal-product-name" class="font-bold text-xl text-gray-800">اسم المنتج</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="product-image">
                            <img id="modal-product-image" src="" alt="Product Image" onerror="this.onerror=null; this.src='https://placehold.co/400x400/007AFF/FFFFFF?text=Product';">
                        </div>
                        <div class="flex items-baseline mb-2 mt-4">
                            <p id="modal-product-price" class="text-3xl font-bold text-blue-700 ml-2">0 د.ع</p>
                            <p id="modal-product-original-price" class="text-lg text-gray-500 line-through hidden">0 د.ع</p>
                        </div>
                        <p id="modal-product-category" class="text-sm text-gray-600 mb-2">القسم: عام</p>
                        <p id="modal-product-inventory" class="text-sm text-gray-600 mb-4">المخزون: متوفر</p>
                    </div>
                    <div>
                        <p id="modal-product-description" class="text-gray-700 leading-relaxed mb-6">وصف المنتج سيظهر هنا.</p>
                        <button id="add-to-cart-btn" class="btn-success">
                            <i class="fas fa-cart-plus ml-3"></i> أضف إلى السلة
                        </button>
                        <button id="toggle-favorite-modal-btn" class="btn-secondary mt-3">
                            <i class="fas fa-heart ml-3"></i> <span id="favorite-text">أضف إلى المفضلة</span>
                        </button>
                        <!-- New AI-powered button -->
                        <button id="enhance-description-btn" class="btn-primary mt-3 w-full">
                            <span id="enhance-description-text">✨ تحسين الوصف بالذكاء الاصطناعي</span>
                            <i id="enhance-description-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button class="close-modal">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>

        <!-- Cart Modal -->
        <div id="cart-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 class="font-bold text-xl text-gray-800">سلة التسوق</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="cart-items-list" class="space-y-4 mb-6 max-h-80 overflow-y-auto">
                    <!-- Cart items will be rendered here -->
                    <p class="text-center text-gray-500 py-4">سلة التسوق فارغة.</p>
                </div>
                <div class="flex justify-between items-center text-lg font-bold text-gray-800 border-t pt-4">
                    <span>الإجمالي الفرعي:</span>
                    <span id="cart-subtotal">0 د.ع</span>
                </div>
                <div class="flex justify-between items-center text-lg font-bold text-gray-800 mt-2">
                    <span>سعر التوصيل:</span>
                    <span id="cart-delivery-price">0 د.ع</span>
                </div>
                <div class="flex justify-between items-center text-2xl font-bold text-blue-700 border-t pt-4 mt-4">
                    <span>الإجمالي الكلي:</span>
                    <span id="cart-total">0 د.ع</span>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button class="close-modal ml-3">
                        متابعة التسوق
                    </button>
                    <button id="proceed-to-checkout-btn" class="btn-primary">
                        <i class="fas fa-money-check-alt ml-2"></i> إتمام الشراء
                    </button>
                </div>
            </div>
        </div>

        <!-- Checkout Modal -->
        <div id="checkout-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 class="font-bold text-xl text-gray-800">إتمام الشراء</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="checkout-form" onsubmit="event.preventDefault(); placeOrder()">
                    <h4 class="font-bold text-lg mb-3">معلومات الشحن</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="checkout-name" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل</label>
                            <input type="text" id="checkout-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="checkout-phone" class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف</label>
                            <input type="tel" id="checkout-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="checkout-address" class="block text-sm font-medium text-gray-700 mb-1">العنوان الكامل</label>
                            <textarea id="checkout-address" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="checkout-notes" class="block text-sm font-medium text-gray-700 mb-1">ملاحظات إضافية (اختياري)</label>
                            <textarea id="checkout-notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                        </div>
                    </div>

                    <h4 class="font-bold text-lg mb-3">طريقة الدفع</h4>
                    <div class="mb-6 p-3 bg-gray-100 rounded-md text-gray-700">
                        <p><i class="fas fa-money-bill-wave ml-2 text-green-600"></i> الدفع عند الاستلام فقط</p>
                    </div>

                    <h4 class="font-bold text-lg mb-3">ملخص الطلب</h4>
                    <div id="checkout-summary-list" class="space-y-2 mb-4 bg-gray-50 p-4 rounded-md max-h-40 overflow-y-auto">
                        <!-- Cart items summary will be rendered here -->
                    </div>
                    <div class="flex justify-between items-center text-md font-medium text-gray-700">
                        <span>الإجمالي الفرعي:</span>
                        <span id="checkout-subtotal">0 د.ع</span>
                    </div>
                    <div class="flex justify-between items-center text-md font-medium text-gray-700 mt-2">
                        <span>سعر التوصيل:</span>
                        <span id="checkout-delivery-price">0 د.ع</span>
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold text-blue-700 border-t pt-4 mt-4">
                        <span>الإجمالي الكلي:</span>
                        <span id="checkout-total">0 د.ع</span>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" class="close-modal ml-3">
                            إلغاء
                        </button>
                        <button type="submit" class="btn-success">
                            <i class="fas fa-check-circle ml-2"></i> تأكيد الطلب
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Contact Us Modal -->
        <div id="contact-us-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-lg">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 class="font-bold text-xl text-gray-800">اتصل بنا</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="text-gray-700 space-y-3">
                    <p class="flex items-center"><i class="fas fa-store ml-3 text-blue-700"></i> <span id="contact-store-name"></span></p>
                    <p class="flex items-center"><i class="fas fa-phone ml-3 text-blue-700"></i> <a id="contact-phone-link" href="#" class="text-blue-700 hover:underline"></a></p>
                    <p class="flex items-center"><i class="fab fa-whatsapp ml-3 text-green-600"></i> <a id="contact-whatsapp-link" href="#" target="_blank" class="text-green-600 hover:underline"></a></p>
                    <p class="flex items-center"><i class="fas fa-envelope ml-3 text-blue-700"></i> <a id="contact-email-link" href="#" class="text-blue-700 hover:underline"></a></p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button class="close-modal">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>

        <!-- Address Modal for Add/Edit -->
        <div id="address-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-md">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 id="address-modal-title" class="font-bold text-xl text-gray-800">إضافة عنوان جديد</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="address-form" onsubmit="event.preventDefault(); saveAddress()">
                    <input type="hidden" id="address-id">
                    <div class="mb-4">
                        <label for="address-label" class="block text-sm font-medium text-gray-700 mb-1">اسم العنوان (مثال: المنزل، العمل)</label>
                        <input type="text" id="address-label" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div class="mb-4">
                        <label for="address-full" class="block text-sm font-medium text-gray-700 mb-1">العنوان الكامل</label>
                        <textarea id="address-full" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" class="close-modal ml-3">
                            إلغاء
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save ml-2"></i> حفظ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Generic Confirmation Modal -->
        <div id="confirm-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-sm text-center">
                <div class="flex justify-center mb-4">
                    <i class="fas fa-question-circle text-yellow-500 text-5xl"></i>
                </div>
                <h3 id="confirm-message" class="font-bold text-xl text-gray-800 mb-4">هل أنت متأكد؟</h3>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-cancel-btn" class="btn-secondary">
                        إلغاء
                    </button>
                    <button id="confirm-ok-btn" class="btn-danger">
                        تأكيد
                    </button>
                </div>
            </div>
        </div>

        <!-- Order Details Modal -->
        <div id="order-details-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 class="font-bold text-xl text-gray-800">تفاصيل الطلب <span id="modal-order-number"></span></h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4 mb-6">
                    <p><strong>تاريخ الطلب:</strong> <span id="modal-order-date"></span></p>
                    <p><strong>الحالة:</strong> <span id="modal-order-status"></span></p>
                    <p><strong>الاسم:</strong> <span id="modal-order-name"></span></p>
                    <p><strong>الهاتف:</strong> <span id="modal-order-phone"></span></p>
                    <p><strong>العنوان:</strong> <span id="modal-order-address"></span></p>
                    <p><strong>ملاحظات:</strong> <span id="modal-order-notes"></span></p>
                    <h4 class="font-bold text-lg mt-4 mb-2">المنتجات:</h4>
                    <div id="modal-order-products-list" class="space-y-2 bg-gray-50 p-3 rounded-md">
                        <!-- Products will be listed here -->
                    </div>
                    <div class="text-right mt-4">
                        <p><strong>الإجمالي الفرعي:</strong> <span id="modal-order-subtotal"></span> د.ع</p>
                        <p><strong>سعر التوصيل:</strong> <span id="modal-order-delivery-price"></span> د.ع</p>
                        <p class="text-xl font-bold text-blue-700"><strong>الإجمالي الكلي:</strong> <span id="modal-order-total"></span> د.ع</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="order-details-contact-support-btn" class="btn-primary">
                        <i class="fas fa-headset ml-2"></i> التواصل مع الدعم
                    </button>
                    <button class="close-modal">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>

        <!-- Category Description Modal -->
        <div id="category-description-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-lg">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 id="modal-category-name" class="font-bold text-xl text-gray-800">اسم القسم</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p id="modal-category-description" class="text-gray-700 leading-relaxed mb-6">وصف القسم سيظهر هنا.</p>
                <div class="mt-6 flex justify-end">
                    <button class="close-modal">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>

        <!-- Sentinel for Footer Visibility -->
        <div id="footer-sentinel" style="height: 1px; margin-top: 50px;"></div>

    </div> <!-- End of container -->

    <!-- Dynamic Footer -->
    <footer id="dynamic-footer" class="dynamic-footer">
        <div class="footer-content">
            <div id="footer-contact-info" class="mb-4">
                <p class="font-bold" id="footer-store-name-info"></p>
                <p id="footer-phone-info"></p>
                <p id="footer-email-info"></p>
            </div>
            <div id="footer-social-links" class="footer-social-links">
                <a id="footer-facebook-link" href="#" target="_blank"><i class="fab fa-facebook"></i></a>
                <a id="footer-instagram-link" href="#" target="_blank"><i class="fab fa-instagram"></i></a>
                <a id="footer-twitter-link" href="#" target="_blank"><i class="fab fa-twitter"></i></a>
                <a id="footer-linkedin-link" href="#" target="_blank"><i class="fab fa-linkedin"></i></a>
            </div>
            <div id="footer-custom-links" class="footer-custom-links">
                <!-- Custom links will be loaded here -->
            </div>
        </div>
    </footer>

    <!-- Bottom Navigation Bar -->
    <nav id="bottom-nav-bar">
        <a href="#" class="nav-item active" data-section="home-section">
            <i class="fas fa-home"></i>
            <span>الرئيسية</span>
        </a>
        <a href="#" class="nav-item" data-section="categories-page-section">
            <i class="fas fa-folder-open"></i>
            <span>الأقسام</span>
        </a>
        <a href="#" class="nav-item" data-section="new-arrivals-section">
            <i class="fas fa-box-open"></i>
            <span>الجديد</span>
        </a>
        <a href="#" class="nav-item" data-section="sales-section">
            <i class="fas fa-fire"></i>
            <span>العروض</span>
        </a>
        <a href="#" class="nav-item" data-section="favorites-section">
            <i class="fas fa-heart"></i>
            <span>المفضلة</span>
        </a>
        <a href="#" class="nav-item" data-section="my-account-section">
            <i class="fas fa-user"></i>
            <span>حسابي</span>
        </a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
        // Firebase Auth and Firestore imports
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAG4EKrB3iLEV2hsB8b08ShpSO6PXDnGjg",
            authDomain: "zio3-8ffdd.firebaseapp.com",
            databaseURL: "https://zio3-8ffdd-default-rtdb.firebaseio.com",
            projectId: "zio3-8ffdd",
            storageBucket: "zio3-8ffdd.firebaseapp.com",
            messagingSenderId: "560939348415",
            appId: "1:560939348415:web:c854e9e214e498ad2d310a",
            measurementId: "G-CVN2B2D0RD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);


        const db = getDatabase(app); // Realtime Database
        const firestoreDb = getFirestore(app); // Firestore Database (still used for addresses)
        const auth = getAuth(app); // Firebase Authentication
        const googleProvider = new GoogleAuthProvider(); // Google Auth Provider

        const productsRef = ref(db, "products");
        const categoriesRef = ref(db, "categories");
        const settingsRef = ref(db, "settings");
        const homepageSettingsRef = ref(db, "homepageSettings");
        const ordersRef = ref(db, "orders");
        const usersProfileRef = ref(db, "users");

        // Global data storage for the store
        window.storeData = {
            products: [],
            categories: [],
            settings: {},
            homepageSettings: {},
            cart: [],
            favorites: [],
            userProfile: null,
            userAddresses: [],
            userOrders: []
        };

        // Global variable to hold the currently displayed products after filtering/searching
        window.currentDisplayedProducts = [];
        window.currentUserId = null;

        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = '7912718787:AAH7QxTF2XMH4O3carYa5yGSqyjGz3n89Tc';
        const TELEGRAM_CHAT_ID = '708957775';

        // Global unsubscribe variables for Firebase listeners
        let unsubscribeUserProfile = null;
        let unsubscribeUserAddresses = null;
        let unsubscribeUserOrders = null;

        /**
         * Renders the user profile details in the 'My Account' section.
         * This function is defined globally to be accessible.
         */
        function renderProfileDetails() {
            const profile = window.storeData.userProfile;
            const profileNameInput = document.getElementById('profile-name');
            const profileEmailInput = document.getElementById('profile-email');
            const profilePhoneInput = document.getElementById('profile-phone');
            const profilePictureElem = document.getElementById('profile-picture');
            const profileDisplayNameElem = document.getElementById('profile-display-name');
            const profileDisplayEmailElem = document.getElementById('profile-display-email');
            const profileForm = document.getElementById('profile-form');


            if (profile) {
                profileNameInput.value = profile.name || '';
                profileEmailInput.value = profile.email || '';
                profilePhoneInput.value = profile.phone || '';

                profilePictureElem.src = profile.photoURL || 'https://placehold.co/100x100/007AFF/FFFFFF?text=User';
                profilePictureElem.onerror = function() { this.onerror=null; this.src='https://placehold.co/100x100/007AFF/FFFFFF?text=User'; };

                profileDisplayNameElem.textContent = profile.name || 'مستخدم غير معروف';
                profileDisplayEmailElem.textContent = profile.email || '';

                const isGoogleUser = auth.currentUser && auth.currentUser.providerData.some(p => p.providerId === 'google.com');

                if (isGoogleUser) {
                    profileEmailInput.readOnly = true;
                    profileNameInput.readOnly = true;
                } else {
                    profileEmailInput.readOnly = false;
                    profileNameInput.readOnly = false;
                }
                profileForm.classList.remove('hidden');
            } else {
                profileNameInput.value = '';
                profileEmailInput.value = '';
                profilePhoneInput.value = '';
                profilePictureElem.src = 'https://placehold.co/100x100/007AFF/FFFFFF?text=User';
                profileDisplayNameElem.textContent = 'الرجاء تسجيل الدخول';
                profileDisplayEmailElem.textContent = '';

                profileForm.classList.add('hidden');
            }
            updateAuthButtons();
        }

        /**
         * Loads user profile from Firebase Realtime Database.
         * @param {object} currentUser - The Firebase Auth user object.
         */
        function loadUserProfile(currentUser) {
            if (!currentUser || !currentUser.uid) {
                console.log("Skipping loadUserProfile: No current user or UID.");
                window.storeData.userProfile = null;
                renderProfileDetails();
                return;
            }
            
            const userProfileNodeRef = ref(db, `users/${currentUser.uid}`);

            unsubscribeUserProfile = onValue(userProfileNodeRef, (snapshot) => {
                let profileData = snapshot.val();
                if (profileData) {
                    window.storeData.userProfile = {
                        uid: currentUser.uid,
                        name: profileData.name || currentUser.displayName || '',
                        email: profileData.email || currentUser.email || '',
                        phone: profileData.phone || '',
                        photoURL: currentUser.photoURL || 'https://placehold.co/100x100/007AFF/FFFFFF?text=User'
                    };
                    console.log("User profile loaded (Realtime DB & Auth):", window.storeData.userProfile);
                } else {
                    console.log("No user profile found in Realtime DB, creating default based on Auth data.");
                    window.storeData.userProfile = {
                        uid: currentUser.uid,
                        name: currentUser.displayName || '',
                        email: currentUser.email || '',
                        phone: '',
                        photoURL: currentUser.photoURL || 'https://placehold.co/100x100/007AFF/FFFFFF?text=User'
                    };
                    set(userProfileNodeRef, { 
                        name: window.storeData.userProfile.name,
                        email: window.storeData.userProfile.email,
                        phone: window.storeData.userProfile.phone
                    }).catch(e => console.error("Error setting default user profile in Realtime DB:", e));
                }
                renderProfileDetails();
            }, (error) => {
                console.error("Error loading user profile (Realtime DB):", error);
                showNotification("خطأ في تحميل معلومات الحساب.", "error");
            });
        }

        // Firebase Authentication Setup
        onAuthStateChanged(auth, async (user) => {
            // Unsubscribe all previous listeners when auth state changes
            if (unsubscribeUserProfile) {
                unsubscribeUserProfile();
                unsubscribeUserProfile = null;
            }
            if (unsubscribeUserAddresses) {
                unsubscribeUserAddresses();
                unsubscribeUserAddresses = null;
            }
            if (unsubscribeUserOrders) {
                unsubscribeUserOrders();
                unsubscribeUserOrders = null;
            }

            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase User ID set:", window.currentUserId);

                // Load/listen when a user is authenticated
                loadUserProfile(user);
                loadUserAddresses();
                loadUserOrders();
            } else {
                // User is signed out, sign in anonymously
                try {
                    const anonymousUserCredential = await signInAnonymously(auth);
                    window.currentUserId = anonymousUserCredential.user.uid;
                    console.log("Signed in anonymously. User ID set:", window.currentUserId);

                    // Load/listen for anonymous user
                    loadUserProfile(anonymousUserCredential.user);
                    loadUserAddresses();
                    loadUserOrders();
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                    showNotification("فشل تسجيل الدخول المجهول. قد لا يتم حفظ بياناتك.", "error");
                }
            }
            updateAuthButtons();
        });

        /**
         * Initiates Google Sign-in.
         */
        window.signInWithGoogle = async function() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                console.log("Google Sign-in successful:", user);
                showNotification("تم تسجيل الدخول بنجاح باستخدام Google!", "success");
            } catch (error) {
                console.error("Error during Google Sign-in:", error);
                const errorCode = error.code;
                const errorMessage = error.message;
                showNotification(`فشل تسجيل الدخول باستخدام Google: ${errorMessage}`, "error");
            }
        };

        /**
         * Signs out the current user.
         */
        window.signOutUser = async function() {
            try {
                await signOut(auth);
                console.log("User signed out.");
                showNotification("تم تسجيل الخروج بنجاح.", "success");
                window.storeData.userProfile = null;
                renderProfileDetails();
            } catch (error) {
                console.error("Error signing out:", error);
                showNotification("فشل تسجيل الخروج.", "error");
            }
        };

        /**
         * Updates the visibility of Google Sign-in and Sign-out buttons.
         */
        function updateAuthButtons() {
            const isGoogleUser = auth.currentUser && auth.currentUser.providerData.some(p => p.providerId === 'google.com');
            
            // Buttons on My Account page
            const googleSignInBtn = document.getElementById('google-sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');

            if (googleSignInBtn && signOutBtn) {
                if (isGoogleUser) {
                    googleSignInBtn.classList.add('hidden');
                    signOutBtn.classList.remove('hidden');
                } else {
                    googleSignInBtn.classList.remove('hidden');
                    signOutBtn.classList.add('hidden');
                }
            }
        }


        // --- Utility Functions ---
        /**
         * Displays a temporary notification message on the screen.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'warning'|'info'} type - The type of notification.
         */
        function showNotification(message, type) {
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) oldNotification.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} ml-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        /**
         * Sends a message to a Telegram bot.
         * @param {string} message - The text message to send.
         */
        async function sendTelegramMessage(message) {
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            const params = {
                chat_id: TELEGRAM_CHAT_ID,
                text: message,
                parse_mode: 'HTML'
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });
                const data = await response.json();
                if (!data.ok) {
                    console.error('Failed to send Telegram message:', data);
                    showNotification('فشل إرسال إشعار Telegram.', 'error');
                } else {
                    console.log('Telegram message sent successfully:', data);
                }
            } catch (error) {
                console.error('Error sending Telegram message:', error);
                showNotification('خطأ في الاتصال بـ Telegram.', "error");
            }
        }

        /**
         * Saves the current cart to localStorage.
         */
        function saveCart() {
            localStorage.setItem('storeCart', JSON.stringify(window.storeData.cart));
            updateCartCount();
        }

        /**
         * Loads the cart from localStorage.
         */
        function loadCart() {
            const storedCart = localStorage.getItem('storeCart');
            if (storedCart) {
                window.storeData.cart = JSON.parse(storedCart);
            }
            updateCartCount();
        }

        /**
         * Updates the cart item count displayed in the header.
         */
        function updateCartCount() {
            const totalItems = window.storeData.cart.reduce((sum, item) => sum + item.quantity, 0);
            
            const headerCartCountElement = document.getElementById('cart-count');
            if (headerCartCountElement) {
                headerCartCountElement.textContent = totalItems;
                if (totalItems > 0) {
                    headerCartCountElement.classList.remove('hidden');
                } else {
                    headerCartCountElement.classList.add('hidden');
                }
            }
        }

        /**
         * Adds a product to the cart or increments its quantity if already present.
         * @param {string} productId - The ID of the product to add.
         */
        window.addToCart = function(productId) {
            console.log("Attempting to add product with ID to cart:", productId);

            const product = window.storeData.products.find(p => p.id === productId);

            if (!product) {
                console.error("Error: Product not found with ID:", productId);
                showNotification("حدث خطأ: لم يتم العثور على المنتج لإضافته إلى السلة.", "error");
                return;
            }

            const existingItemIndex = window.storeData.cart.findIndex(item => item.id === product.id);

            if (existingItemIndex > -1) {
                window.storeData.cart[existingItemIndex].quantity++;
                console.log("Product quantity incremented. Current cart:", window.storeData.cart);
            } else {
                window.storeData.cart.push({ ...product, quantity: 1 });
                console.log("New product added to cart. Current cart:", window.storeData.cart);
            }
            saveCart();
            showNotification(`تمت إضافة "${product.name}" إلى السلة!`, "success");
            if (!document.getElementById('product-details-modal').classList.contains('hidden')) {
                document.getElementById('product-details-modal').classList.add('hidden'); 
            }
        };

        /**
         * Removes a product from the cart or decrements its quantity.
         * @param {string} productId - The ID of the product to modify.
         */
        window.updateCartItemQuantity = function(productId, change) {
            const itemIndex = window.storeData.cart.findIndex(item => item.id === productId);

            if (itemIndex > -1) {
                window.storeData.cart[itemIndex].quantity += change;
                if (window.storeData.cart[itemIndex].quantity <= 0) {
                    window.storeData.cart.splice(itemIndex, 1);
                }
                saveCart();
                renderCart();
            }
        };

        /**
         * Saves the current favorites to localStorage.
         */
        function saveFavorites() {
            localStorage.setItem('storeFavorites', JSON.stringify(window.storeData.favorites));
        }

        /**
         * Loads the favorites from localStorage.
         */
        function loadFavorites() {
            const storedFavorites = localStorage.getItem('storeFavorites');
            if (storedFavorites) {
                window.storeData.favorites = JSON.parse(storedFavorites);
            }
        }

        /**
         * Toggles a product in/out of favorites.
         * @param {string} productId - The ID of the product to toggle.
         */
        window.toggleFavorite = function(productId) {
            const product = window.storeData.products.find(p => p.id === productId);
            if (!product) return;

            const existingFavoriteIndex = window.storeData.favorites.findIndex(id => id === product.id);

            if (existingFavoriteIndex > -1) {
                window.storeData.favorites.splice(existingFavoriteIndex, 1);
                showNotification(`تمت إزالة "${product.name}" من المفضلة.`, "info");
            } else {
                window.storeData.favorites.push(product.id);
                showNotification(`تمت إضافة "${product.name}" إلى المفضلة!`, "success");
            }
            saveFavorites();
            // Re-render relevant sections to update favorite icons
            if (!document.getElementById('favorites-section').classList.contains('hidden')) {
                renderFavorites();
            }
            if (!document.getElementById('product-details-modal').classList.contains('hidden')) {
                updateModalFavoriteButton(productId);
            }
            renderProducts('products-grid-home', 'all');
            renderProducts('products-grid-sales', 'sales');
            renderProducts('products-grid-new-arrivals', 'new-arrivals'); // Update new arrivals section
            renderProducts('homepage-featured-products-grid', 'featured');
        };

        /**
         * Updates the favorite button state in the product details modal.
         * @param {boolean} isFavorited - True if the product is favorited, false otherwise.
         * @param {string} productId - The ID of the product.
         */
        function updateModalFavoriteButton(productId) {
            const toggleFavoriteModalBtn = document.getElementById('toggle-favorite-modal-btn');
            const favoriteText = document.getElementById('favorite-text');
            const isFavorited = window.storeData.favorites.includes(productId);

            if (isFavorited) {
                toggleFavoriteModalBtn.classList.add('active');
                favoriteText.textContent = 'إزالة من المفضلة';
            } else {
                toggleFavoriteModalBtn.classList.remove('active');
                favoriteText.textContent = 'أضف إلى المفضلة';
            }
            toggleFavoriteModalBtn.onclick = () => toggleFavorite(productId);
        }

        /**
         * Opens the product details modal with information for the given product ID.
         * @param {string} productId - The ID of the product to display.
         */
        window.openProductDetailsModal = function(productId) {
            const product = window.storeData.products.find(p => p.id === productId);
            if (!product) {
                console.error("Product not found:", productId);
                showNotification("لم يتم العثور على المنتج.", "error");
                return;
            }
            console.log("Opening product details for:", product);

            document.getElementById('modal-product-name').textContent = product.name || 'اسم المنتج';
            
            const modalImage = document.getElementById('modal-product-image');
            modalImage.src = product.image || 'https://placehold.co/400x400/007AFF/FFFFFF?text=Product';
            modalImage.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x400/007AFF/FFFFFF?text=Image+Not+Found'; };

            document.getElementById('modal-product-price').textContent = `${(product.price || 0).toLocaleString('ar-EG')} د.ع`;
            
            const originalPriceElem = document.getElementById('modal-product-original-price');
            const today = new Date();
            
            const isDiscountSale = product.isSale && product.discountPercentage != null &&
                           new Date(product.saleStartDate) <= today &&
                           new Date(product.saleEndDate) >= today;
            
            const isCustomPriceSale = product.isSale && product.useCustomDiscountPrice && product.customDiscountPrice != null;

            if (isDiscountSale) {
                originalPriceElem.textContent = `${(product.price || 0).toLocaleString('ar-EG')} د.ع`;
                originalPriceElem.classList.remove('hidden');
                document.getElementById('modal-product-price').textContent = `${(product.price * (1 - product.discountPercentage / 100) || 0).toLocaleString('ar-EG')} د.ع`;
            } else if (isCustomPriceSale) {
                originalPriceElem.textContent = `${(product.price || 0).toLocaleString('ar-EG')} د.ع`;
                originalPriceElem.classList.remove('hidden');
                document.getElementById('modal-product-price').textContent = `${(product.customDiscountPrice || 0).toLocaleString('ar-EG')} د.ع`;
            }
            else {
                originalPriceElem.classList.add('hidden');
                document.getElementById('modal-product-price').textContent = `${(product.price || 0).toLocaleString('ar-EG')} د.ع`;
            }

            const category = window.storeData.categories.find(cat => cat.id === product.categoryId);
            document.getElementById('modal-product-category').textContent = `القسم: ${category ? category.name : 'عام'}`;
            document.getElementById('modal-product-inventory').textContent = `المخزون: ${product.inventory > 0 ? 'متوفر' : 'غير متوفر'}`;
            document.getElementById('modal-product-description').innerHTML = (product.description || 'لا يوجد وصف متاح لهذا المنتج.').replace(/\n/g, '<br>');

            const addToCartBtn = document.getElementById('add-to-cart-btn');
            addToCartBtn.onclick = () => addToCart(product.id);
            
            updateModalFavoriteButton(product.id);

            // Set up the AI enhancement button
            const enhanceDescriptionBtn = document.getElementById('enhance-description-btn');
            enhanceDescriptionBtn.onclick = () => enhanceProductDescriptionWithAI(product.id);
            enhanceDescriptionBtn.disabled = false; // Enable button when modal opens
            document.getElementById('enhance-description-text').textContent = '✨ تحسين الوصف بالذكاء الاصطناعي';
            document.getElementById('enhance-description-spinner').classList.add('hidden');


            document.getElementById('product-details-modal').classList.remove('hidden');
        };


        // --- Data Loading Functions ---

        /**
         * Loads store settings from Firebase and updates the UI.
         */
        function loadSettings() {
            onValue(settingsRef, (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    window.storeData.settings = settings;
                    const storeNameElement = document.getElementById('store-name');
                    storeNameElement.innerHTML = `<i class="fas fa-store ml-3"></i> ${settings.storeName || 'متجرنا الإلكتروني'}`;

                    document.getElementById('contact-store-name').textContent = settings.storeName || 'متجرنا الإلكتروني';
                    
                    const contactPhoneLink = document.getElementById('contact-phone-link');
                    contactPhoneLink.textContent = settings.contactPhone || 'N/A';
                    contactPhoneLink.href = `tel:${settings.contactPhone ? settings.contactPhone.replace(/\s/g, '') : ''}`;

                    const contactWhatsappLink = document.getElementById('contact-whatsapp-link');
                    contactWhatsappLink.textContent = settings.contactWhatsapp || 'N/A';
                    contactWhatsappLink.href = `https://wa.me/${settings.contactWhatsapp ? settings.contactWhatsapp.replace(/\s|\+/g, '') : ''}`;

                    const contactEmailLink = document.getElementById('contact-email-link');
                    contactEmailLink.textContent = settings.contactEmail || 'N/A';
                    contactEmailLink.href = `mailto:${settings.contactEmail || ''}`;
                } else {
                    window.storeData.settings = {
                        storeName: "متجرنا الإلكتروني",
                        contactPhone: "+964 782 305 3419",
                        contactWhatsapp: "+964 782 305 3419",
                        contactEmail: "info@zioshop.com",
                        deliveryPricesByCity: [],
                        thankYouMessage: "شكراً لثقتك بنا! سيتواصل معك فريقنا قريباً لتأكيد طلبك."
                    };
                    const storeNameElement = document.getElementById('store-name');
                    storeNameElement.innerHTML = `<i class="fas fa-store ml-3"></i> متجرنا الإلكتروني`;

                    document.getElementById('contact-store-name').textContent = "متجرنا الإلكتروني";
                    document.getElementById('contact-phone-link').textContent = "+964 782 305 3419";
                    document.getElementById('contact-phone-link').href = "tel:+9647823053419";
                    document.getElementById('contact-whatsapp-link').textContent = "+964 782 305 3419";
                    document.getElementById('contact-whatsapp-link').href = "https://wa.me/9647823053419";
                    document.getElementById('contact-email-link').textContent = "info@zioshop.com";
                    document.getElementById('contact-email-link').href = "mailto:info@zioshop.com";
                }
                console.log("Store settings loaded:", window.storeData.settings);
                showNotification("تم تحميل إعدادات المتجر", "info");
            }, (error) => {
                console.error("Error loading settings:", error);
                showNotification("خطأ في تحميل إعدادات المتجر", "error");
            });
        }

        /**
         * Loads homepage settings from Firebase and updates the UI.
         */
        function loadHomepageSettings() {
            onValue(homepageSettingsRef, (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    window.storeData.homepageSettings = settings;
                } else {
                    window.storeData.homepageSettings = {
                        mainBanner: {
                            enabled: true,
                            image: 'https://placehold.co/1200x400/007AFF/FFFFFF?text=Main+Banner', /* Changed color */
                            title: 'عنوان البانر الرئيسي',
                            description: 'وصف جذاب للبانر الرئيسي هنا.',
                            ctaText: 'تسوق الآن',
                            ctaLink: '#'
                        },
                        productCategories: {
                            enabled: true,
                            selectedCategories: []
                        },
                        featuredProducts: {
                            enabled: true,
                            type: 'most_selling'
                        },
                        internalBanners: {
                            enabled: true,
                            banners: [{
                                image: 'https://placehold.co/600x200/007AFF/FFFFFF?text=Internal+Banner+1', /* Changed color */
                                link: '#'
                            }, {
                                image: 'https://placehold.co/600x200/007AFF/FFFFFF?text=Internal+Banner+2', /* Changed color */
                                link: '#'
                            }]
                        },
                        customerReviews: {
                            enabled: true
                        },
                        blog: {
                            enabled: true
                        },
                        footer: {
                            contactEnabled: true,
                            socialEnabled: true,
                            customLinksEnabled: true,
                            facebook: 'https://www.facebook.com/yourstore',
                            instagram: 'https://www.instagram.com/yourstore',
                            twitter: 'https://twitter.com/yourstore',
                            linkedin: 'https://www.linkedin.com/company/yourstore',
                            customLinks: [{
                                text: 'محمد',
                                link: 'https://example.com/mohamed'
                            }, {
                                text: 'رابط الصفحة',
                                link: 'https://example.com/page-link'
                            }]
                        }
                    };
                }
                console.log("Homepage settings loaded:", window.storeData.homepageSettings);
                renderHomepageContent();
                showNotification("تم تحميل إعدادات الصفحة الرئيسية", "info");
            }, (error) => {
                console.error("Error loading homepage settings:", error);
                showNotification("خطأ في تحميل إعدادات الصفحة الرئيسية", "error");
            });
        }


        /**
         * Loads categories from Firebase and updates the category filter buttons.
         */
        function loadCategories() {
            onValue(categoriesRef, (snapshot) => {
                const categories = [];
                snapshot.forEach((childSnapshot) => {
                    categories.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                window.storeData.categories = categories;
                console.log("Categories loaded:", window.storeData.categories);
                renderCategoryFilters();
                renderHomepageContent();
                showNotification("تم تحميل الأقسام", "info");
            }, (error) => {
                console.error("Error loading categories:", error);
                showNotification("خطأ في تحميل الأقسام", "error");
            });
        }

        /**
         * Loads products from Firebase and renders them.
         */
        function loadProducts() {
            onValue(productsRef, (snapshot) => {
                const products = [];
                snapshot.forEach((childSnapshot) => {
                    const product = childSnapshot.val();
                    if (!product.createdAt) {
                        product.createdAt = new Date().toISOString();
                    }
                    products.push({
                        id: childSnapshot.key,
                        ...product
                    });
                });
                window.storeData.products = products;
                console.log("Products loaded. Total products:", window.storeData.products.length, window.storeData.products);
                renderHomepageContent();
                showNotification("تم تحميل المنتجات", "info");
            }, (error) => {
                console.error("Error loading products:", error);
                showNotification("خطأ في تحميل المنتجات", "error");
            });
        }

        // --- Rendering Functions ---

        /**
         * Renders the dynamic content of the homepage based on homepageSettings.
         */
        function renderHomepageContent() {
            const hpSettings = window.storeData.homepageSettings;
            const products = window.storeData.products;
            const categories = window.storeData.categories;
            const today = new Date();

            // Initially hide all homepage sub-sections
            document.getElementById('main-banner-section').classList.add('hidden');
            document.getElementById('homepage-categories-section').classList.add('hidden');
            document.getElementById('homepage-featured-products-section').classList.add('hidden');
            document.getElementById('internal-banners-section').classList.add('hidden');
            document.getElementById('customer-reviews-section').classList.add('hidden');
            document.getElementById('blog-section').classList.add('hidden');
            
            // Ensure the main 'home-section' is visible when rendering homepage content
            document.getElementById('home-section').classList.remove('hidden');
            document.getElementById('home-section-title').textContent = 'منتجاتنا';
            document.getElementById('current-category-name').classList.add('hidden');
            document.getElementById('back-to-categories-btn').classList.add('hidden');


            // --- Render Main Banner ---
            if (hpSettings.mainBanner?.enabled) {
                document.getElementById('main-banner-section').classList.remove('hidden');
                document.getElementById('main-banner-image-display').src = hpSettings.mainBanner.image || 'https://placehold.co/1200x400/007AFF/FFFFFF?text=Main+Banner';
                document.getElementById('main-banner-image-display').onerror = function() { this.onerror=null; this.src='https://placehold.co/1200x400/007AFF/FFFFFF?text=Image+Not+Found'; };
                document.getElementById('main-banner-title-display').textContent = hpSettings.mainBanner.title || '';
                document.getElementById('main-banner-description-display').textContent = hpSettings.mainBanner.description || '';
                document.getElementById('main-banner-cta-text-display').textContent = hpSettings.mainBanner.ctaText || '';
                document.getElementById('main-banner-cta-link-display').href = hpSettings.mainBanner.ctaLink || '#';
            }

            // --- Render Featured Categories ---
            if (hpSettings.productCategories?.enabled && Array.isArray(hpSettings.productCategories.selectedCategories) && hpSettings.productCategories.selectedCategories.length > 0) {
                document.getElementById('homepage-categories-section').classList.remove('hidden');
                const homepageCategoriesGrid = document.getElementById('homepage-categories-grid');
                homepageCategoriesGrid.innerHTML = '';
                const selectedCats = categories.filter(cat => hpSettings.productCategories.selectedCategories.includes(cat.id));
                
                if (selectedCats.length > 0) {
                    selectedCats.forEach(category => {
                        const button = document.createElement('button');
                        button.className = 'category-button-page';
                        button.setAttribute('data-category-id', category.id);
                        button.addEventListener('click', (e) => {
                            if (!e.target.closest('.info-button')) {
                                showStoreSection('home-section'); // Stay on home section but filter products
                                filterProductsByCategory(category.id);
                            }
                        });

                        const mediaHtml = category.image 
                            ? `<img src="${category.image}" alt="${category.name}" onerror="this.onerror=null; this.src='https://placehold.co/300x200/007AFF/FFFFFF?text=Category';" class="category-main-image">`
                            : `<i class="${category.icon || 'fas fa-tag'} category-icon-fallback"></i>`;

                        button.innerHTML = `
                            ${mediaHtml}
                            <div class="category-overlay-strip">
                                <span class="category-name-text">${category.name}</span>
                                <button class="info-button" onclick="openCategoryDescriptionModal('${category.id}')">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        `;
                        homepageCategoriesGrid.appendChild(button);
                    });
                } else {
                    homepageCategoriesGrid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">لا توجد أقسام مختارة للعرض.</div>`;
                }
            }

            // --- Render Featured Products ---
            if (hpSettings.featuredProducts?.enabled) {
                document.getElementById('homepage-featured-products-section').classList.remove('hidden');
                const featuredProductsTitle = document.getElementById('homepage-featured-products-title');
                let productsToDisplay = [];

                switch (hpSettings.featuredProducts.type) {
                    case 'most_selling':
                        featuredProductsTitle.textContent = 'المنتجات الأكثر مبيعاً';
                        productsToDisplay = products.filter(p => p.isFeatured && p.isActive);
                        if (productsToDisplay.length === 0) {
                            productsToDisplay = products.filter(p => p.isActive).slice(0, 8);
                        }
                        break;
                    case 'new_products':
                        featuredProductsTitle.textContent = 'أحدث المنتجات';
                        productsToDisplay = products.filter(p => p.isNew && p.isActive).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 8);
                        if (productsToDisplay.length === 0) {
                            productsToDisplay = products.filter(p => p.isActive).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 8);
                        }
                        break;
                    case 'discounts':
                        featuredProductsTitle.textContent = 'منتجات بخصومات';
                        productsToDisplay = products.filter(p =>
                            p.isSale && p.isActive &&
                            (
                                (p.discountPercentage != null && new Date(p.saleStartDate) <= today && new Date(p.saleEndDate) >= today) ||
                                (p.useCustomDiscountPrice && p.customDiscountPrice != null)
                            )
                        );
                        if (productsToDisplay.length === 0) {
                            productsToDisplay = products.filter(p => p.isActive).slice(0, 8);
                        }
                        break;
                    default:
                        featuredProductsTitle.textContent = 'منتجات مميزة';
                        productsToDisplay = products.filter(p => p.isFeatured && p.isActive);
                        if (productsToDisplay.length === 0) {
                            productsToDisplay = products.filter(p => p.isActive).slice(0, 8);
                        }
                        break;
                }
                renderProducts('homepage-featured-products-grid', 'none', productsToDisplay);
            }

            // --- Render Internal Banners ---
            if (hpSettings.internalBanners?.enabled && Array.isArray(hpSettings.internalBanners.banners) && hpSettings.internalBanners.banners.length > 0) {
                document.getElementById('internal-banners-section').classList.remove('hidden');
                const internalBannersGrid = document.getElementById('internal-banners-grid');
                internalBannersGrid.innerHTML = '';
                hpSettings.internalBanners.banners.forEach(banner => {
                    if (banner.image) {
                        const bannerHtml = `
                            <a href="${banner.link || '#'}" class="block rounded-lg overflow-hidden shadow-md hover:shadow-lg transition duration-300">
                                <img src="${banner.image}" alt="Internal Banner" class="w-full h-auto object-cover" onerror="this.onerror=null; this.src='https://placehold.co/600x200/007AFF/FFFFFF?text=Internal+Banner';">
                            </a>
                        `;
                        internalBannersGrid.insertAdjacentHTML('beforeend', bannerHtml);
                    }
                });
            }

            // --- Render Customer Reviews ---
            if (hpSettings.customerReviews?.enabled) {
                document.getElementById('customer-reviews-section').classList.remove('hidden');
            }

            // --- Render Blog Section ---
            if (hpSettings.blog?.enabled) {
                document.getElementById('blog-section').classList.remove('hidden');
            }

            // --- Render Dynamic Footer Content (not visibility) ---
            const footerContactInfo = document.getElementById('footer-contact-info');
            const footerSocialLinks = document.getElementById('footer-social-links');
            const footerCustomLinks = document.getElementById('footer-custom-links');

            if (hpSettings.footer?.contactEnabled) {
                footerContactInfo.classList.remove('hidden');
                document.getElementById('footer-store-name-info').textContent = window.storeData.settings.storeName || '';
                document.getElementById('footer-phone-info').textContent = window.storeData.settings.contactPhone || '';
                document.getElementById('footer-email-info').textContent = window.storeData.settings.contactEmail || '';
            } else {
                footerContactInfo.classList.add('hidden');
            }

            if (hpSettings.footer?.socialEnabled) {
                footerSocialLinks.classList.remove('hidden');
                const facebookLink = document.getElementById('footer-facebook-link');
                const instagramLink = document.getElementById('footer-instagram-link');
                const twitterLink = document.getElementById('footer-twitter-link');
                const linkedinLink = document.getElementById('footer-linkedin-link');

                facebookLink.href = hpSettings.footer.facebook || '#';
                facebookLink.classList.toggle('hidden', !hpSettings.footer.facebook);
                instagramLink.href = hpSettings.footer.instagram || '#';
                instagramLink.classList.toggle('hidden', !hpSettings.footer.instagram);
                twitterLink.href = hpSettings.footer.twitter || '#';
                twitterLink.classList.toggle('hidden', !hpSettings.footer.twitter);
                linkedinLink.href = hpSettings.footer.linkedin || '#';
                linkedinLink.classList.toggle('hidden', !hpSettings.footer.linkedin);
            } else {
                footerSocialLinks.classList.add('hidden');
            }

            if (hpSettings.footer?.customLinksEnabled && Array.isArray(hpSettings.footer.customLinks) && hpSettings.footer.customLinks.length > 0) {
                footerCustomLinks.classList.remove('hidden');
                footerCustomLinks.innerHTML = '';
                hpSettings.footer.customLinks.forEach(link => {
                    if (link.text && link.text.trim() !== '') {
                        const linkHref = (link.link && link.link.trim() !== '') ? link.link : '#';
                        const linkElement = `<a href="${linkHref}">${link.text}</a>`;
                        footerCustomLinks.insertAdjacentHTML('beforeend', linkElement);
                    }
                });
            } else {
                footerCustomLinks.classList.add('hidden');
                footerCustomLinks.innerHTML = '';
            }
        }


        /**
         * Renders category buttons into the dedicated categories page.
         * @param {Array} [categoriesToRender=null] - Optional array of categories to render (e.g., after search).
         */
        function renderCategoryFilters(categoriesToRender = null) {
            const categoriesGridPage = document.getElementById('categories-grid-page');
            categoriesGridPage.innerHTML = '';

            const displayCategories = categoriesToRender || window.storeData.categories;

            if (displayCategories.length > 0) {
                displayCategories.forEach((category) => {
                    const button = document.createElement('button');
                    button.className = 'category-button-page';
                    button.setAttribute('data-category-id', category.id);
                    button.addEventListener('click', (e) => {
                        if (!e.target.closest('.info-button')) {
                            showStoreSection('home-section'); // Stay on home section but filter products
                            filterProductsByCategory(category.id);
                        }
                    });

                    const mediaHtml = category.image 
                        ? `<img src="${category.image}" alt="${category.name}" onerror="this.onerror=null; this.src='https://placehold.co/300x200/007AFF/FFFFFF?text=Category';" class="category-main-image">`
                        : `<i class="${category.icon || 'fas fa-tag'} category-icon-fallback"></i>`;

                    button.innerHTML = `
                        ${mediaHtml}
                        <div class="category-overlay-strip">
                            <span class="category-name-text">${category.name}</span>
                            <button class="info-button" onclick="openCategoryDescriptionModal('${category.id}')">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    `;
                    categoriesGridPage.appendChild(button);
                });
            } else {
                categoriesGridPage.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">لا توجد أقسام متاحة حالياً.</div>`;
            }
        }

        /**
         * Opens the category description modal.
         * @param {string} categoryId - The ID of the category whose description to display.
         */
        window.openCategoryDescriptionModal = function(categoryId) {
            const category = window.storeData.categories.find(c => c.id === categoryId);
            if (!category) {
                showNotification("لم يتم العثور على وصف القسم.", "error");
                return;
            }

            document.getElementById('modal-category-name').textContent = category.name || 'اسم القسم';
            document.getElementById('modal-category-description').innerHTML = (category.description || 'لا يوجد وصف متاح لهذا القسم.').replace(/\n/g, '<br>');
            document.getElementById('category-description-modal').classList.remove('hidden');
        };


        /**
         * Renders products into a specific grid, optionally filtered or from a provided array.
         * @param {string} gridId - The ID of the product grid to render into (e.g., 'products-grid-home').
         * @param {string} filterType - 'all', 'sales', 'new-arrivals', 'favorites', 'featured' or a categoryId.
         * @param {Array} [productsToRender=null] - Optional array of products to render directly (e.g., after search or sort).
         */
        function renderProducts(gridId, filterType, productsToRender = null) {
            const productsGrid = document.getElementById(gridId);
            if (!productsGrid) {
                console.warn(`Product grid with ID "${gridId}" not found.`);
                return;
            }

            let displayProducts = productsToRender;

            if (!displayProducts) {
                const today = new Date();
                if (filterType === 'all') {
                    displayProducts = window.storeData.products.filter(p => p.isActive);
                } else if (filterType === 'sales') {
                    // Products that are on sale (general offers)
                    displayProducts = window.storeData.products.filter(p =>
                        p.isActive && p.isSale && 
                        (
                            (p.discountPercentage != null && new Date(p.saleStartDate) <= today && new Date(p.saleEndDate) >= today) ||
                            (p.useCustomDiscountPrice && p.customDiscountPrice != null)
                        )
                    );
                } else if (filterType === 'new-arrivals') {
                    // Products with a discount percentage or custom discount price
                    displayProducts = window.storeData.products.filter(p => p.isNew && p.isActive).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                    if (displayProducts.length === 0 && window.storeData.products.length > 0) {
                        displayProducts = window.storeData.products.filter(p => p.isActive).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)).slice(0, 10);
                    }
                } else if (filterType === 'favorites') {
                    displayProducts = window.storeData.products.filter(p => p.isActive && window.storeData.favorites.includes(p.id));
                } else if (filterType === 'featured') {
                    displayProducts = window.storeData.products.filter(p => p.isFeatured && p.isActive);
                }
                else {
                    displayProducts = window.storeData.products.filter(p => p.isActive && p.categoryId === filterType);
                }
            }

            window.currentDisplayedProducts = [...displayProducts];

            let html = '';
            if (displayProducts.length === 0) {
                let message = '';
                if (filterType === 'sales') message = 'لا توجد عروض حالياً.';
                else if (filterType === 'new-arrivals') message = 'لا توجد منتجات جديدة حالياً.';
                else if (filterType === 'favorites') message = 'لم تقم بإضافة أي منتجات إلى المفضلة بعد.';
                else if (filterType === 'all' || filterType === 'none' || filterType === 'featured') message = 'لا توجد منتجات حالياً.';
                else message = 'لا توجد منتجات في هذا القسم حالياً.';

                html = `<div class="col-span-full text-center py-10 text-gray-500">${message}</div>`;
            } else {
                displayProducts.forEach(product => {
                    const today = new Date();
                    
                    const isDiscountSale = product.isSale && product.discountPercentage != null &&
                                   new Date(product.saleStartDate) <= today &&
                                  new Date(product.saleEndDate) >= today;
                    const isCustomPriceSale = product.isSale && product.useCustomDiscountPrice && product.customDiscountPrice != null;

                    let displayPrice = product.price;
                    let originalPriceHtml = '';

                    if (isDiscountSale) {
                        displayPrice = product.price * (1 - product.discountPercentage / 100);
                        originalPriceHtml = `<span class="product-original-price">${(product.price || 0).toLocaleString('ar-EG')} د.ع</span>`;
                    } else if (isCustomPriceSale) {
                        displayPrice = product.customDiscountPrice;
                        originalPriceHtml = `<span class="product-original-price">${(product.price || 0).toLocaleString('ar-EG')} د.ع</span>`;
                    }

                    const isFavorited = window.storeData.favorites.includes(product.id);
                    const favoriteIconClass = isFavorited ? 'fas fa-heart active' : 'far fa-heart';

                    html += `
                    <div class="product-card">
                        <button class="favorite-toggle-btn ${isFavorited ? 'active' : ''}" data-product-id="${product.id}">
                            <i class="${favoriteIconClass}"></i>
                        </button>
                        <div class="product-image" data-product-id="${product.id}">
                            <img src="${product.image || 'https://placehold.co/400x400/007AFF/FFFFFF?text=Product'}" alt="${product.name || 'Product Image'}" onerror="this.onerror=null; this.src='https://placehold.co/400x400/007AFF/FFFFFF?text=Image+Not+Found';">
                        </div>
                        <div class="product-info" data-product-id="${product.id}">
                            <div>
                                <h3 class="product-name">${product.name || 'منتج غير معروف'}</h3>
                                <p class="text-sm text-gray-500 mb-2">${product.category || 'عام'}</p>
                                <p class="text-sm text-gray-600">المخزون: ${product.inventory != null ? product.inventory : 'غير متوفر'}</p>
                            </div>
                            <div class="flex items-baseline justify-end mt-auto">
                                ${originalPriceHtml}
                                <p class="product-price">${(displayPrice || 0).toLocaleString('ar-EG')} د.ع</p>
                            </div>
                        </div>
                        <div class="p-3 pt-0">
                            <button class="add-to-cart-btn-card">
                                <i class="fas fa-cart-plus ml-2"></i> أضف للسلة
                            </button>
                        </div>
                    </div>
                    `;
                });
            }
            productsGrid.innerHTML = html;

            productsGrid.querySelectorAll('.add-to-cart-btn-card').forEach(button => {
                button.addEventListener('click', function(event) {
                    console.log("Add to cart button on card clicked for product ID:", this.closest('.product-card').querySelector('.product-image').dataset.productId);
                    event.stopPropagation();
                    const productId = this.closest('.product-card').querySelector('.product-image').dataset.productId;
                    window.addToCart(productId);
                });
            });

            productsGrid.querySelectorAll('.product-image, .product-info').forEach(element => {
                element.addEventListener('click', function() {
                    const productId = this.dataset.productId;
                    window.openProductDetailsModal(productId);
                });
            });

            productsGrid.querySelectorAll('.favorite-toggle-btn').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const productId = this.dataset.productId;
                    window.toggleFavorite(productId);
                });
            });
        }

        /**
         * Filters products displayed on the home page by category.
         * @param {string} categoryId - The ID of the category to filter by.
         */
        function filterProductsByCategory(categoryId) {
            const category = window.storeData.categories.find(cat => cat.id === categoryId);
            const homeSectionTitle = document.getElementById('home-section-title');
            const currentCategoryName = document.getElementById('current-category-name');
            const backToCategoriesBtn = document.getElementById('back-to-categories-btn');

            // Hide all homepage specific sections when filtering by category
            document.getElementById('main-banner-section').classList.add('hidden');
            document.getElementById('homepage-categories-section').classList.add('hidden');
            document.getElementById('homepage-featured-products-section').classList.add('hidden');
            document.getElementById('internal-banners-section').classList.add('hidden');
            document.getElementById('customer-reviews-section').classList.add('hidden');
            document.getElementById('blog-section').classList.add('hidden');
            document.getElementById('home-section').classList.remove('hidden'); // Ensure home section is visible for product display


            if (category) {
                homeSectionTitle.textContent = 'منتجات القسم:';
                currentCategoryName.textContent = category.name;
                currentCategoryName.classList.remove('hidden');
                backToCategoriesBtn.classList.remove('hidden');
            } else {
                homeSectionTitle.textContent = 'منتجاتنا';
                currentCategoryName.classList.add('hidden');
                backToCategoriesBtn.classList.add('hidden');
            }
            renderProducts('products-grid-home', categoryId);
        }

        /**
         * Shows a specific store section and updates the navigation links.
         * @param {string} sectionId - The ID of the section to show (e.g., 'home-section', 'sales-section').
         * @param {Array} [itemsToDisplay=null] - Optional array of items to render directly (e.g., after search).
         */
        window.showStoreSection = function(sectionId, itemsToDisplay = null) {
            document.querySelectorAll('.store-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active state for bottom navigation bar
            document.querySelectorAll('#bottom-nav-bar .nav-item').forEach(link => {
                link.classList.remove('active');
            });
            const bottomNavLink = document.querySelector(`#bottom-nav-bar .nav-item[data-section="${sectionId}"]`);
            if (bottomNavLink) {
                bottomNavLink.classList.add('active');
            }

            if (sectionId === 'my-account-section') {
                renderProfileDetails(); // Call the defined function
                loadUserAddresses();
            } else if (sectionId === 'my-orders-section') {
                loadUserOrders();
            }


            const searchSortContainer = document.getElementById('search-sort-container');
            const sortByContainer = document.getElementById('sort-by-container');
            const searchInput = document.getElementById('search-input');

            searchInput.value = '';
            searchSuggestionsDiv.classList.add('hidden');

            if (sectionId === 'categories-page-section') {
                searchSortContainer.classList.remove('hidden');
                sortByContainer.classList.add('hidden');
                searchInput.placeholder = 'ابحث عن قسم...';
                renderCategoryFilters();
            } else if (['home-section', 'sales-section', 'new-arrivals-section', 'favorites-section'].includes(sectionId)) {
                searchSortContainer.classList.remove('hidden');
                sortByContainer.classList.remove('hidden');
                searchInput.placeholder = 'ابحث عن منتجات...';
            } else {
                searchSortContainer.classList.add('hidden');
            }

            const homeSectionTitle = document.getElementById('home-section-title');
            const currentCategoryName = document.getElementById('current-category-name');
            const backToCategoriesBtn = document.getElementById('back-to-categories-btn');

            if (sectionId === 'home-section') {
                // When home section is active, show homepage specific content
                renderHomepageContent();
                // If there are specific items to display (e.g., from search), override default homepage content
                if (itemsToDisplay) {
                    document.getElementById('main-banner-section').classList.add('hidden');
                    document.getElementById('homepage-categories-section').classList.add('hidden');
                    document.getElementById('homepage-featured-products-section').classList.add('hidden');
                    document.getElementById('internal-banners-section').classList.add('hidden');
                    document.getElementById('customer-reviews-section').classList.add('hidden');
                    document.getElementById('blog-section').classList.add('hidden');

                    renderProducts('products-grid-home', 'none', itemsToDisplay);
                    homeSectionTitle.textContent = 'نتائج البحث';
                    currentCategoryName.classList.add('hidden');
                    backToCategoriesBtn.classList.remove('hidden');
                } else if (!currentCategoryName.classList.contains('hidden') && currentCategoryName.textContent && currentCategoryName.textContent !== 'منتجاتنا') {
                    // If returning to home from a specific category, maintain that filter
                    const category = window.storeData.categories.find(cat => cat.name === currentCategoryName.textContent);
                    if (category) {
                        renderProducts('products-grid-home', category.id);
                    } else {
                        // Fallback to full homepage content if category not found
                        renderHomepageContent();
                    }
                } else {
                    // Default home view
                    renderHomepageContent();
                }
            } else if (sectionId === 'sales-section') {
                renderProducts('products-grid-sales', 'sales');
            } else if (sectionId === 'new-arrivals-section') {
                renderProducts('products-grid-new-arrivals', 'new-arrivals');
            } else if (sectionId === 'favorites-section') {
                renderFavorites();
            }
        };

        /**
         * Renders the items currently in the cart.
         */
        function renderCart() {
            const cartItemsList = document.getElementById('cart-items-list');
            let html = '';
            let subtotal = 0;

            if (window.storeData.cart.length === 0) {
                html = `<p class="text-center text-gray-500 py-4">سلة التسوق فارغة.</p>`;
                document.getElementById('proceed-to-checkout-btn').disabled = true;
                document.getElementById('proceed-to-checkout-btn').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                window.storeData.cart.forEach(item => {
                    const today = new Date();
                    const isDiscountSale = item.isSale && item.discountPercentage != null &&
                                   new Date(item.saleStartDate) <= today &&
                                   new Date(item.saleEndDate) >= today;
                    const isCustomPriceSale = item.isSale && item.useCustomDiscountPrice && item.customDiscountPrice != null;

                    let itemDisplayPrice = item.price;
                    if (isDiscountSale) {
                        itemDisplayPrice = item.price * (1 - item.discountPercentage / 100);
                    } else if (isCustomPriceSale) {
                        itemDisplayPrice = item.customDiscountPrice;
                    }

                    const itemTotalPrice = itemDisplayPrice * item.quantity;
                    subtotal += itemTotalPrice;

                    html += `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <img src="${item.image || 'https://placehold.co/50x50/007AFF/FFFFFF?text=Item'}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md ml-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${item.name}</h4>
                                <p class="text-sm text-gray-600">${(itemDisplayPrice || 0).toLocaleString('ar-EG')} د.ع</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button onclick="updateCartItemQuantity('${item.id}', -1)" class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-300">-</button>
                            <span class="mx-2 text-lg font-medium">${item.quantity}</span>
                            <button onclick="updateCartItemQuantity('${item.id}', 1)" class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-300">+</button>
                            <button onclick="updateCartItemQuantity('${item.id}', -${item.quantity})" class="text-red-600 hover:text-red-800 mr-3">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    `;
                });
                document.getElementById('proceed-to-checkout-btn').disabled = false;
                document.getElementById('proceed-to-checkout-btn').classList.remove('opacity-50', 'cursor-not-allowed');
            }
            cartItemsList.innerHTML = html;

            let deliveryPrice = 0;
            if (window.storeData.settings.deliveryPricesByCity && window.storeData.settings.deliveryPricesByCity.length > 0) {
                deliveryPrice = window.storeData.settings.deliveryPricesByCity[0]?.price || 0;
            } else {
                deliveryPrice = 5000;
            }

            const total = subtotal + deliveryPrice;

            document.getElementById('cart-subtotal').textContent = `${subtotal.toLocaleString('ar-EG')} د.ع`;
            document.getElementById('cart-delivery-price').textContent = `${deliveryPrice.toLocaleString('ar-EG')} د.ع`;
            document.getElementById('cart-total').textContent = `${total.toLocaleString('ar-EG')} د.ع`;
        }

        /**
         * Opens the cart modal.
         */
        window.openCartModal = function() {
            renderCart();
            document.getElementById('cart-modal').classList.remove('hidden');
        };

        /**
         * Opens the checkout modal and populates it with order summary.
         */
        window.openCheckoutModal = function() {
            let subtotal = 0;
            const today = new Date();

            window.storeData.cart.forEach(item => {
                const isDiscountSale = item.isSale && item.discountPercentage != null &&
                               new Date(item.saleStartDate) <= today &&
                               new Date(item.saleEndDate) >= today;
                const isCustomPriceSale = item.isSale && item.useCustomDiscountPrice && item.customDiscountPrice != null;

                let itemDisplayPrice = item.price;
                if (isDiscountSale) {
                    itemDisplayPrice = item.price * (1 - item.discountPercentage / 100);
                } else if (isCustomPriceSale) {
                    itemDisplayPrice = item.customDiscountPrice;
                }
                subtotal += (itemDisplayPrice * item.quantity);
            });
            
            let deliveryPrice = 0;
            // The `address` variable is not defined here. It should be retrieved from the checkout form.
            // For now, using a default or the first delivery price if available.
            if (window.storeData.settings.deliveryPricesByCity && window.storeData.settings.deliveryPricesByCity.length > 0) {
                // If you want to dynamically set delivery price based on city, you'd need to get the city from the address input.
                // For simplicity, let's just use the first available delivery price or a default.
                deliveryPrice = window.storeData.settings.deliveryPricesByCity[0]?.price || 5000;
            } else {
                deliveryPrice = 5000;
            }
            
            const total = subtotal + deliveryPrice;

            const checkoutSummaryList = document.getElementById('checkout-summary-list');
            let summaryHtml = '';
            if (window.storeData.cart.length === 0) {
                summaryHtml = `<p class="text-center text-gray-500 py-4">سلة التسوق فارغة.</p>`;
            } else {
                window.storeData.cart.forEach(item => {
                    const isDiscountSale = item.isSale && item.discountPercentage != null &&
                                   new Date(item.saleStartDate) <= today &&
                                   new Date(item.saleEndDate) >= today;
                    const isCustomPriceSale = item.isSale && item.useCustomDiscountPrice && item.customDiscountPrice != null;

                    let itemDisplayPrice = item.price;
                    if (isDiscountSale) {
                        itemDisplayPrice = item.price * (1 - item.discountPercentage / 100);
                    } else if (isCustomPriceSale) {
                        itemDisplayPrice = item.customDiscountPrice;
                    }
                    summaryHtml += `
                        <li class="flex justify-between">
                            <span>${item.name} (x${item.quantity})</span>
                            <span>${(itemDisplayPrice * item.quantity).toLocaleString('ar-EG')} د.ع</span>
                        </li>
                    `;
                });
            }
            checkoutSummaryList.innerHTML = summaryHtml;

            document.getElementById('checkout-subtotal').textContent = `${subtotal.toLocaleString('ar-EG')} د.ع`;
            document.getElementById('checkout-delivery-price').textContent = `${deliveryPrice.toLocaleString('ar-EG')} د.ع`;
            document.getElementById('checkout-total').textContent = `${total.toLocaleString('ar-EG')} د.ع`;

            document.getElementById('cart-modal').classList.add('hidden');
            document.getElementById('checkout-modal').classList.remove('hidden');
        };

        /**
         * Simulates placing an order. In a real app, this would send data to Firebase.
         */
        window.placeOrder = async function() {
            const name = document.getElementById('checkout-name').value.trim();
            const phone = document.getElementById('checkout-phone').value.trim();
            const address = document.getElementById('checkout-address').value.trim();
            const notes = document.getElementById('checkout-notes').value.trim();

            if (!name || !phone || !address) {
                showNotification("يرجى ملء جميع الحقول المطلوبة (الاسم، الهاتف، العنوان).", "error");
                return;
            }

            if (window.storeData.cart.length === 0) {
                showNotification("سلة التسوق فارغة، لا يمكن إتمام الطلب.", "error");
                return;
            }

            let subtotal = 0;
            const today = new Date();
            const productsForOrder = window.storeData.cart.map(item => {
                const isDiscountSale = item.isSale && item.discountPercentage != null &&
                               new Date(item.saleStartDate) <= today &&
                               new Date(item.saleEndDate) >= today;
                const isCustomPriceSale = item.isSale && item.useCustomDiscountPrice && item.customDiscountPrice != null;

                let itemPrice = item.price;
                if (isDiscountSale) {
                    itemPrice = item.price * (1 - item.discountPercentage / 100);
                } else if (isCustomPriceSale) {
                    itemPrice = item.customDiscountPrice;
                }
                subtotal += (itemPrice * item.quantity);
                return {
                    id: item.id,
                    name: item.name,
                    quantity: item.quantity,
                    price: itemPrice
                };
            });

            let deliveryPrice = 0;
            if (window.storeData.settings.deliveryPricesByCity && window.storeData.settings.deliveryPricesByCity.length > 0) {
                const matchedCity = window.storeData.settings.deliveryPricesByCity.find(city => address.toLowerCase().includes(city.city.toLowerCase()));
                deliveryPrice = matchedCity ? matchedCity.price : window.storeData.settings.deliveryPricesByCity[0]?.price || 5000;
            } else {
                deliveryPrice = 5000;
            }
            
            const total = subtotal + deliveryPrice;

            const invoiceNumber = Math.floor(10000 + Math.random() * 90000);

            const orderData = {
                invoiceNumber: invoiceNumber,
                userId: window.currentUserId,
                name,
                phone,
                address,
                notes,
                products: productsForOrder,
                subtotal,
                deliveryPrice,
                total,
                status: "جديد",
                createdAt: new Date().toLocaleString('ar-EG')
            };

            try {
                await push(ordersRef, orderData);
                showNotification(window.storeData.settings.thankYouMessage || "تم تأكيد طلبك بنجاح! شكراً لك.", "success");
                
                let telegramMessage = `<b>طلب جديد!</b>\n\n`;
                telegramMessage += `<b>رقم الفاتورة:</b> ${invoiceNumber}\n`;
                telegramMessage += `<b>الاسم:</b> ${name}\n`;
                telegramMessage += `<b>الهاتف:</b> ${phone}\n`;
                telegramMessage += `<b>العنوان:</b> ${address}\n`;
                if (notes) {
                    telegramMessage += `<b>ملاحظات:</b> ${notes}\n`;
                }
                telegramMessage += `\n<b>المنتجات:</b>\n`;
                productsForOrder.forEach(item => {
                    telegramMessage += `- ${item.name} (الكمية: ${item.quantity}) - السعر: ${(item.price || 0).toLocaleString('ar-EG')} د.ع\n`;
                });
                telegramMessage += `\n<b>الإجمالي الفرعي:</b> ${subtotal.toLocaleString('ar-EG')} د.ع\n`;
                telegramMessage += `<b>سعر التوصيل:</b> ${deliveryPrice.toLocaleString('ar-EG')} د.ع\n`;
                telegramMessage += `<b>الإجمالي الكلي:</b> ${total.toLocaleString('ar-EG')} د.ع\n`;
                telegramMessage += `<b>تاريخ الطلب:</b> ${orderData.createdAt}\n`;

                await sendTelegramMessage(telegramMessage);

                window.storeData.cart = [];
                saveCart();
                document.getElementById('checkout-modal').classList.add('hidden');
                document.getElementById('checkout-form').reset();
            } catch (error) {
                console.error("Error placing order:", error);
                showNotification("حدث خطأ أثناء تأكيد الطلب. يرجى المحاولة مرة أخرى.", "error");
            }
        };

        /**
         * Renders products marked as favorites.
         */
        function renderFavorites() {
            renderProducts('products-grid-favorites', 'favorites');
        }

        // Custom Confirmation Modal Logic
        let confirmCallback = null;

        function showConfirmModal(message, onConfirmCallback) {
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessageElem = document.getElementById('confirm-message');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            confirmMessageElem.textContent = message;
            confirmCallback = onConfirmCallback;

            confirmOkBtn.onclick = null;
            confirmCancelBtn.onclick = null;

            confirmOkBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                if (confirmCallback) {
                    confirmCallback(true);
                }
            };

            confirmCancelBtn.onclick = () => {
                confirmModal.classList.add('hidden');
                if (confirmCallback) {
                    confirmCallback(false);
                }
            };

            confirmModal.classList.remove('hidden');
        }

        window.saveUserProfile = async function() {
            if (!window.currentUserId) {
                showNotification("يرجى تسجيل الدخول لحفظ ملفك الشخصي.", "warning");
                console.log("SaveUserProfile: No currentUserId, returning.");
                return;
            }
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const phone = document.getElementById('profile-phone').value.trim();

            console.log("SaveUserProfile: Attempting to save data for userId:", window.currentUserId);
            console.log("Data to save:", { name, email, phone });

            const userProfileNodeRef = ref(db, `users/${window.currentUserId}`);
            try {
                const updateData = {};
                if (!document.getElementById('profile-name').readOnly) {
                    updateData.name = name;
                }
                if (!document.getElementById('profile-email').readOnly) {
                    updateData.email = email;
                }
                updateData.phone = phone;

                await set(userProfileNodeRef, updateData);
                
                if (window.storeData.userProfile) {
                    if (updateData.name !== undefined) window.storeData.userProfile.name = updateData.name;
                    if (updateData.email !== undefined) window.storeData.userProfile.email = updateData.email;
                    window.storeData.userProfile.phone = updateData.phone;
                }
                
                showNotification("تم حفظ معلومات الحساب بنجاح!", "success");
                console.log("SaveUserProfile: Profile saved successfully.");
            } catch (error) {
                console.error("Error saving user profile:", error);
                showNotification("خطأ في حفظ معلومات الحساب.", "error");
            }
        };


        function loadUserAddresses() {
            if (!window.currentUserId) {
                console.log("Skipping loadUserAddresses: No user ID.");
                return;
            }
            const addressesCollectionRef = collection(firestoreDb, "users", window.currentUserId, "addresses");
            unsubscribeUserAddresses = onSnapshot(addressesCollectionRef, (snapshot) => {
                const addresses = [];
                snapshot.forEach(doc => {
                    addresses.push({ id: doc.id, ...doc.data() });
                });
                window.storeData.userAddresses = addresses;
                console.log("User addresses loaded:", window.storeData.userAddresses);
                renderAddresses();
            }, (error) => {
                console.error("Error loading user addresses:", error);
                if (error.code === 'unavailable') {
                    console.warn("Firestore: Client is offline. User addresses will be loaded from cache if available.");
                    showNotification("لا يوجد اتصال بالإنترنت. سيتم تحميل العناوين من الذاكرة المؤقتة.", "warning");
                } else {
                    showNotification("خطأ في تحميل العناوين.", "error");
                }
            });
        }

        function renderAddresses() {
            const addressesList = document.getElementById('shipping-addresses-list');
            let html = '';
            if (window.storeData.userAddresses.length === 0) {
                html = `<p class="text-center text-gray-500">لا توجد عناوين محفوظة.</p>`;
            } else {
                window.storeData.userAddresses.forEach(address => {
                    html += `
                        <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">${address.label}</h4>
                                <p class="text-sm text-gray-600">${address.fullAddress}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="openAddressModal('${address.id}')" class="text-blue-700 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteAddress('${address.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            addressesList.innerHTML = html;
        }

        window.openAddressModal = function(addressId = null) {
            const addressModal = document.getElementById('address-modal');
            const addressModalTitle = document.getElementById('address-modal-title');
            const addressIdField = document.getElementById('address-id');
            const addressLabelField = document.getElementById('address-label');
            const addressFullField = document.getElementById('address-full');

            addressIdField.value = '';
            addressLabelField.value = '';
            addressFullField.value = '';

            if (addressId) {
                addressModalTitle.textContent = 'تعديل العنوان';
                const addressToEdit = window.storeData.userAddresses.find(addr => addr.id === addressId);
                if (addressToEdit) {
                    addressIdField.value = addressToEdit.id;
                    addressLabelField.value = addressToEdit.label;
                    addressFullField.value = addressToEdit.fullAddress;
                }
            } else {
                addressModalTitle.textContent = 'إضافة عنوان جديد';
            }
            addressModal.classList.remove('hidden');
        };

        window.saveAddress = async function() {
            if (!window.currentUserId) {
                showNotification("يرجى تسجيل الدخول لحفظ العناوين.", "warning");
                return;
            }
            const addressId = document.getElementById('address-id').value;
            const label = document.getElementById('address-label').value.trim();
            const fullAddress = document.getElementById('address-full').value.trim();

            if (!label || !fullAddress) {
                showNotification("يرجى ملء جميع حقول العنوان.", "error");
                return;
            }

            const addressesCollectionRef = collection(firestoreDb, "users", window.currentUserId, "addresses");
            try {
                if (addressId) {
                    const addressDocRef = doc(addressesCollectionRef, addressId);
                    await updateDoc(addressDocRef, { label, fullAddress });
                    showNotification("تم تحديث العنوان بنجاح!", "success");
                } else {
                    await addDoc(addressesCollectionRef, { label, fullAddress });
                    showNotification("تمت إضافة العنوان بنجاح!", "success");
                }
                document.getElementById('address-modal').classList.add('hidden');
            } catch (error) {
                console.error("Error saving address:", error);
                showNotification("خطأ في حفظ العنوان.", "error");
            }
        };

        window.deleteAddress = async function(addressId) {
            if (!window.currentUserId) {
                showNotification("يرجى تسجيل الدخول لحذف العناوين.", "warning");
                return;
            }
            showConfirmModal("هل أنت متأكد أنك تريد حذف هذا العنوان؟", async (confirmed) => {
                if (confirmed) {
                    const addressDocRef = doc(firestoreDb, "users", window.currentUserId, "addresses", addressId);
                    try {
                        await deleteDoc(addressDocRef);
                        showNotification("تم حذف العنوان بنجاح!", "success");
                    } catch (error) {
                        console.error("Error deleting address:", error);
                        showNotification("خطأ في حذف العنوان.", "error");
                    }
                }
            });
        };

        // --- My Orders Functions ---
        function loadUserOrders() {
            if (!window.currentUserId) {
                console.log("Skipping loadUserOrders: No user ID.");
                // Ensure the orders-list div exists before trying to set its innerHTML
                const ordersListDiv = document.getElementById('orders-list');
                if (ordersListDiv) {
                    ordersListDiv.innerHTML = `<p class="text-center text-gray-500 py-10">يرجى تسجيل الدخول لعرض طلباتك.</p>`;
                }
                return;
            }
            const userOrdersRef = ref(db, 'orders');
            unsubscribeUserOrders = onValue(userOrdersRef, (snapshot) => {
                const orders = [];
                snapshot.forEach((childSnapshot) => {
                    const order = childSnapshot.val();
                    if (order.userId === window.currentUserId) {
                        orders.push({
                            id: childSnapshot.key,
                            ...order
                        });
                    }
                });
                window.storeData.userOrders = orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                console.log("User orders loaded:", window.storeData.userOrders);
                renderOrdersList();
            }, (error) => {
                console.error("Error loading user orders:", error);
                showNotification("خطأ في تحميل الطلبات.", "error");
            });
        }

        function renderOrdersList() {
            const ordersListDiv = document.getElementById('orders-list');
            // Check if ordersListDiv exists before trying to access its innerHTML
            if (!ordersListDiv) {
                console.error("Error: 'orders-list' element not found.");
                return;
            }

            let html = '';

            if (window.storeData.userOrders.length === 0) {
                html = `<p class="text-center text-gray-500 py-10">لا توجد طلبات سابقة.</p>`;
            } else {
                window.storeData.userOrders.forEach(order => {
                    let statusClass = '';
                    switch (order.status) {
                        case 'تم التوصيل': statusClass = 'text-green-600'; break;
                        case 'قيد الشحن': statusClass = 'text-blue-600'; break;
                        case 'قيد المعالجة': statusClass = 'text-yellow-600'; break;
                        case 'تم الإلغاء': statusClass = 'text-red-600'; break;
                        case 'بانتظار الدفع': statusClass = 'text-purple-600'; break;
                        default: statusClass = 'text-gray-600';
                    }

                    html += `
                        <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="openOrderDetailsModal('${order.id}')">
                            <div>
                                <h4 class="font-semibold text-gray-800">طلب رقم: ${order.invoiceNumber}</h4>
                                <p class="text-sm text-gray-600">التاريخ: ${order.createdAt}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold ${statusClass}">${order.status}</p>
                                <p class="text-lg font-semibold text-blue-700">${(order.total || 0).toLocaleString('ar-EG')} د.ع</p>
                            </div>
                        </div>
                    `;
                });
            }
            ordersListDiv.innerHTML = html;
        }

        window.openOrderDetailsModal = function(orderId) {
            const order = window.storeData.userOrders.find(o => o.id === orderId);
            if (!order) {
                showNotification("لم يتم العثور على تفاصيل الطلب.", "error");
                return;
            }

            document.getElementById('modal-order-number').textContent = order.invoiceNumber;
            document.getElementById('modal-order-date').textContent = order.createdAt;
            document.getElementById('modal-order-status').textContent = order.status;
            document.getElementById('modal-order-name').textContent = order.name;
            document.getElementById('modal-order-phone').textContent = order.phone;
            document.getElementById('modal-order-address').textContent = order.address;
            document.getElementById('modal-order-notes').textContent = order.notes || 'لا توجد ملاحظات.';
            document.getElementById('modal-order-subtotal').textContent = (order.subtotal || 0).toLocaleString('ar-EG');
            document.getElementById('modal-order-delivery-price').textContent = (order.deliveryPrice || 0).toLocaleString('ar-EG');
            document.getElementById('modal-order-total').textContent = (order.total || 0).toLocaleString('ar-EG');

            const productsListHtml = order.products.map(p => `
                <div class="flex justify-between items-center text-sm text-gray-700">
                    <span>${p.name} (x${p.quantity})</span>
                    <span>${(p.price * p.quantity).toLocaleString('ar-EG')} د.ع</span>
                </div>
            `).join('');
            document.getElementById('modal-order-products-list').innerHTML = productsListHtml || '<p class="text-center text-gray-500">لا توجد منتجات في هذا الطلب.</p>';

            document.getElementById('order-details-modal').classList.remove('hidden');
            
            document.getElementById('order-details-contact-support-btn').onclick = () => {
                document.getElementById('order-details-modal').classList.add('hidden');
                window.openContactUsModal();
            };
        };

        /**
         * Sorts the given array of products based on the sortBy criterion.
         * @param {Array} productsArray - The array of products to sort.
         * @param {string} sortBy - The sorting criterion ('price-asc', 'price-desc', 'quantity-asc', etc.).
         * @returns {Array} A new sorted array.
         */
        function sortProducts(productsArray, sortBy) {
            const sorted = [...productsArray];

            sorted.sort((a, b) => {
                const today = new Date();
                const getEffectivePrice = (product) => {
                    const isDiscountSale = product.isSale && product.discountPercentage != null &&
                                   new Date(product.saleStartDate) <= today &&
                                   new Date(product.saleEndDate) >= today;
                    const isCustomPriceSale = product.isSale && product.useCustomDiscountPrice && product.customDiscountPrice != null;

                    if (isDiscountSale) {
                        return product.price * (1 - product.discountPercentage / 100);
                    } else if (isCustomPriceSale) {
                        return product.customDiscountPrice;
                    }
                    return product.price;
                };

                const priceA = getEffectivePrice(a);
                const priceB = getEffectivePrice(b);

                switch (sortBy) {
                    case 'price-asc':
                        return priceA - priceB;
                    case 'price-desc':
                        return priceB - priceA;
                    case 'quantity-asc':
                        return (a.inventory || 0) - (b.inventory || 0);
                    case 'quantity-desc':
                        return (b.inventory || 0) - (a.inventory || 0);
                    case 'date-desc':
                        return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                    case 'date-asc':
                        return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
                    default:
                        return 0;
                }
            });
            return sorted;
        }

        // Function to apply sort and re-render
        function applySortAndRender() {
            const sortBySelect = document.getElementById('sort-by-select');
            const sortBy = sortBySelect.value;
            const activeSectionId = document.querySelector('.store-section:not(.hidden)').id;
            const sortedProducts = sortProducts(window.currentDisplayedProducts, sortBy);
            
            if (activeSectionId === 'home-section') {
                renderProducts('products-grid-home', 'none', sortedProducts);
            } else if (activeSectionId === 'sales-section') {
                renderProducts('products-grid-sales', 'none', sortedProducts);
            } else if (activeSectionId === 'new-arrivals-section') {
                renderProducts('products-grid-new-arrivals', 'none', sortedProducts);
            } else if (activeSectionId === 'favorites-section') {
                renderProducts('products-grid-favorites', 'none', sortedProducts);
            }
        }


        let searchTimeout;
        const searchInput = document.getElementById('search-input');
        const searchSuggestionsDiv = document.getElementById('search-suggestions');
        const sortByContainer = document.getElementById('sort-by-container');


        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const searchTerm = this.value.trim();

            if (searchTerm.length === 0) {
                searchSuggestionsDiv.classList.add('hidden');
                if (!document.getElementById('categories-page-section').classList.contains('hidden')) {
                    renderCategoryFilters();
                } else {
                    // Re-render the current section with its default products
                    showStoreSection(document.querySelector('.store-section:not(.hidden)').id, null);
                }
                return;
            }

            searchTimeout = setTimeout(() => {
                if (!document.getElementById('categories-page-section').classList.contains('hidden')) {
                    const lowerCaseQuery = searchTerm.toLowerCase();
                    const filteredCategories = window.storeData.categories.filter(cat =>
                        cat.name.toLowerCase().includes(lowerCaseQuery)
                    );
                    renderCategoriesSearch(filteredCategories);
                    renderSearchSuggestions(filteredCategories, 'category');
                } else {
                    const lowerCaseQuery = searchTerm.toLowerCase();
                    const searchResults = window.storeData.products.filter(p =>
                        p.isActive && (
                            p.name.toLowerCase().includes(lowerCaseQuery) ||
                            (p.description && p.description.toLowerCase().includes(lowerCaseQuery)) ||
                            (p.category && window.storeData.categories.find(cat => cat.id === p.categoryId)?.name.toLowerCase().includes(lowerCaseQuery))
                        )
                    );
                    showStoreSection(document.querySelector('.store-section:not(.hidden)').id, searchResults);
                    renderSearchSuggestions(searchResults, 'product');
                }
            }, 300);
        });

        /**
         * Renders categories based on search results directly into the categories grid.
         * @param {Array} categories - The array of categories to render.
         */
        function renderCategoriesSearch(categories) {
            const categoriesGridPage = document.getElementById('categories-grid-page');
            categoriesGridPage.innerHTML = '';

            if (categories.length > 0) {
                categories.forEach((category) => {
                    const button = document.createElement('button');
                    button.className = 'category-button-page';
                    button.setAttribute('data-category-id', category.id);
                    button.addEventListener('click', (e) => {
                        if (!e.target.closest('.info-button')) {
                            searchInput.value = '';
                            searchSuggestionsDiv.classList.add('hidden');
                            showStoreSection('home-section');
                            filterProductsByCategory(category.id);
                        }
                    });
                    
                    const mediaHtml = category.image 
                        ? `<img src="${category.image}" alt="${category.name}" onerror="this.onerror=null; this.src='https://placehold.co/300x200/007AFF/FFFFFF?text=Category';" class="category-main-image">`
                        : `<i class="${category.icon || 'fas fa-tag'} category-icon-fallback"></i>`;

                    button.innerHTML = `
                        ${mediaHtml}
                        <div class="category-overlay-strip">
                            <span class="category-name-text">${category.name}</span>
                            <button class="info-button" onclick="openCategoryDescriptionModal('${category.id}')">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    `;
                    categoriesGridPage.appendChild(button);
                });
            } else {
                categoriesGridPage.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">لا توجد أقسام مطابقة لبحثك.</div>`;
            }
        }


        /**
         * Renders search suggestions based on type (product or category).
         * @param {Array} items - The array of items (products or categories) to suggest.
         * @param {'product'|'category'} type - The type of items being suggested.
         */
        function renderSearchSuggestions(items, type) {
            searchSuggestionsDiv.innerHTML = '';
            if (items.length > 0) {
                items.forEach(item => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.textContent = item.name;
                    suggestionItem.className = 'p-2 cursor-pointer hover:bg-gray-100 border-b border-gray-200 last:border-b-0';
                    suggestionItem.addEventListener('click', () => {
                        searchInput.value = item.name;
                        searchSuggestionsDiv.classList.add('hidden');
                        if (type === 'product') {
                            const lowerCaseQuery = item.name.toLowerCase();
                            const searchResults = window.storeData.products.filter(p =>
                                p.isActive && (
                                    p.name.toLowerCase().includes(lowerCaseQuery) ||
                                    (p.description && p.description.toLowerCase().includes(lowerCaseQuery)) ||
                                    (p.category && window.storeData.categories.find(cat => cat.id === p.categoryId)?.name.toLowerCase().includes(lowerCaseQuery))
                                )
                            );
                            showStoreSection(document.querySelector('.store-section:not(.hidden)').id, searchResults);
                        } else if (type === 'category') {
                            showStoreSection('home-section');
                            filterProductsByCategory(item.id);
                        }
                    });
                    searchSuggestionsDiv.appendChild(suggestionItem);
                });
                searchSuggestionsDiv.classList.remove('hidden');
            } else {
                searchSuggestionsDiv.classList.add('hidden');
            }
        }

        document.addEventListener('click', (event) => {
            if (!searchInput.contains(event.target) && !searchSuggestionsDiv.contains(event.target)) {
                searchSuggestionsDiv.classList.add('hidden');
            }
        });

        /**
         * Toggles dark mode on/off and saves preference to localStorage.
         */
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            updateDarkModeToggleIcon(isDarkMode);
        }

        /**
         * Updates the dark mode toggle icon based on current mode.
         * @param {boolean} isDarkMode - True if dark mode is active, false otherwise.
         */
        function updateDarkModeToggleIcon(isDarkMode) {
            const toggleButton = document.getElementById('dark-mode-toggle-account'); // Only one toggle now
            if (toggleButton) {
                const icon = toggleButton.querySelector('i');
                const text = toggleButton.querySelector('span');
                if (isDarkMode) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    text.textContent = 'النهاري'; // Shorter text for space
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    text.textContent = 'الليلي'; // Shorter text for space
                }
            }
        }

        /**
         * Adjusts the body's top padding dynamically based on the header's actual height.
         */
        function adjustBodyPaddingTop() {
            const header = document.getElementById('main-header');
            const bottomNav = document.getElementById('bottom-nav-bar');
            if (header) {
                document.body.style.paddingTop = `${header.offsetHeight}px`;
            }
            if (bottomNav) {
                document.body.style.paddingBottom = `${bottomNav.offsetHeight}px`;
            }
        }

        /**
         * Opens the contact us modal (used by desktop and mobile menu links).
         */
        window.openContactUsModal = function() {
            document.getElementById('contact-us-modal').classList.remove('hidden');
        };

        // --- Footer Visibility Logic ---
        function setupFooterVisibility() {
            const footer = document.getElementById('dynamic-footer');
            const sentinel = document.getElementById('footer-sentinel');

            if (!footer || !sentinel) return;

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        footer.classList.add('visible');
                    } else {
                        footer.classList.remove('visible');
                    }
                });
            }, {
                root: null, // viewport
                rootMargin: '0px',
                threshold: 0 // As soon as any part of the sentinel is visible
            });

            // Start observing the sentinel
            observer.observe(sentinel);

            // For desktop, ensure footer is always visible as it's static
            if (window.innerWidth >= 769) {
                footer.classList.add('visible');
            } else {
                // On mobile, initially hide it, observer will manage visibility
                footer.classList.remove('visible');
            }
        }

        /**
         * Enhances the product description using Gemini API (LLM).
         * @param {string} productId - The ID of the product to enhance.
         */
        window.enhanceProductDescriptionWithAI = async function(productId) {
            const product = window.storeData.products.find(p => p.id === productId);
            if (!product) {
                showNotification("المنتج غير موجود.", "error");
                return;
            }

            const enhanceDescriptionBtn = document.getElementById('enhance-description-btn');
            const enhanceDescriptionText = document.getElementById('enhance-description-text');
            const enhanceDescriptionSpinner = document.getElementById('enhance-description-spinner');
            const modalProductDescription = document.getElementById('modal-product-description');

            // Show loading state
            enhanceDescriptionBtn.disabled = true;
            enhanceDescriptionText.textContent = 'جاري التحسين...';
            enhanceDescriptionSpinner.classList.remove('hidden');

            try {
                const category = window.storeData.categories.find(cat => cat.id === product.categoryId);
                const categoryName = category ? category.name : 'عام';

                const prompt = `أنت مساعد تسوق ذكي. بناءً على معلومات المنتج التالية، قم بإنشاء وصف جذاب ومفصل للمنتج في 3-5 جمل. ركز على الميزات الرئيسية والفوائد التي تعود على العميل. المنتج: ${product.name}, القسم: ${categoryName}, الوصف الحالي: ${product.description || 'لا يوجد وصف.'}`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const enhancedText = result.candidates[0].content.parts[0].text;
                    modalProductDescription.innerHTML = enhancedText.replace(/\n/g, '<br>');
                    showNotification("تم تحسين الوصف بنجاح!", "success");
                } else {
                    console.error("Gemini API response structure unexpected:", result);
                    showNotification("فشل تحسين الوصف. يرجى المحاولة مرة أخرى.", "error");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showNotification("حدث خطأ أثناء الاتصال بالذكاء الاصطناعي.", "error");
            } finally {
                // Reset button state
                enhanceDescriptionBtn.disabled = false;
                enhanceDescriptionText.textContent = '✨ تحسين الوصف بالذكاء الاصطناعي';
                enhanceDescriptionSpinner.classList.add('hidden');
            }
        };


        // --- Event Listeners and Initial Load ---
        document.addEventListener("DOMContentLoaded", function() {
            window.scrollTo(0, 0);

            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                // Ensure the dark mode toggle in the account section is updated on load
                // This will be handled by the event listener attachment below
            } else {
                // Ensure the dark mode toggle in the account section is updated on load
                // This will be handled by the event listener attachment below
            }

            loadSettings();
            loadCategories();
            loadProducts();
            loadHomepageSettings();
            loadCart();
            loadFavorites();

            showStoreSection('home-section'); // Default to home section

            // Event listeners for bottom navigation bar
            document.querySelectorAll('#bottom-nav-bar .nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    showStoreSection(this.getAttribute('data-section'));
                });
            });

            // Event listeners for top navigation bar items that link to sections
            document.querySelectorAll('.header-nav-main .header-icon-btn[data-section]').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    showStoreSection(this.getAttribute('data-section'));
                });
            });

            // Dark Mode Toggle for My Account section
            const darkModeToggleAccount = document.getElementById('dark-mode-toggle-account');
            if (darkModeToggleAccount) {
                darkModeToggleAccount.addEventListener('click', toggleDarkMode);
                // Initial update of the icon based on current mode
                updateDarkModeToggleIcon(document.body.classList.contains('dark-mode'));
            }

            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal-overlay').classList.add('hidden');
                });
            });

            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    e.target.classList.add('hidden');
                }
            });

            document.getElementById('proceed-to-checkout-btn').addEventListener('click', openCheckoutModal);

            document.getElementById('sort-by-select').addEventListener('change', applySortAndRender);

            // Google Sign-in/Sign-out buttons
            document.getElementById('google-sign-in-btn').addEventListener('click', window.signInWithGoogle);
            document.getElementById('sign-out-btn').addEventListener('click', window.signOutUser);

            window.addEventListener('resize', adjustBodyPaddingTop);
            adjustBodyPaddingTop(); // Initial adjustment

            setupFooterVisibility(); // Setup the dynamic footer visibility
        });
    </script>
</body>
</html>
