<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجرنا الإلكتروني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f5f7fa; /* Light background */
            direction: rtl; /* Right-to-left for Arabic */
            text-align: right;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1; /* Allow container to grow and push footer down */
            padding-bottom: 90px; /* Default padding for footer height */
        }

        .header {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            /* Removed flex and justify-content from here, using Tailwind grid instead */
            align-items: center; /* Keep align-items for vertical centering */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .header-nav-links {
            display: flex;
            align-items: center;
        }
        .footer-nav {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            padding: 10px 0;
            position: fixed; /* Make it fixed */
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 999; /* Ensure it's above other content */
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column; /* Stack main links and categories vertically */
            align-items: center;
        }
        .footer-main-links {
            display: flex;
            justify-content: space-around;
            width: 100%;
            flex-wrap: wrap;
        }
        .nav-link-store, .cart-icon-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 10px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            color: white; /* Ensure text color is white */
            text-decoration: none; /* Remove underline */
            font-size: 0.85rem; /* Smaller font for footer links */
            min-width: 70px; /* Ensure consistent width for buttons */
        }
        .nav-link-store i, .cart-icon-container i {
            margin-bottom: 5px; /* Space between icon and text */
            font-size: 1.2rem; /* Adjust icon size */
            margin-left: 0; /* Remove right-to-left margin */
        }
        .nav-link-store:hover, .cart-icon-container:hover {
            background-color: #4338ca; /* Indigo 700 */
        }
        .nav-link-store.active {
            background-color: #4338ca; /* Indigo 700 */
        }
        .cart-icon-container {
            position: relative;
        }
        .cart-count {
            position: absolute;
            top: -5px;
            right: 5px; /* Adjusted position for header icons */
            background-color: #ef4444; /* Red 500 */
            color: white;
            border-radius: 50%;
            padding: 2px 7px;
            font-size: 0.75rem;
            font-weight: bold;
            line-height: 1;
        }
        .product-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            /* Removed cursor: pointer from here as we have specific clickable areas now */
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure cards in a row have equal height */
            position: relative; /* For favorite icon positioning */
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 100%;
            height: 200px; /* Fixed height for consistent image size */
            object-fit: cover;
            border-bottom: 1px solid #eee;
            cursor: pointer; /* Make image clickable for modal */
        }
        .product-info {
            padding: 15px;
            flex-grow: 1; /* Allow info section to expand */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer; /* Make info area clickable for modal */
        }
        .product-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 8px;
        }
        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4f46e5; /* Indigo 600 */
        }
        .product-original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9rem;
            margin-right: 8px;
        }
        .product-description {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            line-height: 1.5;
            flex-grow: 1;
        }
        .category-button-page { /* Class for category buttons on the new categories page */
            background-color: #e0e7ff; /* Indigo 100 */
            color: #4f46e5; /* Indigo 600 */
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease;
            cursor: pointer;
            white-space: nowrap;
            font-size: 1rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100px; /* Fixed height for category cards */
        }
        .category-button-page:hover, .category-button-page.active {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
        }
        .category-button-page i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 700px;
            animation: slideIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideInNotification 0.3s, fadeOutNotification 0.5s 2.5s forwards;
        }
        @keyframes slideInNotification {
            from { right: -300px; opacity: 0; }
            to { right: 20px; opacity: 1; }
        }
        @keyframes fadeOutNotification {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.warning { background-color: #f59e0b; }
        .notification.info { background-color: #3b82f6; }

        .favorite-toggle-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #ccc;
            transition: color 0.2s ease, background-color 0.2s ease;
            z-index: 10;
        }
        .favorite-toggle-btn.active {
            color: #ef4444; /* Red for favorited */
        }
        .favorite-toggle-btn:hover {
            background-color: rgba(255, 255, 255, 0.9);
            color: #e02424;
        }

        .back-to-home-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 10px; /* Space from the title */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4f46e5; /* Indigo 600 */
            transition: color 0.2s ease;
        }
        .back-to-home-btn:hover {
            color: #4338ca; /* Indigo 700 */
        }
        .back-to-home-btn i {
            font-size: 1.5rem; /* Adjust icon size */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                grid-template-columns: 1fr; /* Stack columns on small screens */
                justify-items: center; /* Center items in the grid */
            }
            .header h1 {
                margin-bottom: 10px;
            }
            .header-nav-links {
                width: 100%;
                justify-content: center;
                margin-top: 10px; /* Add some space below the title */
            }
            .footer-nav {
                padding: 10px 5px;
            }
            .footer-main-links {
                flex-wrap: wrap;
                justify-content: space-around;
            }
            .nav-link-store, .cart-icon-container {
                margin: 5px 0; /* Add vertical margin for wrapped items */
                font-size: 0.7rem; /* Even smaller font for very small screens */
                min-width: 60px;
            }
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
            .product-image {
                height: 140px;
            }
            .modal-content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header grid grid-cols-3 items-center">
            <!-- Empty div for left alignment to push middle to center -->
            <div></div> 
            <h1 id="store-name" class="text-3xl font-bold flex items-center justify-center col-start-2 col-span-1">
                <i class="fas fa-store ml-3"></i> متجرنا الإلكتروني
            </h1>
            <nav class="header-nav-links justify-self-end">
                <a href="#" id="contact-us-link" class="nav-link-store text-white hover:bg-indigo-700 ml-4"><i class="fas fa-info-circle ml-2"></i> اتصل بنا</a>
                <div id="cart-icon-container" class="cart-icon-container text-white hover:bg-indigo-700 ml-4" onclick="openCartModal()">
                    <i class="fas fa-shopping-cart ml-2"></i>
                    <span>السلة</span>
                    <span id="cart-count" class="cart-count">0</span>
                </div>
            </nav>
        </header>

        <!-- Home Section (Main Products Display) -->
        <section id="home-section" class="store-section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">منتجاتنا</h2>
            <div id="products-grid-home" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- Products will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">جاري تحميل المنتجات...</div>
            </div>
        </section>

        <!-- Sales Section -->
        <section id="sales-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">عروضنا المميزة</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="products-grid-sales" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- Sales products will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">لا توجد عروض حالياً.</div>
            </div>
        </section>

        <!-- New Arrivals Section -->
        <section id="new-arrivals-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">وصل حديثاً</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="products-grid-new-arrivals" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- New arrivals products will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">لا توجد منتجات جديدة حالياً.</div>
            </div>
        </section>

        <!-- Favorites Section -->
        <section id="favorites-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">منتجاتك المفضلة</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="products-grid-favorites" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 product-grid">
                <!-- Favorite products will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">لم تقم بإضافة أي منتجات إلى المفضلة بعد.</div>
            </div>
        </section>

        <!-- Categories Page Section -->
        <section id="categories-page-section" class="store-section hidden">
            <div class="flex items-center justify-between mb-6">
                <button class="back-to-home-btn" onclick="showStoreSection('home-section')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-3xl font-bold text-gray-800 flex-grow text-center">تصفح الأقسام</h2>
                <div class="w-10"></div> <!-- Placeholder for balance -->
            </div>
            <div id="categories-grid-page" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <!-- Categories will be loaded here by JS -->
                <div class="col-span-full text-center py-10 text-gray-500">جاري تحميل الأقسام...</div>
            </div>
        </section>

        <!-- Product Details Modal -->
        <div id="product-details-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 id="modal-product-name" class="font-bold text-xl text-gray-800">اسم المنتج</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img id="modal-product-image" src="" alt="Product Image" class="w-full h-auto object-cover rounded-md mb-4">
                        <div class="flex items-baseline mb-2">
                            <p id="modal-product-price" class="text-3xl font-bold text-indigo-600 ml-2">0 د.ع</p>
                            <p id="modal-product-original-price" class="text-lg text-gray-500 line-through hidden">0 د.ع</p>
                        </div>
                        <p id="modal-product-category" class="text-sm text-gray-600 mb-2">القسم: عام</p>
                        <p id="modal-product-inventory" class="text-sm text-gray-600 mb-4">المخزون: متوفر</p>
                    </div>
                    <div>
                        <p id="modal-product-description" class="text-gray-700 leading-relaxed mb-6">وصف المنتج سيظهر هنا.</p>
                        <button id="add-to-cart-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg w-full flex items-center justify-center text-lg font-semibold">
                            <i class="fas fa-cart-plus ml-3"></i> أضف إلى السلة
                        </button>
                        <button id="toggle-favorite-modal-btn" class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg w-full flex items-center justify-center text-lg font-semibold">
                            <i class="fas fa-heart ml-3"></i> <span id="favorite-text">أضف إلى المفضلة</span>
                        </button>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button class="close-modal bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded-lg">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>

        <!-- Cart Modal -->
        <div id="cart-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 class="font-bold text-xl text-gray-800">سلة التسوق</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="cart-items-list" class="space-y-4 mb-6 max-h-80 overflow-y-auto">
                    <!-- Cart items will be rendered here -->
                    <p class="text-center text-gray-500 py-4">سلة التسوق فارغة.</p>
                </div>
                <div class="flex justify-between items-center text-lg font-bold text-gray-800 border-t pt-4">
                    <span>الإجمالي الفرعي:</span>
                    <span id="cart-subtotal">0 د.ع</span>
                </div>
                <div class="flex justify-between items-center text-lg font-bold text-gray-800 mt-2">
                    <span>سعر التوصيل:</span>
                    <span id="cart-delivery-price">0 د.ع</span>
                </div>
                <div class="flex justify-between items-center text-2xl font-bold text-indigo-600 border-t pt-4 mt-4">
                    <span>الإجمالي الكلي:</span>
                    <span id="cart-total">0 د.ع</span>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button class="close-modal bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded-lg ml-3">
                        متابعة التسوق
                    </button>
                    <button id="proceed-to-checkout-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg">
                        <i class="fas fa-money-check-alt ml-2"></i> إتمام الشراء
                    </button>
                </div>
            </div>
        </div>

        <!-- Checkout Modal -->
        <div id="checkout-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 class="font-bold text-xl text-gray-800">إتمام الشراء</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="checkout-form" onsubmit="event.preventDefault(); placeOrder()">
                    <h4 class="font-bold text-lg mb-3">معلومات الشحن</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="checkout-name" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل</label>
                            <input type="text" id="checkout-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label for="checkout-phone" class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف</label>
                            <input type="tel" id="checkout-phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div class="md:col-span-2">
                            <label for="checkout-address" class="block text-sm font-medium text-gray-700 mb-1">العنوان الكامل</label>
                            <textarea id="checkout-address" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="checkout-notes" class="block text-sm font-medium text-gray-700 mb-1">ملاحظات إضافية (اختياري)</label>
                            <textarea id="checkout-notes" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                        </div>
                    </div>

                    <h4 class="font-bold text-lg mb-3">طريقة الدفع</h4>
                    <div class="mb-6 p-3 bg-gray-100 rounded-md text-gray-700">
                        <p><i class="fas fa-money-bill-wave ml-2 text-green-600"></i> الدفع عند الاستلام فقط</p>
                    </div>

                    <h4 class="font-bold text-lg mb-3">ملخص الطلب</h4>
                    <div id="checkout-summary-list" class="space-y-2 mb-4 bg-gray-50 p-4 rounded-md max-h-40 overflow-y-auto">
                        <!-- Cart items summary will be rendered here -->
                    </div>
                    <div class="flex justify-between items-center text-md font-medium text-gray-700">
                        <span>الإجمالي الفرعي:</span>
                        <span id="checkout-subtotal">0 د.ع</span>
                    </div>
                    <div class="flex justify-between items-center text-md font-medium text-gray-700 mt-2">
                        <span>سعر التوصيل:</span>
                        <span id="checkout-delivery-price">0 د.ع</span>
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold text-indigo-600 border-t pt-4 mt-4">
                        <span>الإجمالي الكلي:</span>
                        <span id="checkout-total">0 د.ع</span>
                    </div>

                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" class="close-modal bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded-lg ml-3">
                            إلغاء
                        </button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg">
                            <i class="fas fa-check-circle ml-2"></i> تأكيد الطلب
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Contact Us Modal -->
        <div id="contact-us-modal" class="modal-overlay hidden">
            <div class="modal-content max-w-lg">
                <div class="flex justify-between items-center mb-4 pb-3 border-b">
                    <h3 class="font-bold text-xl text-gray-800">اتصل بنا</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700 text-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="text-gray-700 space-y-3">
                    <p class="flex items-center"><i class="fas fa-store ml-3 text-indigo-600"></i> <span id="contact-store-name"></span></p>
                    <p class="flex items-center"><i class="fas fa-phone ml-3 text-indigo-600"></i> <span id="contact-phone"></span></p>
                    <p class="flex items-center"><i class="fab fa-whatsapp ml-3 text-green-600"></i> <span id="contact-whatsapp"></span></p>
                    <p class="flex items-center"><i class="fas fa-envelope ml-3 text-indigo-600"></i> <span id="contact-email"></span></p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button class="close-modal bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded-lg">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>

    </div> <!-- End of container -->

    <!-- Footer Navigation Bar -->
    <footer class="footer-nav">
        <div class="footer-main-links">
            <a href="#" data-section="home-section" class="nav-link-store active"><i class="fas fa-home"></i> <span>الرئيسية</span></a>
            <a href="#" data-section="sales-section" class="nav-link-store"><i class="fas fa-fire"></i> <span>العروض</span></a>
            <a href="#" data-section="new-arrivals-section" class="nav-link-store"><i class="fas fa-box-open"></i> <span>الجديد</span></a>
            <a href="#" data-section="favorites-section" class="nav-link-store"><i class="fas fa-heart"></i> <span>المفضلة</span></a>
            <a href="#" id="toggle-categories-btn" class="nav-link-store"><i class="fas fa-list"></i> <span>الأقسام</span></a>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Firebase configuration (use your existing configuration from the admin panel)
        const firebaseConfig = {
            apiKey: "AIzaSyAG4EKrB3iLEV2hsB8b08ShpSO6PXDnGjg",
            authDomain: "zio3-8ffdd.firebaseapp.com",
            databaseURL: "https://zio3-8ffdd-default-rtdb.firebaseio.com",
            projectId: "zio3-8ffdd",
            storageBucket: "zio3-8ffdd.appspot.com",
            messagingSenderId: "560939348415",
            appId: "1:560939348415:web:c854e9e214e498ad2a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, "products");
        const categoriesRef = ref(db, "categories");
        const settingsRef = ref(db, "settings");
        const ordersRef = ref(db, "orders"); // Reference to orders for placing new orders

        // Global data storage for the store
        window.storeData = {
            products: [],
            categories: [],
            settings: {},
            cart: [], // Initialize cart array
            favorites: [] // Initialize favorites array
        };

        // --- Utility Functions ---
        /**
         * Displays a temporary notification message on the screen.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'warning'|'info'} type - The type of notification.
         */
        function showNotification(message, type) {
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) oldNotification.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} ml-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        /**
         * Saves the current cart to localStorage.
         */
        function saveCart() {
            localStorage.setItem('storeCart', JSON.stringify(window.storeData.cart));
            updateCartCount();
        }

        /**
         * Loads the cart from localStorage.
         */
        function loadCart() {
            const storedCart = localStorage.getItem('storeCart');
            if (storedCart) {
                window.storeData.cart = JSON.parse(storedCart);
            }
            updateCartCount();
        }

        /**
         * Updates the cart item count displayed in the header.
         */
        function updateCartCount() {
            const totalItems = window.storeData.cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // Update header cart count
            const headerCartCountElement = document.getElementById('cart-count');
            if (headerCartCountElement) {
                headerCartCountElement.textContent = totalItems;
                if (totalItems > 0) {
                    headerCartCountElement.classList.remove('hidden');
                } else {
                    headerCartCountElement.classList.add('hidden');
                }
            }
        }

        /**
         * Adds a product to the cart or increments its quantity if already present.
         * @param {object} product - The product object to add.
         */
        window.addToCart = function(product) {
            console.log("Attempting to add product to cart:", product); // Debugging: log product being added

            if (!product || !product.id) {
                console.error("Error: Invalid product object or missing ID when adding to cart.", product);
                showNotification("حدث خطأ: لا يمكن إضافة منتج غير صالح إلى السلة.", "error");
                return;
            }

            const existingItemIndex = window.storeData.cart.findIndex(item => item.id === product.id);

            if (existingItemIndex > -1) {
                // Item exists, increment quantity
                window.storeData.cart[existingItemIndex].quantity++;
                console.log("Product quantity incremented. Current cart:", window.storeData.cart); // Debugging
            } else {
                // Item does not exist, add new with quantity 1
                window.storeData.cart.push({ ...product, quantity: 1 });
                console.log("New product added to cart. Current cart:", window.storeData.cart); // Debugging
            }
            saveCart();
            showNotification(`تمت إضافة "${product.name}" إلى السلة!`, "success");
            // Only close modal if it's open and the call came from inside it
            if (!document.getElementById('product-details-modal').classList.contains('hidden')) {
                document.getElementById('product-details-modal').classList.add('hidden'); 
            }
        };

        /**
         * Removes a product from the cart or decrements its quantity.
         * @param {string} productId - The ID of the product to modify.
         */
        window.updateCartItemQuantity = function(productId, change) {
            const itemIndex = window.storeData.cart.findIndex(item => item.id === productId);

            if (itemIndex > -1) {
                window.storeData.cart[itemIndex].quantity += change;
                if (window.storeData.cart[itemIndex].quantity <= 0) {
                    window.storeData.cart.splice(itemIndex, 1); // Remove if quantity is 0 or less
                }
                saveCart();
                renderCart(); // Re-render cart after update
            }
        };

        /**
         * Saves the current favorites to localStorage.
         */
        function saveFavorites() {
            localStorage.setItem('storeFavorites', JSON.stringify(window.storeData.favorites));
        }

        /**
         * Loads the favorites from localStorage.
         */
        function loadFavorites() {
            const storedFavorites = localStorage.getItem('storeFavorites');
            if (storedFavorites) {
                window.storeData.favorites = JSON.parse(storedFavorites);
            }
        }

        /**
         * Toggles a product in/out of favorites.
         * @param {string} productId - The ID of the product to toggle.
         */
        window.toggleFavorite = function(productId) {
            const product = window.storeData.products.find(p => p.id === productId);
            if (!product) return;

            const existingFavoriteIndex = window.storeData.favorites.findIndex(id => id === product.id);

            if (existingFavoriteIndex > -1) {
                // Remove from favorites
                window.storeData.favorites.splice(existingFavoriteIndex, 1);
                showNotification(`تمت إزالة "${product.name}" من المفضلة.`, "info");
            } else {
                // Add to favorites
                window.storeData.favorites.push(product.id);
                showNotification(`تمت إضافة "${product.name}" إلى المفضلة!`, "success");
            }
            saveFavorites();
            // Re-render favorites section if it's currently active
            if (!document.getElementById('favorites-section').classList.contains('hidden')) {
                renderFavorites();
            }
            // Update the favorite button state in the modal if it's open
            if (!document.getElementById('product-details-modal').classList.contains('hidden')) {
                updateModalFavoriteButton(productId);
            }
            // Re-render the product grids to update favorite icons
            renderProducts('products-grid-home', 'all');
            renderProducts('products-grid-sales', 'sales');
            renderProducts('products-grid-new-arrivals', 'new-arrivals');
        };

        /**
         * Updates the favorite button state in the product details modal.
         * @param {string} productId - The ID of the product.
         */
        function updateModalFavoriteButton(productId) {
            const toggleFavoriteModalBtn = document.getElementById('toggle-favorite-modal-btn');
            const favoriteText = document.getElementById('favorite-text');
            const isFavorited = window.storeData.favorites.includes(productId);

            if (isFavorited) {
                toggleFavoriteModalBtn.classList.add('active');
                favoriteText.textContent = 'إزالة من المفضلة';
            } else {
                toggleFavoriteModalBtn.classList.remove('active');
                favoriteText.textContent = 'أضف إلى المفضلة';
            }
            // Set the onclick for the button
            toggleFavoriteModalBtn.onclick = () => toggleFavorite(productId);
        }

        /**
         * Opens the product details modal with information for the given product ID.
         * @param {string} productId - The ID of the product to display.
         */
        window.openProductDetailsModal = function(productId) {
            const product = window.storeData.products.find(p => p.id === productId);
            if (!product) {
                console.error("Product not found:", productId);
                showNotification("لم يتم العثور على المنتج.", "error");
                return;
            }
            console.log("Opening product details for:", product); // Debugging: log product details

            document.getElementById('modal-product-name').textContent = product.name || 'اسم المنتج';
            
            const modalImage = document.getElementById('modal-product-image');
            modalImage.src = product.image || 'https://placehold.co/400x300/E0E7FF/4F46E5?text=Product';
            modalImage.onerror = function() { this.onerror=null; this.src='https://placehold.co/400x300/E0E7FF/4F46E5?text=Image+Not+Found'; };

            document.getElementById('modal-product-price').textContent = `${(product.price || 0).toLocaleString('ar-EG')} د.ع`;
            
            const originalPriceElem = document.getElementById('modal-product-original-price');
            const today = new Date();
            const isSale = product.isSale && product.discountPercentage != null &&
                           new Date(product.saleStartDate) <= today &&
                           new Date(product.saleEndDate) >= today;

            if (isSale) {
                originalPriceElem.textContent = `${(product.price || 0).toLocaleString('ar-EG')} د.ع`;
                originalPriceElem.classList.remove('hidden');
                document.getElementById('modal-product-price').textContent = `${(product.price * (1 - product.discountPercentage / 100) || 0).toLocaleString('ar-EG')} د.ع`;
            } else {
                originalPriceElem.classList.add('hidden');
            }

            const category = window.storeData.categories.find(cat => cat.id === product.categoryId);
            document.getElementById('modal-product-category').textContent = `القسم: ${category ? category.name : 'عام'}`;
            document.getElementById('modal-product-inventory').textContent = `المخزون: ${product.inventory > 0 ? 'متوفر' : 'غير متوفر'}`;
            document.getElementById('modal-product-description').textContent = product.description || 'لا يوجد وصف متاح لهذا المنتج.';

            // Set the add to cart button's onclick directly
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            addToCartBtn.onclick = () => addToCart(product);
            
            // Update favorite button state
            updateModalFavoriteButton(product.id);

            document.getElementById('product-details-modal').classList.remove('hidden');
        };


        // --- Data Loading Functions ---

        /**
         * Loads store settings from Firebase and updates the UI.
         */
        function loadSettings() {
            onValue(settingsRef, (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    window.storeData.settings = settings;
                    // Update store name with icon
                    const storeNameElement = document.getElementById('store-name');
                    storeNameElement.innerHTML = `<i class="fas fa-store ml-3"></i> ${settings.storeName || 'متجرنا الإلكتروني'}`;

                    // Update contact modal info
                    document.getElementById('contact-store-name').textContent = settings.storeName || 'متجرنا الإلكتروني';
                    document.getElementById('contact-phone').textContent = settings.contactPhone || 'N/A';
                    document.getElementById('contact-whatsapp').textContent = settings.contactWhatsapp || 'N/A';
                    document.getElementById('contact-email').textContent = settings.contactEmail || 'N/A';
                } else {
                    // Default settings if none exist
                    window.storeData.settings = {
                        storeName: "متجرنا الإلكتروني",
                        contactPhone: "+964 782 305 3419",
                        contactWhatsapp: "+964 782 305 3419",
                        contactEmail: "info@zioshop.com",
                        deliveryPrice: 5000,
                        thankYouMessage: "شكراً لثقتك بنا! سيتواصل معك فريقنا قريباً لتأكيد طلبك."
                    };
                    // Update store name with icon
                    const storeNameElement = document.getElementById('store-name');
                    storeNameElement.innerHTML = `<i class="fas fa-store ml-3"></i> متجرنا الإلكتروني`;

                    document.getElementById('contact-store-name').textContent = "متجرنا الإلكتروني";
                    document.getElementById('contact-phone').textContent = "+964 782 305 3419";
                    document.getElementById('contact-whatsapp').textContent = "+964 782 305 3419";
                    document.getElementById('contact-email').textContent = "info@zioshop.com";
                }
                console.log("Store settings loaded:", window.storeData.settings); // Debugging
                showNotification("تم تحميل إعدادات المتجر", "info");
            }, (error) => {
                console.error("Error loading settings:", error);
                showNotification("خطأ في تحميل إعدادات المتجر", "error");
            });
        }

        /**
         * Loads categories from Firebase and updates the category filter buttons.
         */
        function loadCategories() {
            onValue(categoriesRef, (snapshot) => {
                const categories = [];
                snapshot.forEach((childSnapshot) => {
                    categories.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                window.storeData.categories = categories;
                console.log("Categories loaded:", window.storeData.categories); // Debugging
                renderCategoryFilters(); // This will now render into the categories page
                showNotification("تم تحميل الأقسام", "info");
            }, (error) => {
                console.error("Error loading categories:", error);
                showNotification("خطأ في تحميل الأقسام", "error");
            });
        }

        /**
         * Loads products from Firebase and renders them.
         */
        function loadProducts() {
            onValue(productsRef, (snapshot) => {
                const products = [];
                snapshot.forEach((childSnapshot) => {
                    products.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                window.storeData.products = products;
                console.log("Products loaded. Total products:", window.storeData.products.length, window.storeData.products); // Debugging
                // Initial render for home section
                renderProducts('products-grid-home', 'all');
                showNotification("تم تحميل المنتجات", "info");
            }, (error) => {
                console.error("Error loading products:", error);
                showNotification("خطأ في تحميل المنتجات", "error");
            });
        }

        // --- Rendering Functions ---

        /**
         * Renders category buttons into the dedicated categories page.
         */
        function renderCategoryFilters() {
            const categoriesGridPage = document.getElementById('categories-grid-page');
            // Clear existing categories
            categoriesGridPage.innerHTML = ''; 

            // Add new categories
            if (window.storeData.categories.length > 0) {
                window.storeData.categories.forEach((category) => {
                    const button = document.createElement('button');
                    button.className = 'category-button-page'; // Use class for page buttons
                    button.setAttribute('data-category-id', category.id);
                    button.innerHTML = `<i class="${category.icon || 'fas fa-tag'}"></i> <span>${category.name}</span>`; // Assuming category has an icon
                    button.addEventListener('click', () => {
                        // When a category is clicked on the categories page, switch to home section and filter
                        showStoreSection('home-section');
                        filterProductsByCategory(category.id);
                    });
                    categoriesGridPage.appendChild(button);
                });
            } else {
                categoriesGridPage.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">لا توجد أقسام متاحة حالياً.</div>`;
            }
        }

        /**
         * Renders products into a specific grid, optionally filtered by category.
         * @param {string} gridId - The ID of the product grid to render into (e.g., 'products-grid-home').
         * @param {string} filterType - 'all', 'sales', 'new-arrivals', 'favorites', or a categoryId.
         */
        function renderProducts(gridId, filterType) {
            const productsGrid = document.getElementById(gridId);
            // Check if the grid element exists before trying to manipulate it
            if (!productsGrid) {
                console.warn(`Product grid with ID "${gridId}" not found.`);
                return;
            }

            let html = '';
            let filteredProducts = [];
            const today = new Date();

            if (filterType === 'all') {
                filteredProducts = window.storeData.products;
            } else if (filterType === 'sales') {
                filteredProducts = window.storeData.products.filter(p => 
                    p.isSale && p.discountPercentage != null &&
                    new Date(p.saleStartDate) <= today &&
                    new Date(p.saleEndDate) >= today
                );
            } else if (filterType === 'new-arrivals') {
                filteredProducts = window.storeData.products.filter(p => p.isNew).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                // Fallback: show recent products if 'isNew' flag is not used consistently
                if (filteredProducts.length === 0 && window.storeData.products.length > 0) {
                    filteredProducts = window.storeData.products.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)).slice(0, 10); // Show top 10 recent
                }
            } else if (filterType === 'favorites') {
                // Filter products based on IDs in the favorites array
                filteredProducts = window.storeData.products.filter(p => window.storeData.favorites.includes(p.id));
            } else {
                // Filter by specific category ID
                filteredProducts = window.storeData.products.filter(p => p.categoryId === filterType);
            }

            if (filteredProducts.length === 0) {
                let message = '';
                if (filterType === 'sales') message = 'لا توجد عروض حالياً.';
                else if (filterType === 'new-arrivals') message = 'لا توجد منتجات جديدة حالياً.';
                else if (filterType === 'favorites') message = 'لم تقم بإضافة أي منتجات إلى المفضلة بعد.';
                else if (filterType === 'all') message = 'لا توجد منتجات حالياً.';
                else message = 'لا توجد منتجات في هذا القسم حالياً.';

                html = `<div class="col-span-full text-center py-10 text-gray-500">${message}</div>`;
            } else {
                filteredProducts.forEach(product => {
                    const isSale = product.isSale && product.discountPercentage != null &&
                                   new Date(product.saleStartDate) <= today &&
                                   new Date(product.saleEndDate) >= today;
                    
                    let displayPrice = product.price;
                    let originalPriceHtml = '';

                    if (isSale) {
                        displayPrice = product.price * (1 - product.discountPercentage / 100);
                        originalPriceHtml = `<span class="product-original-price">${(product.price || 0).toLocaleString('ar-EG')} د.ع</span>`;
                    }

                    const isFavorited = window.storeData.favorites.includes(product.id);
                    const favoriteIconClass = isFavorited ? 'fas fa-heart active' : 'far fa-heart'; // Solid heart for favorited

                    html += `
                    <div class="product-card">
                        <button class="favorite-toggle-btn ${isFavorited ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${product.id}')">
                            <i class="${favoriteIconClass}"></i>
                        </button>
                        <img src="${product.image || 'https://placehold.co/400x300/E0E7FF/4F46E5?text=Product'}" alt="${product.name || 'Product Image'}" class="product-image" onerror="this.onerror=null; this.src='https://placehold.co/400x300/E0E7FF/4F46E5?text=Image+Not+Found';" onclick="openProductDetailsModal('${product.id}')">
                        <div class="product-info" onclick="openProductDetailsModal('${product.id}')">
                            <div>
                                <h3 class="product-name">${product.name || 'منتج غير معروف'}</h3>
                                <p class="text-sm text-gray-500 mb-2">${product.category || 'عام'}</p>
                            </div>
                            <div class="flex items-baseline justify-end mt-auto">
                                ${originalPriceHtml}
                                <p class="product-price">${(displayPrice || 0).toLocaleString('ar-EG')} د.ع</p>
                            </div>
                        </div>
                        <div class="p-3 pt-0"> <!-- New div for the add to cart button -->
                            <button onclick="event.stopPropagation(); addToCart(${JSON.stringify(product).replace(/'/g, "\\'")})" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg w-full text-sm font-semibold flex items-center justify-center">
                                <i class="fas fa-cart-plus ml-2"></i> أضف للسلة
                            </button>
                        </div>
                    </div>
                    `;
                });
            }
            productsGrid.innerHTML = html;
        }

        /**
         * Filters products displayed on the home page by category.
         * @param {string} categoryId - The ID of the category to filter by.
         */
        function filterProductsByCategory(categoryId) {
            renderProducts('products-grid-home', categoryId);
            // No need to update active category button in footer, as categories are on a separate page
        }

        /**
         * Shows a specific store section and updates the navigation links.
         * @param {string} sectionId - The ID of the section to show (e.g., 'home-section', 'sales-section').
         */
        window.showStoreSection = function(sectionId) {
            document.querySelectorAll('.store-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update active class for footer main navigation links
            document.querySelectorAll('.footer-main-links .nav-link-store').forEach(link => {
                link.classList.remove('active');
            });
            // Only activate if it's one of the main section links
            const mainNavLink = document.querySelector(`.footer-main-links .nav-link-store[data-section="${sectionId}"]`);
            if (mainNavLink) {
                mainNavLink.classList.add('active');
            } else if (sectionId === 'categories-page-section') {
                // If categories page is active, ensure "الأقسام" button is active
                document.getElementById('toggle-categories-btn')?.classList.add('active');
            }


            // Re-render content for the active section if needed
            if (sectionId === 'home-section') {
                renderProducts('products-grid-home', 'all'); // Default to all products on home
            } else if (sectionId === 'sales-section') {
                renderProducts('products-grid-sales', 'sales');
            } else if (sectionId === 'new-arrivals-section') {
                renderProducts('products-grid-new-arrivals', 'new-arrivals');
            } else if (sectionId === 'favorites-section') {
                renderFavorites(); // Always re-render favorites when opened
            }
        }

        /**
         * Renders the items currently in the cart.
         */
        function renderCart() {
            const cartItemsList = document.getElementById('cart-items-list');
            let html = '';
            let subtotal = 0;

            if (window.storeData.cart.length === 0) {
                html = `<p class="text-center text-gray-500 py-4">سلة التسوق فارغة.</p>`;
                document.getElementById('proceed-to-checkout-btn').disabled = true;
                document.getElementById('proceed-to-checkout-btn').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                window.storeData.cart.forEach(item => {
                    const itemPrice = item.price * item.quantity;
                    subtotal += itemPrice;
                    html += `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg shadow-sm">
                        <div class="flex items-center">
                            <img src="${item.image || 'https://placehold.co/50x50/E0E7FF/4F46E5?text=Item'}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md ml-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${item.name}</h4>
                                <p class="text-sm text-gray-600">${(item.price || 0).toLocaleString('ar-EG')} د.ع</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button onclick="updateCartItemQuantity('${item.id}', -1)" class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-300">-</button>
                            <span class="mx-2 text-lg font-medium">${item.quantity}</span>
                            <button onclick="updateCartItemQuantity('${item.id}', 1)" class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-300">+</button>
                            <button onclick="updateCartItemQuantity('${item.id}', -${item.quantity})" class="text-red-600 hover:text-red-800 mr-3">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    `;
                });
                document.getElementById('proceed-to-checkout-btn').disabled = false;
                document.getElementById('proceed-to-checkout-btn').classList.remove('opacity-50', 'cursor-not-allowed');
            }
            cartItemsList.innerHTML = html;

            const deliveryPrice = window.storeData.settings.deliveryPrice || 0;
            const total = subtotal + deliveryPrice;

            document.getElementById('cart-subtotal').textContent = `${subtotal.toLocaleString('ar-EG')} د.ع`;
            document.getElementById('cart-delivery-price').textContent = `${deliveryPrice.toLocaleString('ar-EG')} د.ع`;
            document.getElementById('cart-total').textContent = `${total.toLocaleString('ar-EG')} د.ع`;
        }

        /**
         * Opens the cart modal.
         */
        window.openCartModal = function() {
            renderCart(); // Render cart items every time modal is opened
            document.getElementById('cart-modal').classList.remove('hidden');
        };

        /**
         * Opens the checkout modal and populates it with order summary.
         */
        window.openCheckoutModal = function() {
            const subtotal = window.storeData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryPrice = window.storeData.settings.deliveryPrice || 0;
            const total = subtotal + deliveryPrice;

            const checkoutSummaryList = document.getElementById('checkout-summary-list');
            let summaryHtml = '';
            if (window.storeData.cart.length === 0) {
                summaryHtml = `<p class="text-center text-gray-500 py-4">سلة التسوق فارغة.</p>`;
            } else {
                window.storeData.cart.forEach(item => {
                    summaryHtml += `
                        <li class="flex justify-between">
                            <span>${item.name} (x${item.quantity})</span>
                            <span>${(item.price * item.quantity).toLocaleString('ar-EG')} د.ع</span>
                        </li>
                    `;
                });
            }
            checkoutSummaryList.innerHTML = summaryHtml;

            document.getElementById('checkout-subtotal').textContent = `${subtotal.toLocaleString('ar-EG')} د.ع`;
            document.getElementById('checkout-delivery-price').textContent = `${deliveryPrice.toLocaleString('ar-EG')} د.ع`;
            document.getElementById('checkout-total').textContent = `${total.toLocaleString('ar-EG')} د.ع`;

            document.getElementById('cart-modal').classList.add('hidden'); // Hide cart modal
            document.getElementById('checkout-modal').classList.remove('hidden'); // Show checkout modal
        };

        /**
         * Simulates placing an order. In a real app, this would send data to Firebase.
         */
        window.placeOrder = async function() {
            const name = document.getElementById('checkout-name').value.trim();
            const phone = document.getElementById('checkout-phone').value.trim();
            const address = document.getElementById('checkout-address').value.trim();
            const notes = document.getElementById('checkout-notes').value.trim();

            if (!name || !phone || !address) {
                showNotification("يرجى ملء جميع الحقول المطلوبة (الاسم، الهاتف، العنوان).", "error");
                return;
            }

            if (window.storeData.cart.length === 0) {
                showNotification("سلة التسوق فارغة، لا يمكن إتمام الطلب.", "error");
                return;
            }

            const subtotal = window.storeData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryPrice = window.storeData.settings.deliveryPrice || 0;
            const total = subtotal + deliveryPrice;

            // Generate a random 5-digit invoice number
            const invoiceNumber = Math.floor(10000 + Math.random() * 90000);

            const orderData = {
                invoiceNumber: invoiceNumber, // Use the generated random number
                name,
                phone,
                address,
                notes,
                products: window.storeData.cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price
                })),
                subtotal,
                deliveryPrice,
                total,
                status: "جديد", // New order status
                createdAt: new Date().toLocaleString('ar-EG')
            };

            try {
                // Push the order to the 'orders' collection in Firebase
                await push(ordersRef, orderData);
                showNotification("تم تأكيد طلبك بنجاح! شكراً لك.", "success");
                
                // --- Removed CallMeBot WhatsApp API integration due to CORS issues ---
                // For real-world deployment, consider using a backend proxy (e.g., Firebase Cloud Functions)
                // to make API calls to CallMeBot securely and bypass browser CORS restrictions.

                window.storeData.cart = []; // Clear cart after successful order
                saveCart(); // Update localStorage and cart count
                document.getElementById('checkout-modal').classList.add('hidden'); // Close checkout modal
                document.getElementById('checkout-form').reset(); // Reset form
            } catch (error) {
                console.error("Error placing order:", error);
                showNotification("حدث خطأ أثناء تأكيد الطلب. يرجى المحاولة مرة أخرى.", "error");
            }
        };

        /**
         * Renders products marked as favorites.
         */
        function renderFavorites() {
            renderProducts('products-grid-favorites', 'favorites');
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener("DOMContentLoaded", function() {
            // Load all data
            loadSettings();
            loadCategories();
            loadProducts();
            loadCart(); // Load cart on page load
            loadFavorites(); // Load favorites on page load

            // Set initial section to Home
            showStoreSection('home-section');

            // Navigation links for sections (now in footer)
            document.querySelectorAll('.footer-main-links .nav-link-store[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showStoreSection(this.getAttribute('data-section'));
                });
            });

            // Toggle categories button listener
            document.getElementById('toggle-categories-btn').addEventListener('click', function(e) {
                e.preventDefault();
                showStoreSection('categories-page-section'); // Show the dedicated categories page
            });

            // Close modals
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal-overlay').classList.add('hidden');
                });
            });

            // Close modal on outside click
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    e.target.classList.add('hidden');
                }
            });

            // Open Contact Us modal (from header link)
            document.getElementById('contact-us-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('contact-us-modal').classList.remove('hidden');
            });

            // Event listener for "Proceed to Checkout" button in cart modal
            document.getElementById('proceed-to-checkout-btn').addEventListener('click', openCheckoutModal);
        });
    </script>
</body>
</html>
