<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المنتجات - لوحة تحكم المتجر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        * {
            font-family: 'Tajawal', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .dashboard-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow: hidden;
            max-width: 1400px;
            margin: 0 auto;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 1px solid #e5e7eb;
        }
        .category-tag {
            background: #e0e7ff;
            color: #4f46e5;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 5px;
            display: inline-block;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .inventory-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
        }
        .discount-price {
            text-decoration: line-through;
            color: #6b7280;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #10b981;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .preview-image {
            max-height: 250px;
            object-fit: contain;
            border-radius: 8px;
            background: #f3f4f6;
            border: 1px dashed #d1d5db;
        }
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
        }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-image-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        .add-image-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            width: 100px;
            height: 100px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s;
        }
        .add-image-btn:hover {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .image-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .image-input-group input {
            flex: 1;
            margin-left: 10px;
        }
        .add-more-btn {
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 8px;
            padding: 8px 15px;
            display: inline-flex;
            align-items: center;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .add-more-btn:hover {
            background: #c7d2fe;
        }
        .image-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
        .image-sortable {
            cursor: move;
        }
        .image-sortable.dragging {
            opacity: 0.5;
        }
        
        /* تحسينات جديدة */
        .carousel-container {
            position: relative;
            height: 100%;
            overflow: hidden;
        }
        .carousel-items {
            position: relative;
            height: 100%;
            transition: transform 0.3s ease;
        }
        .carousel-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .carousel-item.active {
            opacity: 1;
        }
        .carousel-nav {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 2;
        }
        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }
        .carousel-dot.active {
            background: white;
            transform: scale(1.2);
        }
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.7);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: all 0.3s;
        }
        .carousel-arrow:hover {
            background: rgba(255, 255, 255, 0.9);
        }
        .carousel-prev {
            left: 10px;
        }
        .carousel-next {
            right: 10px;
        }
        .price-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }
        .current-price {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4f46e5;
        }
        .old-price {
            text-decoration: line-through;
            color: #6b7280;
            font-size: 0.9rem;
        }
        .discount-percentage {
            background: #fee2e2;
            color: #ef4444;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin-top: 2px;
            display: inline-block;
        }
        
        /* تحسينات جديدة */
        .section-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .info-card h3 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4f46e5;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            max-width: 1400px;
            margin: 20px auto;
        }
        .page-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4f46e5;
            display: flex;
            align-items: center;
        }
        .page-title i {
            margin-left: 10px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- رأس الصفحة المعدل -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-box"></i> إدارة المنتجات
        </h1>
        <div class="flex items-center">
            <div class="mr-4 bg-purple-100 px-3 py-1 rounded-full text-sm">
                <i class="fas fa-user mr-1 text-purple-600"></i> المدير
            </div>
            <button id="logout-btn" class="text-white bg-red-500 hover:bg-red-600 px-3 py-1 rounded-lg transition flex items-center text-sm">
                <i class="fas fa-sign-out-alt mr-1"></i> خروج
            </button>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <main class="flex-grow">
        <!-- المنتجات -->
        <section id="products" class="section active">
            <div class="bg-white rounded-xl shadow p-4 md:p-6 dashboard-card">
                <div class="flex justify-between items-center mb-4 md:mb-6">
                    <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-box mr-2 text-purple-600"></i>
                        قائمة المنتجات
                    </h2>
                    <button id="add-product-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i> إضافة منتج
                    </button>
                </div>
                
                <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- سيتم تعبئتها بالمنتجات من قاعدة البيانات -->
                    <div class="text-center py-10 col-span-full">
                        <i class="fas fa-spinner fa-spin text-2xl text-purple-600 mb-3"></i>
                        <p>جاري تحميل المنتجات...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- رسالة نجاح -->
    <div id="success-message" class="success-message">
        <i class="fas fa-check-circle mr-2"></i> تم حفظ المنتج بنجاح!
    </div>

    <!-- مودال إضافة منتج -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-30 p-3">
        <div class="modal bg-white p-4 md:p-5 rounded-xl shadow-lg w-full max-w-2xl max-h-screen overflow-auto">
            <div class="flex justify-between items-center mb-4 md:mb-5 pb-3 border-b">
                <h3 class="font-bold text-lg md:text-xl text-gray-800 flex items-center">
                    <i class="fas fa-plus-circle mr-2 text-purple-600"></i>
                    <span id="product-modal-title">إضافة منتج جديد</span>
                </h3>
                <button id="close-product-modal" class="text-gray-500 hover:text-gray-700 text-lg md:text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <input type="hidden" id="product-id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">اسم المنتج *</label>
                    <input type="text" id="product-name" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" placeholder="اسم المنتج" required>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">السعر الأصلي (د.ع) *</label>
                        <input type="number" id="product-price" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" placeholder="السعر" required min="0" step="0.01">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2">نسبة الخصم (%)</label>
                        <input type="number" id="discount-percentage" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" placeholder="نسبة الخصم" min="0" max="100" step="1" value="0">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2">سعر بعد الخصم (د.ع)</label>
                        <input type="number" id="discounted-price" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" placeholder="سعر بعد الخصم">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2">الكمية المتاحة *</label>
                        <input type="number" id="product-quantity" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" placeholder="الكمية" required min="0">
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">تفعيل المنتج</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="product-active" checked>
                        <span class="slider"></span>
                    </label>
                    <span id="active-status-text" class="mr-2 text-green-600 font-medium">مفعل</span>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">القسم *</label>
                    <select id="product-category" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" required>
                        <option value="">اختر القسم</option>
                        <!-- سيتم تعبئة الأقسام من قاعدة البيانات -->
                    </select>
                </div>
                
                <!-- قسم صور المنتج -->
                <div>
                    <label class="block text-gray-700 mb-2">صور المنتج</label>
                    <div id="images-container">
                        <!-- سيتم إضافة حقول إدخال الصور هنا -->
                    </div>
                    
                    <button type="button" id="add-image-btn" class="add-more-btn">
                        <i class="fas fa-plus mr-1"></i> إضافة صورة أخرى
                    </button>
                    
                    <div class="mt-4">
                        <label class="block text-gray-700 mb-2">معاينة الصور</label>
                        <div id="images-preview" class="image-preview-container">
                            <!-- سيتم عرض معاينة الصور هنا -->
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">الوصف</label>
                    <textarea id="product-description" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" rows="3" placeholder="وصف المنتج"></textarea>
                </div>
            </div>
            
            <div class="flex gap-2 md:gap-3 mt-6">
                <button id="save-product" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg font-medium hover:opacity-90 transition">
                    <i class="fas fa-save mr-2"></i> حفظ
                </button>
                <button id="cancel-product" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition">
                    <i class="fas fa-times mr-2"></i> إلغاء
                </button>
            </div>
        </div>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAG4EKrB3iLEV2hsB8b08ShpSO6PXDnGjg",
            authDomain: "zio3-8ffdd.firebaseapp.com",
            databaseURL: "https://zio3-8ffdd-default-rtdb.firebaseio.com",
            projectId: "zio3-8ffdd",
            storageBucket: "zio3-8ffdd.appspot.com",
            messagingSenderId: "560939348415",
            appId: "1:560939348415:web:c854e9e214e498ad2d310a",
            measurementId: "G-CVN2B2D0RD"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // مراجع لقاعدة البيانات
        const categoriesRef = database.ref('categories');
        const productsRef = database.ref('products');
        
        // عناصر DOM
        const productsContainer = document.getElementById('products-container');
        const addProductBtn = document.getElementById('add-product-btn');
        const productModal = document.getElementById('product-modal');
        const closeProductModal = document.getElementById('close-product-modal');
        const cancelProductBtn = document.getElementById('cancel-product');
        const saveProductBtn = document.getElementById('save-product');
        const productIdEl = document.getElementById('product-id');
        const productName = document.getElementById('product-name');
        const productPrice = document.getElementById('product-price');
        const discountPercentage = document.getElementById('discount-percentage');
        const discountedPrice = document.getElementById('discounted-price');
        const productCategory = document.getElementById('product-category');
        const productQuantity = document.getElementById('product-quantity');
        const productDescription = document.getElementById('product-description');
        const productActive = document.getElementById('product-active');
        const activeStatusText = document.getElementById('active-status-text');
        const successMessage = document.getElementById('success-message');
        const imagesContainer = document.getElementById('images-container');
        const imagesPreview = document.getElementById('images-preview');
        const addImageBtn = document.getElementById('add-image-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        // متغيرات حالة
        let categoriesData = {};
        let productsData = {};
        let ignoreUpdates = false;
        
        // تهيئة لوحة التحكم
        function initDashboard() {
            // استمع لتغيرات في الأقسام
            categoriesRef.on('value', (snapshot) => {
                categoriesData = snapshot.val() || {};
                populateCategorySelect();
            });
            
            // استمع لتغيرات في المنتجات
            productsRef.on('value', (snapshot) => {
                productsData = snapshot.val() || {};
                renderProducts();
            });
            
            // تحديث سعر بعد الخصم عند تغيير السعر أو نسبة الخصم
            productPrice.addEventListener('input', updateDiscountedPrice);
            discountPercentage.addEventListener('input', updateDiscountedPrice);
            
            // تحديث حالة التفعيل
            productActive.addEventListener('change', function() {
                activeStatusText.textContent = this.checked ? 'مفعل' : 'غير مفعل';
                activeStatusText.className = this.checked ? 'mr-2 text-green-600 font-medium' : 'mr-2 text-red-600 font-medium';
            });
            
            // إضافة مستمعين لحقول الصور
            discountedPrice.addEventListener('input', updateDiscountPercentage);
            productPrice.addEventListener('input', handlePriceChange);
            
            // إضافة مستمع لزر إضافة صورة
            addImageBtn.addEventListener('click', addImageInput);
        }
        
        // تحديث سعر بعد الخصم
        function updateDiscountedPrice() {
            if (ignoreUpdates) return;
            ignoreUpdates = true;
            
            const price = parseFloat(productPrice.value) || 0;
            const discount = parseFloat(discountPercentage.value) || 0;
            
            if (discount > 0) {
                const discountValue = price * (discount / 100);
                const finalPrice = price - discountValue;
                discountedPrice.value = finalPrice.toFixed(2);
            } else {
                discountedPrice.value = '';
            }
            
            ignoreUpdates = false;
        }
        
        // تحديث نسبة الخصم عند تغيير السعر بعد الخصم
        function updateDiscountPercentage() {
            if (ignoreUpdates) return;
            ignoreUpdates = true;
            
            const price = parseFloat(productPrice.value) || 0;
            const discounted = parseFloat(discountedPrice.value) || 0;
            
            if (discounted > 0 && price > 0 && discounted < price) {
                const discount = 100 - (discounted * 100 / price);
                discountPercentage.value = Math.round(discount);
            } else {
                discountPercentage.value = 0;
            }
            
            ignoreUpdates = false;
        }
        
        // معالجة تغيير السعر الأصلي
        function handlePriceChange() {
            if (discountPercentage.value && parseFloat(discountPercentage.value) > 0) {
                updateDiscountedPrice();
            } else if (discountedPrice.value && parseFloat(discountedPrice.value) > 0) {
                updateDiscountPercentage();
            }
        }
        
        // تعبئة اختيار الأقسام
        function populateCategorySelect() {
            productCategory.innerHTML = '<option value="">اختر القسم</option>';
            
            Object.entries(categoriesData).forEach(([categoryId, category]) => {
                const option = document.createElement('option');
                option.value = categoryId;
                option.textContent = category.name;
                productCategory.appendChild(option);
            });
        }
        
        // إضافة حقل إدخال صورة
        function addImageInput(url = '') {
            const id = `image-${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'image-input-group';
            div.innerHTML = `
                <input type="text" id="${id}" class="image-url w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500" placeholder="رابط الصورة" value="${url}">
                <button type="button" class="remove-image-btn bg-red-100 hover:bg-red-200 text-red-600 px-3 py-2 rounded-lg">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            imagesContainer.appendChild(div);
            
            // إضافة مستمع لحذف الصورة
            const removeBtn = div.querySelector('.remove-image-btn');
            removeBtn.addEventListener('click', () => {
                div.remove();
                updateImagePreviews();
            });
            
            // إضافة مستمع لتحديث المعاينة
            const input = div.querySelector('.image-url');
            input.addEventListener('input', updateImagePreviews);
            
            // تحديث المعاينات
            updateImagePreviews();
        }
        
        // تحديث معاينة الصور
        function updateImagePreviews() {
            imagesPreview.innerHTML = '';
            
            // إضافة زر إضافة صورة
            const addBtn = document.createElement('div');
            addBtn.className = 'add-image-btn';
            addBtn.innerHTML = '<i class="fas fa-plus text-2xl mb-1"></i><span>إضافة صورة</span>';
            addBtn.addEventListener('click', () => addImageInput());
            imagesPreview.appendChild(addBtn);
            
            // إضافة معاينات للصور
            document.querySelectorAll('.image-url').forEach(input => {
                if (input.value.trim()) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${input.value}" alt="معاينة الصورة">
                        <div class="remove-image-btn" data-id="${input.id}">
                            <i class="fas fa-times"></i>
                        </div>
                    `;
                    
                    // إضافة مستمع لحذف الصورة من المعاينة
                    const removeBtn = previewItem.querySelector('.remove-image-btn');
                    removeBtn.addEventListener('click', () => {
                        // البحث عن عنصر الإدخال المقابل وإزالته
                        const inputId = removeBtn.getAttribute('data-id');
                        const inputElement = document.getElementById(inputId);
                        if (inputElement) {
                            inputElement.closest('.image-input-group').remove();
                        }
                        updateImagePreviews();
                    });
                    
                    imagesPreview.insertBefore(previewItem, addBtn);
                }
            });
        }
        
        // عرض المنتجات
        function renderProducts() {
            productsContainer.innerHTML = '';
            
            if (Object.keys(productsData).length === 0) {
                productsContainer.innerHTML = `
                    <div class="text-center py-10 col-span-full">
                        <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">لا توجد منتجات متاحة</p>
                    </div>
                `;
                return;
            }
            
            Object.entries(productsData).forEach(([productId, product]) => {
                const category = categoriesData[product.category] ? categoriesData[product.category].name : 'غير محدد';
                const activeStatus = product.active !== false; // إذا لم يكن موجود افتراضي مفعل
                const images = product.images || [];
                
                // HTML لعرض الصور مع أزرار التمرير
                let imagesHTML = '';
                let dotsHTML = '';
                if (images.length > 0) {
                    images.forEach((img, index) => {
                        imagesHTML += `
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <img src="${img}" class="w-full h-full object-cover">
                            </div>
                        `;
                        dotsHTML += `
                            <div class="carousel-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>
                        `;
                    });
                } else {
                    imagesHTML = `
                        <div class="carousel-item active">
                            <div class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-box text-gray-400 text-4xl"></i>
                            </div>
                        </div>
                    `;
                }
                
                // HTML لعرض السعر بشكل مرتب ومتباعد
                let priceHTML = '';
                if (product.discountedPrice) {
                    priceHTML = `
                        <div class="price-container">
                            <span class="current-price">${product.discountedPrice.toLocaleString()} د.ع</span>
                            <span class="old-price">${product.price.toLocaleString()} د.ع</span>
                            <span class="discount-percentage">خصم ${product.discountPercentage}%</span>
                        </div>
                    `;
                } else {
                    priceHTML = `
                        <div class="price-container">
                            <span class="current-price">${product.price ? product.price.toLocaleString() + ' د.ع' : 'غير محدد'}</span>
                        </div>
                    `;
                }
                
                productsContainer.innerHTML += `
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="h-48 bg-gray-100 overflow-hidden relative">
                            <div class="carousel-container w-full h-full">
                                <div class="carousel-items w-full h-full">
                                    ${imagesHTML}
                                </div>
                                ${images.length > 1 ? `
                                    <div class="carousel-nav">
                                        ${dotsHTML}
                                    </div>
                                    <div class="carousel-arrow carousel-prev">
                                        <i class="fas fa-chevron-left"></i>
                                    </div>
                                    <div class="carousel-arrow carousel-next">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="inventory-badge">المخزون: ${product.quantity || 0}</div>
                            <div class="absolute top-2 left-2 ${activeStatus ? 'bg-green-500' : 'bg-red-500'} text-white px-2 py-1 rounded-lg text-sm">
                                ${activeStatus ? 'مفعل' : 'غير مفعل'}
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg truncate">${product.name}</h3>
                            ${priceHTML}
                            <div class="category-tag">${category}</div>
                            <div class="flex justify-between mt-3">
                                <button class="edit-product text-blue-600 hover:text-blue-800" data-id="${productId}">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="delete-product text-red-600 hover:text-red-800" data-id="${productId}">
                                    <i class="fas fa-trash-alt"></i> حذف
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // إضافة مستمعين لأزرار التعديل والحذف
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const product = productsData[productId];
                    
                    productIdEl.value = productId;
                    productName.value = product.name || '';
                    productPrice.value = product.price || '';
                    discountPercentage.value = product.discountPercentage || 0;
                    discountedPrice.value = product.discountedPrice || '';
                    productQuantity.value = product.quantity || '';
                    productDescription.value = product.description || '';
                    productCategory.value = product.category || '';
                    
                    if (product.active === false) {
                        productActive.checked = false;
                        activeStatusText.textContent = 'غير مفعل';
                        activeStatusText.className = 'mr-2 text-red-600 font-medium';
                    } else {
                        productActive.checked = true;
                        activeStatusText.textContent = 'مفعل';
                        activeStatusText.className = 'mr-2 text-green-600 font-medium';
                    }
                    
                    // تنظيف حاويات الصور
                    imagesContainer.innerHTML = '';
                    imagesPreview.innerHTML = '';
                    
                    // إضافة حقول الصور
                    const images = product.images || [];
                    if (images.length > 0) {
                        images.forEach(url => {
                            addImageInput(url);
                        });
                    } else {
                        addImageInput(); // حقل إدخال واحد فارغ
                    }
                    
                    document.getElementById('product-modal-title').textContent = 'تعديل المنتج';
                    productModal.classList.remove('hidden');
                });
            });
            
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const product = productsData[productId];
                    
                    if (confirm(`هل أنت متأكد من حذف المنتج "${product.name}"؟`)) {
                        productsRef.child(productId).remove()
                            .then(() => {
                                showSuccess('تم حذف المنتج بنجاح');
                            })
                            .catch(error => {
                                alert('حدث خطأ أثناء حذف المنتج: ' + error.message);
                            });
                    }
                });
            });
            
            // إضافة مستمعين لأزرار التمرير بين الصور
            document.querySelectorAll('.carousel-container').forEach(carousel => {
                const items = carousel.querySelectorAll('.carousel-item');
                const dots = carousel.querySelectorAll('.carousel-dot');
                const prevBtn = carousel.querySelector('.carousel-prev');
                const nextBtn = carousel.querySelector('.carousel-next');
                
                let currentIndex = 0;
                
                const showSlide = (index) => {
                    items.forEach((item, i) => {
                        item.classList.toggle('active', i === index);
                    });
                    
                    dots.forEach((dot, i) => {
                        dot.classList.toggle('active', i === index);
                    });
                    
                    currentIndex = index;
                };
                
                // التمرير السابق
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        let newIndex = currentIndex - 1;
                        if (newIndex < 0) newIndex = items.length - 1;
                        showSlide(newIndex);
                    });
                }
                
                // التمرير التالي
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        let newIndex = currentIndex + 1;
                        if (newIndex >= items.length) newIndex = 0;
                        showSlide(newIndex);
                    });
                }
                
                // النقاط أسفل الصور
                dots.forEach((dot, index) => {
                    dot.addEventListener('click', () => {
                        showSlide(index);
                    });
                });
            });
        }
        
        // فتح مودال إضافة منتج
        addProductBtn.addEventListener('click', () => {
            productIdEl.value = '';
            productName.value = '';
            productPrice.value = '';
            discountPercentage.value = 0;
            discountedPrice.value = '';
            productQuantity.value = '';
            productDescription.value = '';
            productCategory.value = '';
            productActive.checked = true;
            activeStatusText.textContent = 'مفعل';
            activeStatusText.className = 'mr-2 text-green-600 font-medium';
            
            // تنظيف حاويات الصور
            imagesContainer.innerHTML = '';
            imagesPreview.innerHTML = '';
            
            // إضافة حقل إدخال صور واحد
            addImageInput();
            
            document.getElementById('product-modal-title').textContent = 'إضافة منتج جديد';
            productModal.classList.remove('hidden');
        });
        
        // إغلاق مودال المنتج
        closeProductModal.addEventListener('click', () => {
            productModal.classList.add('hidden');
        });
        
        cancelProductBtn.addEventListener('click', () => {
            productModal.classList.add('hidden');
        });
        
        // حفظ المنتج
        saveProductBtn.addEventListener('click', () => {
            const productId = productIdEl.value;
            const name = productName.value.trim();
            const price = parseFloat(productPrice.value);
            const discount = parseFloat(discountPercentage.value) || 0;
            const discounted = discount > 0 ? parseFloat(discountedPrice.value) : null;
            const category = productCategory.value;
            const quantity = parseInt(productQuantity.value);
            const description = productDescription.value.trim();
            const active = productActive.checked;
            
            // جمع روابط الصور
            const images = [];
            document.querySelectorAll('.image-url').forEach(input => {
                if (input.value.trim()) {
                    images.push(input.value.trim());
                }
            });
            
            if (!name) {
                alert('يرجى إدخال اسم المنتج');
                return;
            }
            
            if (!price || isNaN(price) || price <= 0) {
                alert('يرجى إدخال سعر صحيح للمنتج');
                return;
            }
            
            if (discount > 0 && (isNaN(discounted) || discounted <= 0)) {
                alert('يرجى إدخال نسبة خصم صحيحة');
                return;
            }
            
            if (!category) {
                alert('يرجى اختيار قسم للمنتج');
                return;
            }
            
            if (isNaN(quantity) || quantity < 0) {
                alert('يرجى إدخال كمية صحيحة');
                return;
            }
            
            const productData = {
                name: name,
                price: price,
                discountPercentage: discount,
                discountedPrice: discounted,
                images: images,
                category: category,
                quantity: quantity,
                description: description,
                active: active
            };
            
            if (productId) {
                // تحديث المنتج
                productsRef.child(productId).update(productData)
                    .then(() => {
                        showSuccess('تم تحديث المنتج بنجاح');
                        productModal.classList.add('hidden');
                    })
                    .catch(error => {
                        alert('حدث خطأ أثناء تحديث المنتج: ' + error.message);
                    });
            } else {
                // إضافة منتج جديد
                productsRef.push(productData)
                    .then(() => {
                        showSuccess('تم إضافة المنتج بنجاح');
                        productModal.classList.add('hidden');
                    })
                    .catch(error => {
                        alert('حدث خطأ أثناء إضافة المنتج: ' + error.message);
                    });
            }
        });
        
        // عرض رسالة النجاح
        function showSuccess(message) {
            successMessage.innerHTML = `<i class="fas fa-check-circle mr-2"></i> ${message}`;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }
        
        // تسجيل الخروج
        logoutBtn.addEventListener('click', () => {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                // يمكنك هنا إضافة أي عملية تسجيل خروج تحتاجها
                alert('تم تسجيل الخروج بنجاح');
            }
        });
        
        // إغلاق المودال عند النقر خارج المحتوى
        window.addEventListener('click', (e) => {
            if (e.target === productModal) productModal.classList.add('hidden');
        });
        
        // بدء التطبيق
        initDashboard();
    </script>
</body>
</html>