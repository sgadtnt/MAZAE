<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الدعم الفني - الإصدار المحسن</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary-dark-blue: #1A237E;
            --color-secondary-gold: #FFD700;
            --color-background-light: #f0f2f5;
            --color-text-dark: #212121;
            --color-border-medium-blue: #d0d0d0;
            --color-admin-message: #e3f2fd;
            --color-user-message: #f5f5f5;
            --color-unread: #f44336;
            --primary: var(--color-primary-dark-blue);
            --secondary: var(--color-secondary-gold);
            --accent: var(--color-secondary-gold);
            --light: var(--color-background-light);
            --dark: var(--color-text-dark);
            --success: #2ECC71;
            --warning: #FFC107;
            --error: #E74C3C;
            --border: var(--color-border-medium-blue);
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --transition: all 0.3s ease-in-out;
            font-size: 14px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa, #e4e7f1);
            color: var(--dark);
            min-height: 100vh;
            direction: rtl; 
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        body.modal-open {
            overflow: hidden;
        }

        .app-header {
            background: linear-gradient(135deg, var(--color-primary-dark-blue), #283593);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--color-secondary-gold);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%; 
            justify-content: center; 
        }

        .logo-container i {
            font-size: 1.8rem;
            color: var(--secondary);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            animation: pulse 2s infinite;
        }

        .logo-container h1 {
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .connection-status {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            gap: 5px;
            background: rgba(255, 255, 255, 0.15);
            padding: 5px 12px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        .connection-status i {
            font-size: 0.8rem;
        }
        
        .admin-container {
            display: flex;
            min-height: calc(100vh - 65px);
            padding-top: 65px;
            flex: 1;
        }

        .sidebar {
            width: 320px;
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            border-left: 1px solid var(--border);
            box-shadow: 2px 0 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 65px);
            z-index: 900;
            position: fixed;
            right: 0;
            top: 65px;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, var(--color-primary-dark-blue), #283593);
            color: white;
            text-align: center;
            position: relative;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.85);
        }

        .conversations-search {
            padding: 18px 15px;
            border-bottom: 1px solid var(--border);
            position: relative;
            background: white;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px; 
            border: 1px solid #dde2e8;
            border-radius: 30px;
            font-size: 0.95rem;
            background-color: #f8fafc;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 30px; 
            top: 50%;
            transform: translateY(-50%);
            color: #777;
            font-size: 1.1rem;
        }

        .conversations-list {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 15px;
            background: #f8fafc;
        }

        .conversation-item {
            padding: 18px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            background: white;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
        }

        .conversation-item:hover {
            background-color: #f1f5f9;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-color: #d0e0f0;
        }

        .conversation-item.active {
            background: linear-gradient(to right, rgba(234, 242, 255, 0.7), white);
            border-right: 4px solid var(--accent);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--color-primary-dark-blue), #283593);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background-color: var(--success);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px var(--success);
        }

        .user-avatar.offline::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background-color: #bbb;
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-name {
            font-weight: bold;
            font-size: 1.05rem;
            color: #2c3e50;
        }

        .last-message-time {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .message-count {
            width: 26px;
            height: 26px;
            background-color: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .message-count.has-unread {
            background: linear-gradient(135deg, var(--color-unread), #ff6b6b);
            color: white;
            box-shadow: 0 2px 5px rgba(244, 67, 54, 0.3);
            animation: pulse 1.5s infinite;
        }

        .last-message {
            font-size: 0.9rem;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
            margin-top: 10px;
            color: #5c6770;
        }
        
        .countdown-timer {
            font-size: 0.85rem;
            color: #E74C3C;
            font-weight: bold;
            margin-top: 10px;
            padding: 5px 10px;
            background: #fff0f0;
            border-radius: 15px;
            display: inline-block;
            border: 1px solid #ffd0d0;
        }

        .no-conversations {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }

        .no-conversations i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.2;
            color: #7f8c8d;
        }

        .no-conversations p {
            font-size: 1.1rem;
            margin-top: 10px;
            color: #5c6770;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-height: 100%; 
            background: linear-gradient(to bottom, #f8f9fa, #eef2f6);
            margin-right: 320px;
            width: calc(100% - 320px);
        }

        .conversation-header-bar {
            padding: 15px 25px;
            background-color: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 3px 10px rgba(0,0,0,0.07);
            position: sticky;
            top: 65px;
            z-index: 500;
        }

        .conversation-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .conversation-user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--color-primary-dark-blue), #283593);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .conversation-user-details {
            line-height: 1.4;
        }

        .conversation-user-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: #2c3e50;
        }

        .status {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status.online::before {
            background-color: var(--success);
            box-shadow: 0 0 6px var(--success);
        }

        .status.offline::before {
            background-color: #bbb;
        }
        .status.blocked::before {
            background-color: var(--error);
            box-shadow: 0 0 6px var(--error);
        }

        .conversation-actions {
            display: flex;
            gap: 12px;
        }

        .action-button {
            background: none;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: #555;
            transition: var(--transition);
            background: #f8f9fa;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        
        #closeConversationButton:hover {
            background-color: rgba(255, 193, 7, 0.2);
            color: #FFC107;
        }

        #deleteConversationButton:hover {
            background-color: rgba(231, 76, 60, 0.2);
            color: #E74C3C;
        }

        .action-button.block:hover {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .action-button.cancel:hover {
            background-color: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .messages-area {
            flex-grow: 1; 
            min-height: 0; 
            padding: 20px;
            background: linear-gradient(to bottom, #f8f9fa, #eef2f6);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .messages-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 18px;
            min-height: 100%; 
            padding: 10px;
        }

        .no-messages {
            text-align: center;
            padding: 40px 20px;
            color: #777;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        .no-messages i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.2;
            color: #7f8c8d;
        }

        .no-messages p {
            margin: 8px 0;
            font-size: 1.1rem;
            color: #5c6770;
        }

        .date-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-divider span {
            background: linear-gradient(to right, #e0e0e0, #f0f0f0);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #5c6770;
            position: relative;
            z-index: 1;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .date-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, rgba(0,0,0,0.1), rgba(0,0,0,0.05));
            z-index: 0;
        }

        .message {
            max-width: 78%;
            padding: 14px 18px;
            border-radius: 20px;
            position: relative;
            animation: fadeIn 0.4s ease-out;
            box-shadow: 0 3px 8px rgba(0,0,0,0.07);
            transition: var(--transition);
            transform-origin: bottom;
        }

        .message:hover {
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(15px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .user-message {
            background: linear-gradient(to bottom, #ffffff, #f5f7fa);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .admin-message {
            background: linear-gradient(to bottom, #e3f2fd, #d0e5ff);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            border: 1px solid #c5daf8;
        }

        .message-content {
            word-wrap: break-word;
            line-height: 1.5;
            position: relative;
            font-size: 1.05rem;
            color: #333;
        }

        .message-time {
            font-size: 0.75rem;
            color: #7f8c8d;
            margin-top: 8px;
            text-align: left;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .admin-message .message-time {
            text-align: right;
        }
        
        .message {
            position: relative;
        }
        
        .message:hover .delete-message-btn {
            opacity: 1;
            transform: scale(1);
        }
        
        .delete-message-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 26px;
            height: 26px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            border: none;
            z-index: 2;
            transform: scale(0.8);
        }
        
        .delete-message-btn:hover {
            background: rgba(231, 76, 60, 0.8);
            transform: scale(1.1);
        }
        
        .admin-message .delete-message-btn {
            right: 10px;
            left: auto;
        }
        
        .deleted-message .delete-message-btn {
            display: none;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .new-message {
            animation: slideIn 0.4s ease-out;
        }
        
        .message.pending {
            opacity: 0.9;
            transform: scale(0.98);
        }
        
        .pending-indicator {
            font-size: 0.75rem;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: center;
            font-style: italic;
            transition: opacity 0.3s;
            animation: pulse-opacity 1.5s infinite;
        }

        @keyframes pulse-opacity {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        #confirmationModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 4000;
            backdrop-filter: blur(5px);
        }

        .confirmation-content {
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            padding: 35px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 450px;
            width: 90%;
            position: relative;
            border: 1px solid #e0e0e0;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .confirmation-content h3 {
            margin-bottom: 25px;
            font-size: 1.3rem;
            color: var(--dark);
            line-height: 1.5;
        }
        
        .confirmation-content .message-preview {
            background: #f5f7fa;
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            max-height: 150px;
            overflow-y: auto;
            text-align: right;
            border: 1px solid #e0e0e0;
            font-size: 0.95rem;
        }

        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
        }

        .confirmation-buttons button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: var(--transition);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        #confirmationModalConfirm {
            background: linear-gradient(to right, #E74C3C, #c0392b);
            color: white;
        }

        #confirmationModalConfirm:hover {
            background: linear-gradient(to right, #c0392b, #a5281b);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        #confirmationModalCancel {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
            color: white;
        }

        #confirmationModalCancel:hover {
            background: linear-gradient(to right, #7f8c8d, #6c7a89);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(127, 140, 141, 0.3);
        }

        .message-input-area {
            display: flex;
            padding: 18px;
            background-color: white;
            border-top: 1px solid var(--border);
            align-items: center;
            box-shadow: 0 -3px 10px rgba(0,0,0,0.05);
        }

        .admin-message-input {
            flex-grow: 1;
            padding: 14px 18px;
            border: 1px solid #dde2e8;
            border-radius: 30px;
            resize: none;
            min-height: 55px;
            max-height: 150px;
            font-size: 1rem;
            transition: var(--transition);
            background: #f8fafc;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .admin-message-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2), inset 0 2px 4px rgba(0,0,0,0.05);
            background: white;
        }

        .admin-send-button {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #283593);
            color: white;
            border: none;
            margin-right: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(26, 35, 126, 0.3);
        }

        .admin-send-button:hover {
            background: linear-gradient(135deg, #283593, #1A237E);
            transform: scale(1.05) rotate(-5deg);
            box-shadow: 0 6px 15px rgba(26, 35, 126, 0.4);
        }

        .admin-send-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Blocked user styles */
        .blocked-indicator {
            background: #ffebee;
            color: #c62828;
            border-radius: 20px;
            padding: 8px 15px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            border: 1px solid #ffcdd2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(198, 40, 40, 0.1);
        }
        
        .blocked-indicator i {
            font-size: 1.2rem;
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 280px;
            }
            .main-content {
                margin-right: 280px;
                width: calc(100% - 280px);
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 12px 15px;
            }
            
            .logo-container h1 {
                font-size: 1.1rem;
            }
            
            .connection-status {
                font-size: 0.8rem;
            }
            
            #toggleSidebar {
                display: block;
                position: absolute;
                left: 15px;
                background: none;
                border: none;
                color: white;
                font-size: 1.3rem;
                cursor: pointer;
                z-index: 1100;
            }

            .app-header .logo-container {
                justify-content: center;
                width: 100%;
            }
            
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                right: -320px;
                width: 320px;
                height: calc(100vh - 65px);
                box-shadow: -2px 0 15px rgba(0,0,0,0.15);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            
            .sidebar.active {
                transform: translateX(-320px);
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 65px;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 900;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .conversations-list {
                max-height: none;
            }
            
            .main-content {
                width: 100%;
                margin-right: 0;
            }
            
            #conversationModal {
                display: none;
            }
            
            .modal-content {
                border-radius: 0;
            }
        }

        @media (min-width: 769px) {
            #conversationModal {
                display: none !important;
            }
            .main-content {
                display: flex !important;
            }
            .sidebar {
                position: fixed;
                right: 0;
                box-shadow: -2px 0 15px rgba(0,0,0,0.1);
                width: 320px;
                height: calc(100vh - 65px);
            }
            #toggleSidebar {
                display: none;
            }
            .app-header .logo-container {
                justify-content: flex-start;
                width: auto;
            }
            
            .mobile-toggle {
                display: none !important;
            }
        }

        @media (max-width: 576px) {
            .app-header h1 {
                font-size: 1rem;
            }
            
            .connection-status {
                font-size: 0.75rem;
            }
            
            .sidebar-header {
                padding: 15px;
            }
            
            .conversation-user-avatar {
                width: 40px;
                height: 40px;
            }
            
            .conversation-user-name {
                font-size: 1rem;
            }
            
            .message {
                max-width: 85%;
            }
            
            .admin-message-input {
                padding: 12px 15px;
            }
            
            .admin-send-button {
                width: 48px;
                height: 48px;
            }
            
            .modal-header {
                padding: 12px 15px;
            }
            
            .modal-footer {
                padding: 10px;
            }
        }
        
        .action-buttons-container {
            display: flex;
            gap: 10px;
            margin-left: 10px;
        }
        
        .action-button.delete {
            color: #fff;
            background: linear-gradient(135deg, #E74C3C, #c0392b);
        }
        
        .action-button.delete:hover {
            background: linear-gradient(135deg, #c0392b, #a5281b);
        }
        
        .action-button.close {
            color: #fff;
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .action-button.close:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }
        
        .action-button.block {
            color: #fff;
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        
        .action-button.block:hover {
            background: linear-gradient(135deg, #2980b9, #2573a7);
        }
        
        .action-button.cancel {
            color: #fff;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .action-button.cancel:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
        }
        
        .loading-indicator {
            display: flex;
            justify-content: center;
            padding: 30px 20px;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(26, 35, 126, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 28px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            box-shadow: var(--shadow);
            z-index: 2000;
            opacity: 0;
            transform: translateY(-30px);
            transition: opacity 0.3s, transform 0.3s;
            min-width: 300px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.success {
            background: linear-gradient(to right, rgba(46, 204, 113, 0.9), rgba(39, 174, 96, 0.9));
        }
        
        .notification.error {
            background: linear-gradient(to right, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9));
        }
        
        .notification.warning {
            background: linear-gradient(to right, rgba(255, 193, 7, 0.9), rgba(230, 126, 34, 0.9));
            color: var(--dark);
        }
        
        .search-options {
            padding: 15px;
            background-color: #f8fafc;
            border-bottom: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .search-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .search-option input {
            margin: 0;
        }
        
        .search-results-info {
            padding: 12px 15px;
            background: #e3f2fd;
            border-bottom: 1px solid #bbdefb;
            font-size: 0.95rem;
            color: #1A237E;
            text-align: center;
            font-weight: 600;
        }
        
        .deleted-messages-toggle {
            text-align: center;
            margin: 15px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .deleted-messages-toggle button {
            background: linear-gradient(to bottom, #f8f9fa, #eef2f6);
            border: 1px solid #dde2e8;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            color: #5c6770;
            font-size: 0.95rem;
            transition: var(--transition);
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .deleted-messages-toggle button:hover {
            background: linear-gradient(to bottom, #eef2f6, #e4e9f4);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .deleted-messages-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 15px;
            background-color: #fdfdfd;
            margin-top: 15px;
            display: none;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .deleted-messages-container .message {
            max-width: 100%;
            background: linear-gradient(to bottom, #fff8f8, #ffefef);
            border: 1px solid #ffdddd;
        }
        
        .deleted-messages-container .deleted-info {
            font-size: 0.8rem;
            color: #e74c3c;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ffdddd;
        }
        
        .clear-log-button {
            background: linear-gradient(to bottom, #f8f9fa, #eef2f6);
            border: 1px solid #dde2e8;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            color: #e74c3c;
            font-size: 0.95rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .clear-log-button:hover {
            background: linear-gradient(to bottom, #ffebee, #ffdbde);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.15);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(26, 35, 126, 0.3);
            border-radius: 10px;
            transition: background 0.3s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(26, 35, 126, 0.5);
        }
        
        /* New Modal for User Search */
        #userSearchModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 4000;
            backdrop-filter: blur(5px);
        }
        
        .user-search-content {
            background: white;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
            position: relative;
            overflow: hidden;
        }
        
        .user-search-header {
            background: linear-gradient(135deg, var(--primary), #283593);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .user-search-header h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        
        .user-search-body {
            padding: 20px;
        }
        
        .user-search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #dde2e8;
            border-radius: 30px;
            font-size: 0.95rem;
            background-color: #f8fafc;
            transition: var(--transition);
            margin-bottom: 15px;
        }
        
        .user-search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
            background: white;
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: white;
        }
        
        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-item:hover {
            background-color: #f1f5f9;
        }
        
        .search-result-item .user-avatar {
            width: 36px;
            height: 36px;
            font-size: 1rem;
        }
        
        .search-result-item .user-details {
            flex-grow: 1;
        }
        
        .search-result-item .user-name {
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        
        .search-result-item .user-id {
            font-size: 0.75rem;
            color: #7f8c8d;
        }
        
        .user-search-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            border-top: 1px solid #e0e0e0;
        }
        
        .close-modal-btn {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .close-modal-btn:hover {
            background: linear-gradient(to right, #7f8c8d, #6c7a89);
            transform: translateY(-2px);
        }
        
        /* إضافة أنماط جديدة لعرض تفاصيل المستخدم */
        .user-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 4000;
            backdrop-filter: blur(5px);
        }
        
        .user-detail-content {
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            padding: 25px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 450px;
            width: 90%;
            position: relative;
            border: 1px solid #e0e0e0;
            animation: scaleIn 0.3s ease-out;
        }
        
        .user-detail-header {
            background: linear-gradient(135deg, var(--color-primary-dark-blue), #283593);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 12px 12px 0 0;
            margin: -25px -25px 20px -25px;
        }
        
        .user-detail-header h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        
        .user-detail-body {
            padding: 15px 0;
        }
        
        .user-avatar-large {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--color-secondary-gold);
            display: block;
            background: linear-gradient(135deg, var(--color-primary-dark-blue), #283593);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 2.5rem;
        }
        
        .user-detail-info {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .user-detail-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .user-detail-row:last-child {
            border-bottom: none;
        }
        
        .user-detail-label {
            font-weight: bold;
            min-width: 120px;
            color: var(--color-primary-dark-blue);
        }
        
        .user-detail-value {
            flex: 1;
            word-break: break-word;
        }
        
        .user-detail-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .user-detail-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: var(--transition);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        
        .user-detail-btn.primary {
            background: linear-gradient(to right, var(--color-primary-dark-blue), #283593);
            color: white;
        }
        
        .user-detail-btn.secondary {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
            color: white;
        }
        
        .user-detail-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Enhancements for user list */
        .user-role {
            font-size: 0.8rem;
            background: #e3f2fd;
            color: #1A237E;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .user-last-seen {
            font-size: 0.75rem;
            color: #7f8c8d;
        }
        
        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }
        
        .user-status.online {
            background-color: var(--success);
        }
        
        .user-status.offline {
            background-color: #bbb;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <button id="toggleSidebar">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo-container">
            <i class="fas fa-headset"></i>
            <h1>لوحة الدعم الفني - الإصدار المحسن</h1>
        </div>
        <div class="connection-status">
            <i class="fas fa-circle"></i>
            <span>جاري الاتصال بقاعدة البيانات...</span>
        </div>
    </div>
    
    <div class="admin-container">
        <div class="sidebar" id="conversationsSidebar">
            <div class="sidebar-header">
                <h2>مركز الدعم الفني</h2>
                <p>إدارة محادثات العملاء</p>
                <button id="searchUsersBtn" class="action-button" style="position: absolute; left: 15px; top: 15px;" title="بحث عن مستخدم">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>
            
            <!-- محتوى المحادثات فقط -->
            <div class="conversations-content">
                <div class="conversations-search">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="ابحث في المحادثات...">
                </div>
                
                <div class="search-options">
                    <div class="search-option">
                        <input type="checkbox" id="searchByName" checked>
                        <label for="searchByName">البحث بالأسماء</label>
                    </div>
                    <div class="search-option">
                        <input type="checkbox" id="searchById" checked>
                        <label for="searchById">البحث بالأرقام</label>
                    </div>
                    <div class="search-option">
                        <input type="checkbox" id="searchByMessages" checked>
                        <label for="searchByMessages">البحث في الرسائل</label>
                    </div>
                </div>
                
                <div id="conversationsList" class="conversations-list">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <p>جاري تحميل المحادثات...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="conversation-header-bar">
                <div class="conversation-user-info">
                    <div id="conversationUserAvatar" class="conversation-user-avatar">?</div>
                    <div class="conversation-user-details">
                        <div id="conversationUserName" class="conversation-user-name">اختر محادثة</div>
                        <div id="conversationUserStatus" class="status offline">غير متصل</div>
                    </div>
                </div>
                
                <div class="conversation-actions">
                    <div class="action-buttons-container">
                        <button id="blockUserButton" class="action-button block" title="حظر العميل" style="display: none;">
                            <i class="fas fa-ban"></i>
                        </button>
                        <button id="closeConversationButton" class="action-button close" title="إغلاق المحادثة" style="display: none;">
                            <i class="fas fa-lock"></i>
                        </button>
                        <button id="cancelDeletionButton" class="action-button cancel" title="إلغاء الحذف بعد 24 ساعة" style="display: none;">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button id="deleteConversationButton" class="action-button delete" title="حذف المحادثة بشكل نهائي" style="display: none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="messages-area">
                <div id="messagesContainer" class="messages-container">
                    <div class="no-messages">
                        <i class="fas fa-comment-alt"></i>
                        <p>مرحباً بك في لوحة تحكم الدعم الفني</p>
                        <p>اختر محادثة من القائمة الجانبية للبدء</p>
                    </div>
                </div>
                
                <div class="deleted-messages-toggle">
                    <button id="toggleDeletedMessages">عرض الرسائل المحذوفة (<span id="deletedCount">0</span>)</button>
                    <button id="clearDeletedMessages" class="clear-log-button">
                        <i class="fas fa-trash"></i> مسح السجل
                    </button>
                </div>
                
                <div id="deletedMessagesContainer" class="deleted-messages-container">
                </div>
            </div>
            
            <div class="message-input-area">
                <textarea id="adminMessageInput" class="admin-message-input" placeholder="اختر محادثة للبدء..." rows="1" disabled></textarea>
                <button id="adminSendButton" class="admin-send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for User Search -->
    <div id="userSearchModal" class="modal">
        <div class="user-search-content">
            <div class="user-search-header">
                <h3>البحث عن مستخدمين</h3>
                <p>ابحث عن المستخدمين بالاسم أو البريد الإلكتروني أو المعرف</p>
            </div>
            
            <div class="user-search-body">
                <input type="text" id="globalUserSearch" class="user-search-input" placeholder="ابدأ بالكتابة للبحث...">
                
                <div class="search-results" id="globalSearchResults">
                    <div class="search-result-item">
                        <div class="user-avatar">م</div>
                        <div class="user-details">
                            <div class="user-name">محمد أحمد</div>
                            <div class="user-id">mohamed@example.com</div>
                        </div>
                    </div>
                    <div class="search-result-item">
                        <div class="user-avatar">س</div>
                        <div class="user-details">
                            <div class="user-name">سارة محمود</div>
                            <div class="user-id">sara@example.com</div>
                        </div>
                    </div>
                    <div class="search-result-item">
                        <div class="user-avatar">ع</div>
                        <div class="user-details">
                            <div class="user-name">علي حسن</div>
                            <div class="user-id">ali@example.com</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="user-search-footer">
                <button class="close-modal-btn" id="closeUserSearchModal">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تفاصيل المستخدم -->
    <div id="userDetailModal" class="user-detail-modal">
        <div class="user-detail-content">
            <div class="user-detail-header">
                <h3 id="userDetailName">معلومات المستخدم</h3>
            </div>
            
            <div class="user-detail-body">
                <div id="userDetailPhoto" class="user-avatar-large">?</div>
                
                <div class="user-detail-info">
                    <div class="user-detail-row">
                        <span class="user-detail-label">الاسم الكامل:</span>
                        <span id="userDetailFullName" class="user-detail-value">-</span>
                    </div>
                    <div class="user-detail-row">
                        <span class="user-detail-label">البريد الإلكتروني:</span>
                        <span id="userDetailEmail" class="user-detail-value">-</span>
                    </div>
                    <div class="user-detail-row">
                        <span class="user-detail-label">اسم المستخدم:</span>
                        <span id="userDetailUsername" class="user-detail-value">-</span>
                    </div>
                    <div class="user-detail-row">
                        <span class="user-detail-label">رقم الهاتف:</span>
                        <span id="userDetailPhone" class="user-detail-value">-</span>
                    </div>
                    <div class="user-detail-row">
                        <span class="user-detail-label">تاريخ التسجيل:</span>
                        <span id="userDetailCreatedAt" class="user-detail-value">-</span>
                    </div>
                    <div class="user-detail-row">
                        <span class="user-detail-label">معرّف المستخدم:</span>
                        <span id="userDetailId" class="user-detail-value">-</span>
                    </div>
                    <div class="user-detail-row">
                        <span class="user-detail-label">آخر ظهور:</span>
                        <span id="userDetailLastSeen" class="user-detail-value">-</span>
                    </div>
                </div>
            </div>
            
            <div class="user-detail-footer">
                <button id="startConversationBtn" class="user-detail-btn primary">
                    <i class="fas fa-comment"></i> بدء محادثة
                </button>
                <button id="closeUserDetailBtn" class="user-detail-btn secondary">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="confirmation-content">
            <h3 id="confirmMessage">هل أنت متأكد من هذا الإجراء؟</h3>
            <div id="messagePreview" class="message-preview" style="display: none;"></div>
            <div class="confirmation-buttons">
                <button id="confirmationModalConfirm">تأكيد</button>
                <button id="confirmationModalCancel">إلغاء</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAG4EKrB3iLEV2hsB8b08ShpSO6PXDnGjg",
            authDomain: "zio3-8ffdd.firebaseapp.com",
            databaseURL: "https://zio3-8ffdd-default-rtdb.firebaseio.com",
            projectId: "zio3-8ffdd",
            storageBucket: "zio3-8ffdd.firebasestorage.app",
            messagingSenderId: "560939348415",
            appId: "1:560939348415:web:c854e9e214e498ad2d310a",
            measurementId: "G-CVN2B2D0RD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global data store
        const adminData = {
            conversations: [],
            filteredConversations: [],
            selectedConversation: null,
            messages: [],
            tempMessages: {},
            users: [],
            userNamesCache: {}, // Cache for user full names
            searchOptions: {
                byName: true,
                byId: true,
                byMessages: true
            },
            deletionTimers: {},
            startTime: Date.now(),
            currentUserDetail: null
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            void notification.offsetWidth;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function formatTime(timestamp) {
            if (!timestamp) return '--:--';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(timestamp) {
            if (!timestamp) return '--/--/----';
            const date = new Date(timestamp);
            return date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '--/--/---- --:--';
            const date = new Date(timestamp);
            return `${formatDate(timestamp)} ${formatTime(timestamp)}`;
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function calculateTimeLeft(closedAt) {
            if (!closedAt) return 24;
            const closedTime = new Date(closedAt).getTime();
            const now = Date.now();
            const elapsed = now - closedTime;
            const totalHours = 24;
            const hoursLeft = totalHours - Math.floor(elapsed / (1000 * 60 * 60));
            
            return Math.max(0, hoursLeft);
        }
        
        // User Search Modal
        function setupUserSearchModal() {
            const searchUsersBtn = document.getElementById('searchUsersBtn');
            const userSearchModal = document.getElementById('userSearchModal');
            const closeModalBtn = document.getElementById('closeUserSearchModal');
            const globalUserSearch = document.getElementById('globalUserSearch');
            
            searchUsersBtn.addEventListener('click', () => {
                userSearchModal.style.display = 'flex';
                document.body.classList.add('modal-open');
            });
            
            closeModalBtn.addEventListener('click', () => {
                userSearchModal.style.display = 'none';
                document.body.classList.remove('modal-open');
            });
            
            userSearchModal.addEventListener('click', (e) => {
                if (e.target === userSearchModal) {
                    userSearchModal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                }
            });
            
            globalUserSearch.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const resultsContainer = document.getElementById('globalSearchResults');
                
                if (!term) {
                    resultsContainer.innerHTML = '<div class="no-results">اكتب للبدء في البحث</div>';
                    return;
                }
                
                const filteredUsers = adminData.users.filter(user => {
                    return (
                        (user.fullName && user.fullName.toLowerCase().includes(term)) ||
                        (user.email && user.email.toLowerCase().includes(term)) ||
                        (user.username && user.username.toLowerCase().includes(term)) ||
                        (user.uid && user.uid.toLowerCase().includes(term))
                    );
                });
                
                renderUserSearchResults(filteredUsers);
            });
        }
        
        function renderUserSearchResults(users) {
            const resultsContainer = document.getElementById('globalSearchResults');
            
            if (users.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results" style="padding: 20px; text-align: center;">لا توجد نتائج مطابقة</div>';
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            users.forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'search-result-item';
                userEl.dataset.userId = user.uid;
                
                userEl.innerHTML = `
                    <div class="user-avatar">${user.fullName ? user.fullName.charAt(0) : '?'}</div>
                    <div class="user-details">
                        <div class="user-name">${user.fullName || 'مستخدم'}</div>
                        <div class="user-id">${user.email || user.uid}</div>
                    </div>
                `;
                
                userEl.addEventListener('click', () => {
                    startConversationWithUser(user);
                    document.getElementById('userSearchModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                });
                
                resultsContainer.appendChild(userEl);
            });
        }
        
        async function startConversationWithUser(user) {
            const userId = user.uid;
            const userName = user.fullName || `مستخدم ${userId.substring(0, 6)}`;
            
            // Check if conversation already exists
            const existingConversation = adminData.conversations.find(c => c.userId === userId);
            
            if (existingConversation) {
                selectConversation(userId);
                return;
            }
            
            // Create new conversation in Firebase
            try {
                const conversationRef = database.ref('supportChats').child(userId);
                
                const conversationData = {
                    userId: userId,
                    userName: userName,
                    deviceName: "جهاز غير معروف",
                    createdAt: Date.now(),
                    isOnline: false,
                    isBlocked: false,
                    deleted: false,
                    closed: false
                };
                
                await conversationRef.set(conversationData);
                
                // Add to conversations list
                const newConversation = {
                    ...conversationData,
                    lastMessage: null,
                    unread: 0,
                    messages: []
                };
                
                adminData.conversations.unshift(newConversation);
                adminData.filteredConversations = [...adminData.conversations];
                renderConversations();
                
                // Select the new conversation
                selectConversation(userId);
                
                showNotification(`تم إنشاء محادثة جديدة مع ${userName}`, 'success');
            } catch (error) {
                console.error("Error creating conversation:", error);
                showNotification('حدث خطأ أثناء إنشاء المحادثة', 'error');
            }
        }
        
        // Load users from Firebase
        function loadUsers() {
            const usersRef = database.ref('users');
            
            usersRef.on('value', (snapshot) => {
                adminData.users = [];
                
                if (!snapshot.exists()) {
                    return;
                }
                
                snapshot.forEach((userSnapshot) => {
                    const userData = userSnapshot.val();
                    const fullName = (userData.firstName && userData.lastName) 
                        ? `${userData.firstName} ${userData.lastName}`
                        : userData.fullName || "مستخدم";
                    
                    adminData.users.push({
                        uid: userSnapshot.key,
                        fullName: fullName,
                        firstName: userData.firstName || "",
                        lastName: userData.lastName || "",
                        email: userData.email || "بريد غير معروف",
                        username: userData.username || "",
                        phone: userData.phone || "",
                        createdAt: userData.createdAt || Date.now(),
                        lastSeen: userData.lastSeen || null,
                        role: userData.role || "مستخدم",
                        isOnline: userData.isOnline || false
                    });
                    
                    // Cache user full name for conversations
                    adminData.userNamesCache[userSnapshot.key] = fullName;
                });
                
                // Update conversations with user names
                updateConversationsWithUserNames();
            }, (error) => {
                console.error("Error loading users:", error);
                showNotification('حدث خطأ أثناء تحميل قائمة المستخدمين', 'error');
            });
        }

        // Update conversations with user names from cache
        function updateConversationsWithUserNames() {
            adminData.conversations.forEach(conversation => {
                if (adminData.userNamesCache[conversation.userId]) {
                    conversation.userName = adminData.userNamesCache[conversation.userId];
                }
            });
            renderConversations();
            
            if (adminData.selectedConversation && adminData.userNamesCache[adminData.selectedConversation.userId]) {
                adminData.selectedConversation.userName = adminData.userNamesCache[adminData.selectedConversation.userId];
                selectConversation(adminData.selectedConversation.userId);
            }
        }
        
        // Show user detail
        function showUserDetail(user) {
            adminData.currentUserDetail = user;
            
            const modal = document.getElementById('userDetailModal');
            const photo = document.getElementById('userDetailPhoto');
            const name = document.getElementById('userDetailName');
            const fullName = document.getElementById('userDetailFullName');
            const email = document.getElementById('userDetailEmail');
            const username = document.getElementById('userDetailUsername');
            const phone = document.getElementById('userDetailPhone');
            const createdAt = document.getElementById('userDetailCreatedAt');
            const id = document.getElementById('userDetailId');
            const lastSeen = document.getElementById('userDetailLastSeen');
            
            // Set user details
            name.textContent = user.fullName;
            fullName.textContent = user.fullName;
            email.textContent = user.email;
            username.textContent = user.username ? `@${user.username}` : 'غير محدد';
            phone.textContent = user.phone || 'غير محدد';
            id.textContent = user.uid;
            
            // Set user avatar initial
            photo.textContent = user.fullName ? user.fullName.charAt(0) : '?';
            
            // Format registration date
            if (user.createdAt) {
                const date = new Date(user.createdAt);
                createdAt.textContent = date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } else {
                createdAt.textContent = 'غير معروف';
            }
            
            // Format last seen
            if (user.lastSeen) {
                lastSeen.textContent = formatDateTime(user.lastSeen);
            } else {
                lastSeen.textContent = "لم يسجل الدخول بعد";
            }
            
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
        }
        
        // Close user detail modal
        function closeUserDetailModal() {
            const modal = document.getElementById('userDetailModal');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
            adminData.currentUserDetail = null;
        }
        
        // Start conversation from user detail
        function startConversationFromDetail() {
            if (adminData.currentUserDetail) {
                startConversationWithUser(adminData.currentUserDetail);
                closeUserDetailModal();
            }
        }
        
        // Main Application Logic
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('conversationsSidebar');
            
            // Confirmation Modal Logic
            let confirmActionCallback = null;

            function showConfirmationModal(message, callback, previewContent = '') {
                const modal = document.getElementById('confirmationModal');
                const modalMessage = document.getElementById('confirmMessage');
                const previewElement = document.getElementById('messagePreview');
                
                modalMessage.innerHTML = message;
                
                if (previewContent) {
                    previewElement.innerHTML = previewContent;
                    previewElement.style.display = 'block';
                } else {
                    previewElement.style.display = 'none';
                }
                
                confirmActionCallback = callback;
                modal.style.display = 'flex';
                document.body.classList.add('modal-open');
            }

            function hideConfirmationModal() {
                const modal = document.getElementById('confirmationModal');
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                confirmActionCallback = null;
            }

            function handleConfirm() {
                if (confirmActionCallback) {
                    confirmActionCallback(true);
                }
                hideConfirmationModal();
            }

            function handleCancel() {
                if (confirmActionCallback) {
                    confirmActionCallback(false);
                }
                hideConfirmationModal();
            }

            document.getElementById('searchByName').addEventListener('change', function() {
                adminData.searchOptions.byName = this.checked;
                filterConversations(document.getElementById('searchInput').value);
            });
            
            document.getElementById('searchById').addEventListener('change', function() {
                adminData.searchOptions.byId = this.checked;
                filterConversations(document.getElementById('searchInput').value);
            });
            
            document.getElementById('searchByMessages').addEventListener('change', function() {
                adminData.searchOptions.byMessages = this.checked;
                filterConversations(document.getElementById('searchInput').value);
            });

            // Conversation List & Filtering
            function renderConversations() {
                const conversationsList = document.getElementById('conversationsList');
                conversationsList.innerHTML = '';
                
                if (adminData.filteredConversations.length === 0) {
                    conversationsList.innerHTML = `
                        <div class="no-conversations">
                            <i class="fas fa-comments"></i>
                            <p>لا توجد محادثات مطابقة للبحث</p>
                        </div>
                    `;
                    return;
                }
                
                adminData.filteredConversations.forEach(conversation => {
                    if (conversation.deleted) return;

                    const lastMessage = conversation.lastMessage || { text: 'بدون رسائل', timestamp: 0 };
                    const isActive = adminData.selectedConversation && adminData.selectedConversation.userId === conversation.userId;
                    const statusClass = conversation.isOnline ? 'online' : 'offline';
                    
                    let closedIndicator = '';
                    if (conversation.closed) {
                        const hoursLeft = conversation.closedTimeLeft;
                        closedIndicator = `<div class="countdown-timer">سيحذف بعد: ${hoursLeft} ساعة</div>`;
                    }
                    
                    const conversationEl = document.createElement('div');
                    conversationEl.className = `conversation-item ${isActive ? 'active' : ''}`;
                    conversationEl.setAttribute('data-user-id', conversation.userId);
                    conversationEl.innerHTML = `
                        <div class="conversation-header">
                            <div class="user-info">
                                <div class="user-avatar ${statusClass}">${conversation.userName ? conversation.userName.charAt(0) : '?'}</div>
                                <div>
                                    <div class="user-name">${conversation.userName || `مستخدم ${conversation.userId.substring(0, 6)}`}</div>
                                    <div class="last-message-time">${formatTime(lastMessage.timestamp)}</div>
                                </div>
                            </div>
                            <div class="message-count ${conversation.unread > 0 ? 'has-unread' : ''}">
                                ${conversation.unread > 0 ? conversation.unread : ''}
                            </div>
                        </div>
                        <div class="last-message">${truncateText(lastMessage.text, 30)}</div>
                        ${closedIndicator}
                        ${conversation.isBlocked ? '<div class="blocked-indicator"><i class="fas fa-ban"></i> محظور</div>' : ''}
                    `;
                    
                    conversationEl.addEventListener('click', () => {
                        selectConversation(conversation.userId);
                        if (window.innerWidth < 768) {
                            sidebar.classList.remove('active');
                        }
                    });
                    
                    conversationsList.appendChild(conversationEl);
                });
            }

            function filterConversations(searchTerm) {
                if (!searchTerm) {
                    adminData.filteredConversations = [...adminData.conversations];
                    renderConversations();
                    return;
                }
                
                const term = searchTerm.toLowerCase();
                adminData.filteredConversations = adminData.conversations.filter(conversation => {
                    if (conversation.deleted) return false;

                    let match = false;
                    
                    if (adminData.searchOptions.byName) {
                        const userName = conversation.userName ? conversation.userName.toLowerCase() : '';
                        if (userName.includes(term)) match = true;
                    }
                    
                    if (adminData.searchOptions.byId && !match) {
                        const userId = conversation.userId.toLowerCase();
                        if (userId.includes(term)) match = true;
                    }
                    
                    if (adminData.searchOptions.byMessages && !match) {
                        if (conversation.lastMessage && conversation.lastMessage.text) {
                            const messageText = conversation.lastMessage.text.toLowerCase();
                            if (messageText.includes(term)) match = true;
                        }
                        
                        if (conversation.messages && conversation.messages.length > 0) {
                            for (const message of conversation.messages) {
                                if (message.text && message.text.toLowerCase().includes(term)) {
                                    match = true;
                                    break;
                                }
                            }
                        }
                    }
                    
                    return match;
                });
                
                renderConversations();
            }

            async function selectConversation(userId) {
                const conversation = adminData.conversations.find(c => c.userId === userId);
                if (!conversation || conversation.deleted) {
                    adminData.selectedConversation = null;
                    renderEmptyMainContent();
                    return;
                }
                
                adminData.selectedConversation = conversation;
                
                document.querySelectorAll('.conversation-item').forEach(el => {
                    el.classList.remove('active');
                });
                
                const selectedEl = document.querySelector(`.conversation-item[data-user-id="${userId}"]`);
                if (selectedEl) {
                    selectedEl.classList.add('active');
                }
                
                document.getElementById('conversationUserName').textContent = conversation.userName || `مستخدم ${conversation.userId.substring(0, 6)}`;
                
                const statusText = conversation.isBlocked ? 'محظور' : (conversation.isOnline ? 'متصل الآن' : 'غير متصل');
                document.getElementById('conversationUserStatus').textContent = statusText;
                document.getElementById('conversationUserStatus').className = `status ${conversation.isBlocked ? 'blocked' : (conversation.isOnline ? 'online' : 'offline')}`;
                document.getElementById('conversationUserAvatar').textContent = conversation.userName ? conversation.userName.charAt(0) : '?';

                const blockButton = document.getElementById('blockUserButton');
                blockButton.innerHTML = conversation.isBlocked ? '<i class="fas fa-unlock"></i>' : '<i class="fas fa-ban"></i>';
                blockButton.title = conversation.isBlocked ? 'إلغاء حظر العميل' : 'حظر العميل';
                blockButton.onclick = () => toggleBlockUser(conversation.userId, conversation.isBlocked);
                blockButton.style.display = 'block';
                
                const closeButton = document.getElementById('closeConversationButton');
                closeButton.style.display = 'block';
                closeButton.onclick = () => closeConversation(conversation.userId);
                closeButton.title = 'إغلاق المحادثة';
                
                const cancelDeletionButton = document.getElementById('cancelDeletionButton');
                if (conversation.closed) {
                    cancelDeletionButton.style.display = 'block';
                    cancelDeletionButton.onclick = () => cancelScheduledDeletion(conversation.userId);
                    cancelDeletionButton.title = 'إلغاء الحذف بعد 24 ساعة';
                } else {
                    cancelDeletionButton.style.display = 'none';
                }
                
                const deleteButton = document.getElementById('deleteConversationButton');
                deleteButton.style.display = 'block';
                deleteButton.onclick = () => deleteConversation(conversation.userId);
                deleteButton.title = 'حذف المحادثة بشكل نهائي';

                await markMessagesAsRead(userId);
                conversation.unread = 0;
                renderConversations();
                
                loadMessages(userId);
                
                const adminMessageInput = document.getElementById('adminMessageInput');
                const adminSendButton = document.getElementById('adminSendButton');
                adminMessageInput.disabled = conversation.isBlocked;
                adminSendButton.disabled = conversation.isBlocked;
                adminMessageInput.placeholder = conversation.isBlocked ? 'لا يمكنك إرسال رسائل لعميل محظور.' : 'اكتب ردك هنا...';
                adminMessageInput.focus();
                
                updateDeletedMessagesCount();
            }

            function renderEmptyMainContent() {
                document.getElementById('conversationUserName').textContent = 'اختر محادثة';
                document.getElementById('conversationUserStatus').textContent = 'غير متصل';
                document.getElementById('conversationUserStatus').className = 'status offline';
                document.getElementById('conversationUserAvatar').textContent = '?';
                document.getElementById('messagesContainer').innerHTML = `
                    <div class="no-messages">
                        <i class="fas fa-comment-alt"></i>
                        <p>مرحباً بك في لوحة تحكم الدعم الفني</p>
                        <p>اختر محادثة من القائمة الجانبية للبدء</p>
                    </div>
                `;
                document.getElementById('adminMessageInput').disabled = true;
                document.getElementById('adminSendButton').disabled = true;
                document.getElementById('adminMessageInput').placeholder = 'اختر محادثة للبدء...';
                document.getElementById('blockUserButton').style.display = 'none';
                document.getElementById('closeConversationButton').style.display = 'none';
                document.getElementById('cancelDeletionButton').style.display = 'none';
                document.getElementById('deleteConversationButton').style.display = 'none';
                document.querySelectorAll('.conversation-item').forEach(el => {
                    el.classList.remove('active');
                });
                adminData.selectedConversation = null;
                
                document.getElementById('deletedMessagesContainer').style.display = 'none';
                document.getElementById('deletedCount').textContent = '0';
            }

            // Message Loading & Rendering
            function loadMessages(userId) {
                const messagesRef = database.ref(`supportChats/${userId}/messages`);
                
                messagesRef.on('value', (snapshot) => {
                    const newMessages = [];
                    
                    Object.values(adminData.tempMessages).forEach(tempMsg => {
                        if (tempMsg.userId === userId) {
                            newMessages.push(tempMsg);
                        }
                    });
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const message = childSnapshot.val();
                            
                            if (!adminData.tempMessages[childSnapshot.key]) {
                                newMessages.push({
                                    id: childSnapshot.key,
                                    text: message.text,
                                    senderId: message.senderId,
                                    senderType: message.senderType || 'user',
                                    timestamp: message.timestamp,
                                    deleted: message.deleted || false,
                                    deletedBy: message.deletedBy || null,
                                    deletedAt: message.deletedAt || null
                                });
                            }
                        });
                    }
                    
                    newMessages.sort((a, b) => a.timestamp - b.timestamp);
                    adminData.messages = newMessages;
                    renderMessages();
                    updateDeletedMessagesCount();
                });
            }

            function renderMessages() {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                if (adminData.messages.length === 0) {
                    container.innerHTML = `
                        <div class="no-messages">
                            <i class="fas fa-comment-alt"></i>
                            <p>لا توجد رسائل بعد</p>
                            <p>ابدأ المحادثة مع المستخدم الآن</p>
                        </div>
                    `;
                    return;
                }
                
                const groupedMessages = {};
                adminData.messages.forEach(msg => {
                    if (msg.deleted) return;
                    
                    const date = formatDate(msg.timestamp);
                    if (!groupedMessages[date]) {
                        groupedMessages[date] = [];
                    }
                    groupedMessages[date].push(msg);
                });
                
                for (const date in groupedMessages) {
                    container.innerHTML += `
                        <div class="date-divider">
                            <span>${date}</span>
                        </div>
                    `;
                    
                    groupedMessages[date].forEach(msg => {
                        const isAdmin = msg.senderType === 'admin';
                        const messageClass = isAdmin ? 'admin-message' : 'user-message';
                        
                        const additionalClasses = [];
                        if (msg.pending) additionalClasses.push('pending');
                        
                        container.innerHTML += `
                            <div class="message ${messageClass} ${additionalClasses.join(' ')}" 
                                 data-message-id="${msg.id}" 
                                 data-sender-type="${msg.senderType}">
                                <button class="delete-message-btn" title="حذف الرسالة">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <div class="message-content">
                                    ${msg.text}
                                </div>
                                <div class="message-time">
                                    ${formatTime(msg.timestamp)}
                                    ${msg.pending ? '<div class="pending-indicator">جاري الإرسال...</div>' : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.querySelectorAll('.delete-message-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const messageElement = event.currentTarget.closest('.message');
                        const messageId = messageElement.dataset.messageId;
                        const senderType = messageElement.dataset.senderType;
                        const messageText = messageElement.querySelector('.message-content').textContent.trim();
                        
                        deleteMessage(
                            adminData.selectedConversation.userId, 
                            messageId, 
                            senderType,
                            `<strong>محتوى الرسالة:</strong> ${truncateText(messageText, 100)}`
                        );
                    });
                });

                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }

            async function sendMessage() {
                const messageInput = document.getElementById('adminMessageInput');
                const sendBtn = document.getElementById('adminSendButton');
                const messageText = messageInput.value.trim();

                if (!messageText) {
                    showNotification('الرجاء كتابة رسالة.', 'warning');
                    return;
                }

                if (!adminData.selectedConversation) {
                    showNotification('الرجاء تحديد محادثة أولاً.', 'warning');
                    return;
                }
                
                if (adminData.selectedConversation.isBlocked) {
                    showNotification('لا يمكنك إرسال رسائل لعميل محظور.', 'error');
                    return;
                }

                const userId = adminData.selectedConversation.userId;
                const originalIcon = sendBtn.innerHTML;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                sendBtn.disabled = true;
                messageInput.disabled = true;

                const tempMessageId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;

                try {
                    const tempMessage = {
                        id: tempMessageId,
                        text: messageText,
                        senderType: 'admin',
                        timestamp: Date.now(),
                        pending: true,
                        userId: userId
                    };
                    
                    adminData.tempMessages[tempMessageId] = tempMessage;
                    adminData.messages.push(tempMessage);
                    renderMessages();
                    
                    const newMessage = {
                        text: messageText,
                        senderType: 'admin',
                        timestamp: Date.now(),
                        deleted: false
                    };
                    
                    const messagesRef = database.ref(`supportChats/${userId}/messages`);
                    const newMessageRef = messagesRef.push();
                    await newMessageRef.set(newMessage);
                    
                    const permanentMessageId = newMessageRef.key;
                    tempMessage.id = permanentMessageId;
                    tempMessage.pending = false;
                    
                    adminData.tempMessages[permanentMessageId] = tempMessage;
                    delete adminData.tempMessages[tempMessageId];
                    
                    const messageIndex = adminData.messages.findIndex(m => m.id === tempMessageId);
                    if (messageIndex !== -1) {
                        adminData.messages[messageIndex] = tempMessage;
                    }
                    
                    renderMessages();
                    
                    const conversationRef = database.ref(`supportChats/${userId}`);
                    await conversationRef.update({
                        lastMessage: {
                            text: messageText,
                            timestamp: Date.now()
                        }
                    });

                    messageInput.value = '';
                    
                    showNotification('تم إرسال الرد بنجاح!', 'success');
                    
                } catch (error) {
                    console.error("Error sending message:", error);
                    
                    const index = adminData.messages.findIndex(m => m.id === tempMessageId);
                    if (index !== -1) {
                        adminData.messages.splice(index, 1);
                        renderMessages();
                    }
                    
                    delete adminData.tempMessages[tempMessageId];
                    
                    showNotification('حدث خطأ أثناء إرسال الرد. يرجى المحاولة مرة أخرى.', 'error');
                } finally {
                    sendBtn.innerHTML = originalIcon;
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }

            // Firebase Data Loading & Management
            function loadConversations() {
                const conversationsRef = database.ref('supportChats');
                
                conversationsRef.on('value', (snapshot) => {
                    adminData.conversations = []; 
                    if (!snapshot.exists()) {
                        adminData.filteredConversations = [];
                        renderConversations();
                        renderEmptyMainContent();
                        return;
                    }
                    
                    snapshot.forEach((userSnapshot) => {
                        const userId = userSnapshot.key;
                        const userData = userSnapshot.val();
                        
                        let lastMessage = null;
                        let unread = 0;
                        
                        if (userData.messages) {
                            const messages = Object.values(userData.messages);
                            if (messages.length > 0) {
                                lastMessage = messages.reduce((latest, current) => 
                                    current.timestamp > (latest?.timestamp || 0) ? current : latest, null);
                                
                                unread = messages.filter(msg => 
                                    msg.senderType === 'user' && !msg.readByAdmin).length;
                            }
                        }
                        
                        const isOnline = Math.random() > 0.3;
                        
                        const closed = userData.closed || false;
                        const closedAt = userData.closedAt || null;
                        const closedTimeLeft = closed ? calculateTimeLeft(closedAt) : null;
                        
                        let conversationMessages = [];
                        if (userData.messages) {
                            conversationMessages = Object.values(userData.messages)
                                .sort((a, b) => b.timestamp - a.timestamp)
                                .slice(0, 10);
                        }
                        
                        // Use cached user name if available
                        const userName = adminData.userNamesCache[userId] || userData.userName || `مستخدم ${userId.substring(0, 6)}`;
                        
                        adminData.conversations.push({
                            userId: userId,
                            userName: userName,
                            deviceName: userData.deviceName || "جهاز غير معروف",
                            lastMessage: lastMessage,
                            unread: unread,
                            createdAt: userData.createdAt || Date.now(),
                            isOnline: isOnline,
                            isBlocked: userData.isBlocked || false,
                            deleted: userData.deleted || false,
                            closed: closed,
                            closedAt: closedAt,
                            closedTimeLeft: closedTimeLeft,
                            messages: conversationMessages
                        });
                    });
                    
                    adminData.conversations = adminData.conversations.filter(c => !c.deleted);

                    adminData.conversations.sort((a, b) => {
                        const aTime = a.lastMessage?.timestamp || a.createdAt;
                        const bTime = b.lastMessage?.timestamp || b.createdAt; 
                        return bTime - aTime;
                    });
                    
                    adminData.filteredConversations = [...adminData.conversations];
                    renderConversations(); 

                    if (adminData.selectedConversation && adminData.selectedConversation.deleted) {
                        renderEmptyMainContent();
                    } else if (!adminData.selectedConversation && adminData.conversations.length === 0) {
                        renderEmptyMainContent();
                    } else if (adminData.selectedConversation) {
                        selectConversation(adminData.selectedConversation.userId);
                    } else {
                        renderEmptyMainContent();
                    }
                });
            }

            // New Functionalities
            async function markMessagesAsRead(userId) {
                try {
                    const messagesRef = database.ref(`supportChats/${userId}/messages`);
                    const snapshot = await messagesRef.once('value');
                    if (snapshot.exists()) {
                        const updates = {};
                        snapshot.forEach((child) => {
                            const message = child.val();
                            if (message.senderType === 'user' && !message.readByAdmin) {
                                updates[`${child.key}/readByAdmin`] = true;
                            }
                        });
                        if (Object.keys(updates).length > 0) {
                            await messagesRef.update(updates);
                        }
                    }
                } catch (error) {
                    console.error("Error marking messages as read:", error);
                }
            }

            async function deleteMessage(userId, messageId, senderType, previewContent = '') {
                showConfirmationModal(`
                    <div>هل أنت متأكد أنك تريد حذف هذه الرسالة؟</div>
                    ${previewContent ? `<div class="message-preview">${previewContent}</div>` : ''}
                    <div><small>ملاحظة: سيتم حذف الرسالة نهائياً ولن يتمكن أي طرف من رؤيتها.</small></div>
                `, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const messageIndex = adminData.messages.findIndex(m => m.id === messageId);
                            if (messageIndex !== -1) {
                                adminData.messages[messageIndex].deleted = true;
                                adminData.messages[messageIndex].deletedBy = 'admin';
                                adminData.messages[messageIndex].deletedAt = Date.now();
                                renderMessages();
                                updateDeletedMessagesCount();
                            }
                            
                            const messageRef = database.ref(`supportChats/${userId}/messages/${messageId}`);
                            await messageRef.update({ 
                                deleted: true,
                                deletedAt: Date.now(),
                                deletedBy: 'admin'
                            });
                            
                            if (senderType === 'user') {
                                const notificationRef = database.ref(`userNotifications/${userId}/messageDeleted/${messageId}`);
                                await notificationRef.set({
                                    timestamp: Date.now(),
                                    message: 'تم حذف إحدى رسائلك من قبل المسؤول'
                                });
                            }
                            
                            showNotification('تم حذف الرسالة بنجاح.', 'success');
                        } catch (error) {
                            console.error("Error deleting message:", error);
                            showNotification('حدث خطأ أثناء حذف الرسالة.', 'error');
                        }
                    }
                });
            }

            async function deleteConversation(userId) {
                showConfirmationModal(`هل أنت متأكد أنك تريد حذف هذه المحادثة بشكل نهائي؟ هذا الإجراء لا يمكن التراجع عنه.`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const messagesRef = database.ref(`supportChats/${userId}/messages`);
                            await messagesRef.remove();
                            
                            const conversationRef = database.ref(`supportChats/${userId}`);
                            await conversationRef.remove();
                            
                            const deleteNotificationRef = database.ref(`userNotifications/${userId}/conversationDeleted`);
                            await deleteNotificationRef.set({ timestamp: Date.now() });
                            
                            showNotification('تم حذف المحادثة بنجاح بشكل نهائي.', 'success');
                            
                            if (adminData.selectedConversation && adminData.selectedConversation.userId === userId) {
                                renderEmptyMainContent();
                            }
                        } catch (error) {
                            console.error("Error deleting conversation:", error);
                            showNotification('حدث خطأ أثناء حذف المحادثة. يرجى المحاولة مرة أخرى.', 'error');
                        }
                    }
                });
            }
            
            async function closeConversation(userId) {
                showConfirmationModal(`هل أنت متأكد أنك تريد إغلاق هذه المحادثة؟ سيتم حذفها تلقائياً بعد 24 ساعة.`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const conversationRef = database.ref(`supportChats/${userId}`);
                            await conversationRef.update({ 
                                closed: true,
                                closedAt: Date.now()
                            });
                            showNotification('تم إغلاق المحادثة بنجاح. سيتم حذفها بعد 24 ساعة.', 'success');
                            
                            const notificationMessage = {
                                text: "تم إغلاق هذه المحادثة من قبل فريق الدعم. إذا كان لديك أي استفسارات أخرى، يرجى بدء محادثة جديدة.",
                                senderType: 'admin',
                                timestamp: Date.now(),
                                isNotification: true
                            };
                            
                            const messagesRef = database.ref(`supportChats/${userId}/messages`);
                            await messagesRef.push(notificationMessage);
                            
                            const timerId = setTimeout(async () => {
                                try {
                                    await conversationRef.remove();
                                    showNotification('تم حذف المحادثة تلقائياً بعد انتهاء 24 ساعة.', 'info');
                                    if (adminData.selectedConversation && adminData.selectedConversation.userId === userId) {
                                        renderEmptyMainContent();
                                    }
                                } catch (error) {
                                    console.error("Error deleting closed conversation:", error);
                                }
                            }, 24 * 60 * 60 * 1000);
                            
                            adminData.deletionTimers[userId] = timerId;
                            
                            loadConversations();
                        } catch (error) {
                            console.error("Error closing conversation:", error);
                            showNotification('حدث خطأ أثناء إغلاق المحادثة. يرجى المحاولة مرة أخرى.', 'error');
                        }
                    }
                });
            }
            
            async function cancelScheduledDeletion(userId) {
                showConfirmationModal(`هل أنت متأكد أنك تريد إلغاء الحذف المقرر لهذه المحادثة بعد 24 ساعة؟`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const conversationRef = database.ref(`supportChats/${userId}`);
                            await conversationRef.update({
                                closed: false,
                                closedAt: null
                            });
                            
                            if (adminData.deletionTimers[userId]) {
                                clearTimeout(adminData.deletionTimers[userId]);
                                delete adminData.deletionTimers[userId];
                            }
                            
                            showNotification('تم إلغاء الحذف المقرر بنجاح.', 'success');
                            
                            loadConversations();
                        } catch (error) {
                            console.error("Error canceling deletion:", error);
                            showNotification('حدث خطأ أثناء إلغاء الحذف المقرر.', 'error');
                        }
                    }
                });
            }

            async function toggleBlockUser(userId, isCurrentlyBlocked) {
                const action = isCurrentlyBlocked ? 'إلغاء حظر' : 'حظر';
                showConfirmationModal(`هل أنت متأكد أنك تريد ${action} هذا العميل؟`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const conversationRef = database.ref(`supportChats/${userId}`);
                            
                            // تحديث حالة الحظر في قاعدة البيانات
                            await conversationRef.update({ 
                                isBlocked: !isCurrentlyBlocked 
                            });
                            
                            // تحديث الحالة في البيانات المحلية
                            const conversation = adminData.conversations.find(c => c.userId === userId);
                            if (conversation) {
                                conversation.isBlocked = !isCurrentlyBlocked;
                            }
                            
                            // إذا كانت المحادثة المختارة هي نفسها، قم بتحديث الواجهة
                            if (adminData.selectedConversation && adminData.selectedConversation.userId === userId) {
                                adminData.selectedConversation.isBlocked = !isCurrentlyBlocked;
                                selectConversation(userId);
                            }
                            
                            showNotification(`تم ${action} العميل بنجاح.`, 'success');
                            
                            // إرسال رسالة إعلامية للمستخدم
                            const notificationMessage = {
                                text: isCurrentlyBlocked ? 
                                    "تم إلغاء حظرك من قبل فريق الدعم. يمكنك الآن التواصل معنا مرة أخرى." :
                                    "تم حظرك من قبل فريق الدعم. لم يعد بإمكانك التواصل معنا.",
                                senderType: 'admin',
                                timestamp: Date.now(),
                                isNotification: true
                            };
                            
                            const messagesRef = database.ref(`supportChats/${userId}/messages`);
                            await messagesRef.push(notificationMessage);
                            
                            // إعادة تحميل المحادثات لتحديث القائمة
                            loadConversations();
                        } catch (error) {
                            console.error("Error toggling block status:", error);
                            showNotification(`حدث خطأ أثناء ${action} العميل. يرجى المحاولة مرة أخرى.`, 'error');
                        }
                    }
                });
            }
            
            function updateDeletedMessagesCount() {
                if (!adminData.selectedConversation) {
                    document.getElementById('deletedCount').textContent = '0';
                    return;
                }
                
                const deletedMessages = adminData.messages.filter(m => m.deleted);
                document.getElementById('deletedCount').textContent = deletedMessages.length;
            }
            
            async function loadDeletedMessages() {
                if (!adminData.selectedConversation) return;
                
                const userId = adminData.selectedConversation.userId;
                const messagesRef = database.ref(`supportChats/${userId}/messages`);
                const snapshot = await messagesRef.once('value');
                const deletedMessages = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const message = child.val();
                        if (message.deleted) {
                            deletedMessages.push({
                                id: child.key,
                                ...message
                            });
                        }
                    });
                }
                
                const container = document.getElementById('deletedMessagesContainer');
                container.innerHTML = '';
                
                if (deletedMessages.length === 0) {
                    container.innerHTML = '<p class="text-center" style="padding:20px;color:#777;">لا توجد رسائل محذوفة</p>';
                    return;
                }
                
                deletedMessages.sort((a, b) => b.timestamp - a.timestamp).forEach(msg => {
                    const isAdmin = msg.senderType === 'admin';
                    const messageClass = isAdmin ? 'admin-message' : 'user-message';
                    const deletedBy = msg.deletedBy === 'admin' ? 'المسؤول' : 'المستخدم';
                    const deletedAt = msg.deletedAt ? formatDateTime(msg.deletedAt) : 'غير معروف';
                    
                    container.innerHTML += `
                        <div class="message ${messageClass}">
                            <div class="message-content">
                                <i class="fas fa-trash-alt"></i> تم حذف الرسالة
                                <div class="message-text">${msg.text || ''}</div>
                                <div class="deleted-info">
                                    تم الحذف بواسطة: <strong>${deletedBy}</strong><br>
                                    في: ${deletedAt}
                                </div>
                            </div>
                            <div class="message-time">
                                ${formatTime(msg.timestamp)}
                            </div>
                        </div>
                    `;
                });
            }
            
            async function clearDeletedMessagesLog() {
                if (!adminData.selectedConversation) {
                    showNotification('الرجاء تحديد محادثة أولاً.', 'warning');
                    return;
                }
                
                showConfirmationModal('هل أنت متأكد أنك تريد مسح سجل الرسائل المحذوفة بشكل نهائي؟ هذا الإجراء لا يمكن التراجع عنه.', async (confirmed) => {
                    if (confirmed) {
                        try {
                            const userId = adminData.selectedConversation.userId;
                            const messagesRef = database.ref(`supportChats/${userId}/messages`);
                            const snapshot = await messagesRef.once('value');
                            
                            if (snapshot.exists()) {
                                const updates = {};
                                snapshot.forEach(child => {
                                    const message = child.val();
                                    if (message.deleted) {
                                        updates[child.key] = null;
                                    }
                                });
                                
                                if (Object.keys(updates).length > 0) {
                                    await messagesRef.update(updates);
                                    showNotification('تم مسح سجل الرسائل المحذوفة بنجاح.', 'success');
                                    
                                    adminData.messages = adminData.messages.filter(m => !m.deleted);
                                    updateDeletedMessagesCount();
                                    
                                    loadDeletedMessages();
                                } else {
                                    showNotification('لا توجد رسائل محذوفة في السجل.', 'info');
                                }
                            }
                        } catch (error) {
                            console.error("Error clearing deleted messages log:", error);
                            showNotification('حدث خطأ أثناء مسح السجل.', 'error');
                        }
                    }
                });
            }

            // Initialization
            loadUsers();
            loadConversations();
            renderEmptyMainContent();
            setupUserSearchModal();

            document.getElementById('adminSendButton').addEventListener('click', () => sendMessage());
            
            document.getElementById('adminMessageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    sendMessage();
                }
            });
            
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filterConversations(e.target.value);
            });
            
            document.getElementById('toggleDeletedMessages').addEventListener('click', () => {
                const container = document.getElementById('deletedMessagesContainer');
                if (container.style.display === 'none') {
                    loadDeletedMessages();
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            });
            
            document.getElementById('clearDeletedMessages').addEventListener('click', clearDeletedMessagesLog);
            
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                const connectionStatusEl = document.querySelector('.connection-status');
                if (snap.val() === true) {
                    connectionStatusEl.innerHTML = '<i class="fas fa-circle" style="color: #2ECC71; margin-left: 5px;"></i> متصل بقاعدة البيانات';
                } else {
                    connectionStatusEl.innerHTML = '<i class="fas fa-circle" style="color: #E74C3C; margin-left: 5px;"></i> غير متصل بقاعدة البيانات';
                }
            });
            
            document.getElementById('confirmationModalCancel').addEventListener('click', handleCancel);
            document.getElementById('confirmationModalConfirm').addEventListener('click', handleConfirm);
            
            document.getElementById('confirmationModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('confirmationModal')) {
                    hideConfirmationModal();
                }
            });
            
            const adminInput = document.getElementById('adminMessageInput');
            
            function autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            }
            
            adminInput.addEventListener('input', () => autoResize(adminInput));
            
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });
            
            // Setup user detail modal
            document.getElementById('closeUserDetailBtn').addEventListener('click', closeUserDetailModal);
            document.getElementById('startConversationBtn').addEventListener('click', startConversationFromDetail);
            document.getElementById('userDetailModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('userDetailModal')) {
                    closeUserDetailModal();
                }
            });
        });
    </script>
</body>
</html>
